<!-- MHonArc v2.6.10 -->
<!--X-Subject: R: [sundials&#45;users] mass balance and negative values -->
<!--X-From-R13: Bnbyb Uerccv <cnbyb.terccvNqvnz.havtr.vg> -->
<!--X-Date: Wed, 08 Mar 2006 00:57:58 &#45;0800 (PST) -->
<!--X-Message-Id: 003b01c6428e$001911b0$87b4a401@VAHKIKEERAK -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 200603060222.VAA19895@webmail3.cac.psu.edu -->
<!--X-Head-End-->
<html>
<head>
<title>R: [sundials-users] mass balance and negative values</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00355.html">Date Prev</a>] [<a href="msg00357.html">Date Next</a>] [<a href="msg00346.html">Thread Prev</a>] [<a href="msg00357.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00356">Date Index</a></b>]
[<b><a href="threads.html#00356">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>R: [sundials-users] mass balance and negative values</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Paolo Greppi &lt;<a href="mailto:paolo.greppi%40diam.unige.it">paolo.greppi@diam.unige.it</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Wed, 08 Mar 2006 09:55:07 +0100</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Li,

I suggest you check your equations first. If the fluxes deplete the water
inventory in some grid points, and that does not happen in the real world,
maybe your model is incomplete.
After that, I suggest you read my post of Wed 08/02/2006 and next try the
following:

- do not define a local and a global yi
- introduce new variables xi in each grid point, related to the yi by the
equation: yi = exp(xi)
- rewrite the differential equations in term of the xi
- expose the xi as unknowns to the solver

This way, the yi will never get negative. If your equations are incomplete,
there will be no solution and the solver will fail.

Regards,

        Paolo


Paolo Greppi - Research Associate
Email paolo.greppi@diam.unige.it
UNIVERSITA DEGLI STUDI DI GENOVA
Dipartimento d'Ingegneria Ambientale
Web <a  href="http://www.diam.unige.it/pert/">http://www.diam.unige.it/pert/</a>
Via all'Opera Pia, 15/a
16145 Genova (GE)
Italia

-----Messaggio originale-----
Da: owner-sundials-users@lists.llnl.gov
[<a  href="mailto:owner-sundials-users@lists.llnl.gov">mailto:owner-sundials-users@lists.llnl.gov</a>] Per conto di SHUANGCAI LI
Inviato: 06 March 2006 03:22
A: sundials-users@llnl.gov
Oggetto: [sundials-users] mass balance and negative values

Hello All

        I am solving a sytem of stiff ODEs y'=f(y,t) where y values denote
water depth in each grid. I used CVODE in CV_NORMAL mode with GMRES-BDF
solver. Many y values obtained are found to be -ve. As suggested in this
forum, I tried reinitialization of variables. However, since y values
already obtained are -ve before they are reinitialized for the next time
step, causes mass balance error. Infact this error become very large with
time. When I account for this error on all the grids in final algebra for
mass balance, error becomes small but still some error existed. The rest of
the error comes from the -ve y values generated in the internal time steps.
So from CV_NORMAL I had to switch to CV_ONE_STEP. So now I know where the
mass balance error is coming from. Now the question is to correct it.
  
       Assuming two neighboring grids, with local y values as y1 and y2
respectively which are such that y_i=max(0,global_y)
  
                 Flux(y1,y2) = k*(y1+y2)^5/3 * (Abs(y1-y2))

Now, when global y1 &lt; 0, even with some flux contribution to y1 from y2,
global
y1 can still remain -ve. depending on magnitude of Flux(y1,y2) from grid 2.
So the flux which came out of grid 2 is wasted in adding water to grid 1 (as
global y1 is still -ve). Instead it should have been used in increasing
global
y1 from 0 to +ve value.So that much amount of water flux is lost. Also
errors creep in just by doing reinitialization of -ve y's to 0 at each time
step. This contributes to errors and the subsequent solutions get messed up
big time (for certain parameter settings).

In order to correct this problem, I have two options

a) To reinitialize y after every time step (CV_ONE_STEP) for the grid with
-ve y and then modify the y values in the neighboring cells as well.
However, due to logistical problems this is very hard to do.

b) To write the equations such that I don't get -ve y in the first place. So
here while running my CVode in CV_ONE_STEP mode I wrote the following code

         main()
        {
            while(t&lt;TMAX)
             {
                T=t;
                CVode(........,&amp;t,CV_ONE_STEP);
            }
        }

         f()
        {
            /****** This region (below) have been added now *******/
            If(y1&gt; Flux(y1,...)*(t-T) )
             /* Note: +ve Flux is going out from y1 to neighbors */
            {
                Flux(y1,...)=Flux(y1,y2);
              }
            else
            {
                Flux(y1,...)=y1/(t-T);
             }
             /****** This region (above) have been added now *******/
             ydot=Flux(y1,y2)
        }

What this was supposed to do is to restrict outward flux depending on the
availibity of water depth in that grid (similar to discussion in the group).
So total water flow in a particular time step can't be greater than what is
available on that grid. However I still got -ve y values.

While debugging, I found that for several time steps though y(t-1) is -ve
and ydot = +ve, solution obtained for the next time step becomes such that
y(t) &lt; y(t-1). 

--&gt; How can this be possible. Because of this perhaps, I still get -ve y
values.

    Now, in one earlier discussions on -ve y values, Alan had suggested
using root finding. However even in that case y obtained is already -ve.
More so, can we get a snippet for how to use root finding when y gets -ve.
Meanwhile, I would also like to know your opinion over if the above
modifications in f() is ok or not and the error discussed above. 

Regards,

Shuangcai


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00346" href="msg00346.html">[sundials-users] mass balance and negative values</a></strong>
<ul><li><em>From:</em> SHUANGCAI LI &lt;sul19@psu.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00355.html">Re: [sundials-users] Sundials compilation error (problem with xlc/xlf?)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00357.html">Re: [sundials-users] mass balance and negative values</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00346.html">[sundials-users] mass balance and negative values</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00357.html">Re: [sundials-users] mass balance and negative values</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00356">
<strong>Main</strong></a></li>
<li><a href="threads.html#00356">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
