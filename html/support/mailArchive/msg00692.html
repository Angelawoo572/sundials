<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] CVodeB and intermediate output -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Mon, 18 Sep 2006 10:16:08 &#45;0700 -->
<!--X-Message-Id: 450ED3BB.5040004@llnl.gov -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 17672.28318.156086.461500@segfault.lan -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] CVodeB and intermediate output</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00691.html">Date Prev</a>] [<a href="msg00693.html">Date Next</a>] [<a href="msg00672.html">Thread Prev</a>] [<a href="msg00707.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00692">Date Index</a></b>]
[<b><a href="threads.html#00692">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] CVodeB and intermediate output</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Mon, 18 Sep 2006 10:13:31 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi John,</pre><br>
<pre style="margin: 0em;">You managed to find a couple more bugs! Indeed, the behavior you observed is
actually due to two bugs:</pre><br>
<pre style="margin: 0em;">First, in both CVODE and CVODES, in the function CVode, after taking a
successful step, we perform several stopping tests. The order in which these
tests are implemented in the release version is as follows:
  1) check for root in last step (if yes, return at root)
  2) check if close to tstop (if yes, return at tstop)
  3) check if in ONE_STEP mode (if yes, return at current time)
  4) check if tout was passed (if yes, return at tout)
The correct order should be: 1-4-2-3.</pre><br>
<pre style="margin: 0em;">The blocks corresponding to these 4 tests are at the very end of the function
CVode and they are each identified by a preceding comment line:
- For CVODE, in the file cvode.c (revision 1.66) these 4 blocks start at line 
1305.
- For CVODES, in the file cvodes.c (revision 1.81) these 4 blocks start at line
2094.
To fix this bug, simply rearrange the blocks in the correct order.</pre><br>
<pre style="margin: 0em;">Secondly, in the adjoint module for CVODES (function CVodeB, file cvodea.c), the
current implementation attempts to move to the next checkpoint earlier than it
should (the segfault you are getting is due to the fact that there is no other
checkpoint to move to). To fix this bug, in the test for the while loop at line
790 of cvodea.c (revision 1.68), replace &lt;= (less than or equal) with &lt; (less 
than).</pre><br>
<pre style="margin: 0em;">--Radu</pre><br>
P.S. I have attached two diff files (patch.cvode and patch.cvodes) which can be 
used with the 'patch'  program to apply the patches. Note that the patch for 
CVODES also includes the bug fix for the CVodeF function (from a previous 
message from John).<br>
<br>
<br>John W. Eaton wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">I'm using sundials 2.2.0 on a Debian amd64 system.  I installed the
sundials libraries using the Debian package manager.</pre><br>
<pre style="margin: 0em;">If I compile the attached code with</pre><br>
<pre style="margin: 0em;">  gcc -I/usr/include/cvodes -I/usr/include/sundials -o foo foo.c 
-lsundials_cvodes -lsundials_nvecserial</pre><br>
<pre style="margin: 0em;">and then run the resulting program I see the following output:</pre><br>
<pre style="margin: 0em;">  $ ./foo
  forward integration:
  tout = 5.0, flag = 0, x = 0.993261
  backard integration:
  tout = 0.0, flag = 1, xb = -0.993255</pre><br>
<pre style="margin: 0em;">If I add -DINTERMEDIATE_OUTPUT to the compiler flags so that
the program loops over multiple calls to CVodeB to get intermediate
output, I see the following output and segfault:</pre><br>
<pre style="margin: 0em;">  forward integration:
  tout = 5.0, flag = 0, x = 0.993261
  backard integration:
  tout = 4.9, flag = 0, xb = -0.0951667
  tout = 4.8, flag = 0, xb = -0.181273
  tout = 4.7, flag = 0, xb = -0.259183
  tout = 4.6, flag = 0, xb = -0.329678
  tout = 4.5, flag = 0, xb = -0.393468
  tout = 4.4, flag = 0, xb = -0.451187
  tout = 4.3, flag = 0, xb = -0.503414
  tout = 4.2, flag = 0, xb = -0.550671
  tout = 4.1, flag = 0, xb = -0.593431
  tout = 4.0, flag = 0, xb = -0.632124
  tout = 3.9, flag = 0, xb = -0.667134
  tout = 3.8, flag = 0, xb = -0.698812
  tout = 3.7, flag = 0, xb = -0.727473
  tout = 3.6, flag = 0, xb = -0.753407
  tout = 3.5, flag = 0, xb = -0.776872
  tout = 3.4, flag = 0, xb = -0.798106
  tout = 3.3, flag = 0, xb = -0.817319
  tout = 3.2, flag = 0, xb = -0.834704
  tout = 3.1, flag = 0, xb = -0.850434
  tout = 3.0, flag = 0, xb = -0.864666
  tout = 2.9, flag = 0, xb = -0.877545
  tout = 2.8, flag = 0, xb = -0.889198
  tout = 2.7, flag = 0, xb = -0.899742
  tout = 2.6, flag = 0, xb = -0.909283
  tout = 2.5, flag = 0, xb = -0.917916
  tout = 2.4, flag = 0, xb = -0.925726
  tout = 2.3, flag = 0, xb = -0.932793
  tout = 2.2, flag = 0, xb = -0.939187
  tout = 2.1, flag = 0, xb = -0.944972
  tout = 2.0, flag = 0, xb = -0.950208
  tout = 1.9, flag = 0, xb = -0.954947
  tout = 1.8, flag = 0, xb = -0.959235
  tout = 1.7, flag = 0, xb = -0.963115
  tout = 1.6, flag = 0, xb = -0.966625
  tout = 1.5, flag = 0, xb = -0.9698
  tout = 1.4, flag = 0, xb = -0.972674
  tout = 1.3, flag = 0, xb = -0.975274
  tout = 1.2, flag = 0, xb = -0.977627
  tout = 1.1, flag = 0, xb = -0.979756
  tout = 1.0, flag = 0, xb = -0.981683
  tout = 0.9, flag = 0, xb = -0.983426
  tout = 0.8, flag = 0, xb = -0.985003
  tout = 0.7, flag = 0, xb = -0.98643
  tout = 0.6, flag = 0, xb = -0.987721
  tout = 0.5, flag = 0, xb = -0.988889
  tout = 0.4, flag = 0, xb = -0.989944
  tout = 0.3, flag = 0, xb = -0.9909
  Segmentation fault</pre><br>
<pre style="margin: 0em;">Should I expect to be able to get intermediate output with CVodeB, or
am I again misunderstanding how things are supposed to work?  If it is
my error, then what is the appropriate way to get intermediate output
from the backward integration?</pre><br>
<pre style="margin: 0em;">Thanks,</pre><br>
<pre style="margin: 0em;">jwe</pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<br>
<pre>*** ../cvode.c  2006-03-21 11:14:22.000000000 -0800
--- cvode.c     2006-09-18 09:58:30.000000000 -0700
***************
*** 1319,1328 ****
--- 1319,1339 ----
          break;
        }
  
      }
  
+     /* Check if tout reached, and if so interpolate and exit loop */
+ 
+     if ((tn-tout)*h &gt;= ZERO) {
+       istate = CV_SUCCESS;
+       tretlast = *tret = tout;
+       (void) CVodeGetDky(cv_mem, tout, 0, yout);
+       next_q = qprime;
+       next_h = hprime;
+       break;
+     }
+ 
      /* Check if tn is at tstop or near tstop */
  
      if ( istop ) {
  
        troundoff = FUZZ_FACTOR*uround*(ABS(tn) + ABS(h));
***************
*** 1349,1369 ****
        next_q = qprime;
        next_h = hprime;
        break;
      }
  
-     /* Check if tout reached, and if so interpolate and exit loop */
- 
-     if ((tn-tout)*h &gt;= ZERO) {
-       istate = CV_SUCCESS;
-       tretlast = *tret = tout;
-       (void) CVodeGetDky(cv_mem, tout, 0, yout);
-       next_q = qprime;
-       next_h = hprime;
-       break;
-     }
- 
    } /* end looping for internal steps */
  
    return(istate);
  }
  
--- 1360,1369 ----
</pre><pre>*** ../cvodes.c 2006-03-15 07:33:49.000000000 -0800
--- cvodes.c    2006-09-18 10:02:27.000000000 -0700
***************
*** 2108,2117 ****
--- 2108,2128 ----
          break;
        }
  
      }
  
+     /* Check if tout reached, and if so interpolate and exit loop */
+ 
+     if ((tn-tout)*h &gt;= ZERO) {
+       istate = CV_SUCCESS;
+       tretlast = *tret = tout;
+       (void) CVodeGetDky(cv_mem, tout, 0, yout);
+       next_q = qprime;
+       next_h = hprime;
+       break;
+     }
+ 
      /* Check if tn is at tstop or near tstop */
  
      if ( istop ) {
  
        troundoff = FUZZ_FACTOR*uround*(ABS(tn) + ABS(h));
***************
*** 2138,2158 ****
        next_q = qprime;
        next_h = hprime;
        break;
      }
  
-     /* Check if tout reached, and if so interpolate and exit loop */
- 
-     if ((tn-tout)*h &gt;= ZERO) {
-       istate = CV_SUCCESS;
-       tretlast = *tret = tout;
-       (void) CVodeGetDky(cv_mem, tout, 0, yout);
-       next_q = qprime;
-       next_h = hprime;
-       break;
-     }
- 
    } /* end looping for internal steps */
    
    /* Load optional output */
  
    if (sensi &amp;&amp; (ism==CV_STAGGERED1)) { 
--- 2149,2158 ----
*** ../cvodea.c 2006-03-15 07:33:49.000000000 -0800
--- cvodea.c    2006-09-18 10:04:59.000000000 -0700
***************
*** 504,518 ****
      iret = TRUE;
      cv_itask = CV_ONE_STEP_TSTOP;
      break;
    }
  
!   /* On the first step, load dt_mem[0] */
    if ( nst == 0) {
      dt_mem[0]-&gt;t = ca_mem-&gt;ck_mem-&gt;ck_t0;
      storePnt(cv_mem, dt_mem[0]);
!   }
  
    /* Integrate to tout (in CV_ONE_STEP mode) while loading check points */
  
    loop {
  
--- 504,533 ----
      iret = TRUE;
      cv_itask = CV_ONE_STEP_TSTOP;
      break;
    }
  
!   /* On the first step, load dt_mem[0].
!      On subsequent steps, test if taking a new step is necessary. */
    if ( nst == 0) {
+ 
      dt_mem[0]-&gt;t = ca_mem-&gt;ck_mem-&gt;ck_t0;
      storePnt(cv_mem, dt_mem[0]);
! 
!   } else if ( (tn - tout)*h &gt;= ZERO ) {
! 
!     /* If tout was passed, return interpolated solution.
!        No changes to ck_mem or dt_mem are needed. */
!     *tret = tout;
!     flag = CVodeGetDky(cv_mem, tout, 0, yout);
!     *ncheckPtr = nckpnts;
!     newData = TRUE;
!     ckpntData = ca_mem-&gt;ck_mem;
!     np = nst % nsteps + 1;
!     return(flag);
! 
!   } 
  
    /* Integrate to tout (in CV_ONE_STEP mode) while loading check points */
  
    loop {
  
***************
*** 785,795 ****
      CVProcessError(cvb_mem, CV_BAD_TBOUT, &quot;CVODEA&quot;, &quot;CVodeB&quot;, 
MSGAM_BAD_TBOUT);
      return(CV_BAD_TBOUT);
    }
  
    tBn = cvb_mem-&gt;cv_tn;
!   while ( sign*(tBn - t0_) &lt;= ZERO ) ck_mem = next_;
    
    loop {
  
      /* Store interpolation data if not available 
         This is the 2nd forward integration pass */
--- 800,810 ----
      CVProcessError(cvb_mem, CV_BAD_TBOUT, &quot;CVODEA&quot;, &quot;CVodeB&quot;, 
MSGAM_BAD_TBOUT);
      return(CV_BAD_TBOUT);
    }
  
    tBn = cvb_mem-&gt;cv_tn;
!   while ( sign*(tBn - t0_) &lt; ZERO ) ck_mem = next_;
    
    loop {
  
      /* Store interpolation data if not available 
         This is the 2nd forward integration pass */
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00733" href="msg00733.html">Re: [sundials-users] CVodeB and intermediate output</a></strong>
<ul><li><em>From:</em> &quot;John W. Eaton&quot; &lt;jwe@bevo.che.wisc.edu&gt;</li></ul></li>
<li><strong><a name="00707" href="msg00707.html">Re: [sundials-users] CVodeB and intermediate output</a></strong>
<ul><li><em>From:</em> &quot;John W. Eaton&quot; &lt;jwe@bevo.che.wisc.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00672" href="msg00672.html">[sundials-users] CVodeB and intermediate output</a></strong>
<ul><li><em>From:</em> &quot;John W. Eaton&quot; &lt;jwe@bevo.che.wisc.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00691.html">Re: [sundials-users] gamma and preconditioning</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00693.html">Re: [sundials-users] Question on hangup of Cvodes backward integration</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00672.html">[sundials-users] CVodeB and intermediate output</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00707.html">Re: [sundials-users] CVodeB and intermediate output</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00692">
<strong>Main</strong></a></li>
<li><a href="threads.html#00692">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
