<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Re: Avoiding discontinuities in y_dot -->
<!--X-From-R13: Oyna Vvaqznefu <nynauNyyay.tbi> -->
<!--X-Date: Wed, 08 Feb 2006 12:37:46 &#45;0800 (PST) -->
<!--X-Message-Id: Pine.LNX.4.58.0602081232550.8076@tux64.llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: op.s3v5pdk4t8lo91@smtp.kuleuven.ac.be -->
<!--X-Reference: Pine.LNX.4.58.0602071546170.8076@tux64.llnl.gov -->
<!--X-Reference: 200602071958.46538.Andreas.Nicolai@gmx.net -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Re: Avoiding discontinuities in y_dot</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00290.html">Date Prev</a>] [<a href="msg00292.html">Date Next</a>] [<a href="msg00289.html">Thread Prev</a>] [<a href="msg00290.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00291">Date Index</a></b>]
[<b><a href="threads.html#00291">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Re: Avoiding discontinuities in y_dot</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Alan Hindmarsh &lt;<a href="mailto:alanh%40llnl.gov">alanh@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Wed, 08 Feb 2006 12:35:32 -0800 (PST)</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>
Hi Andreas,

Why must you set the dissolution rate to zero when the mass disappears?
If that rate continues to be smoothly defined, you could leave it
alone, but continue to replace the mass y_i by yi_local = max(0,y_i)
in computing f(t,y).  Then y_i will presumably go negative (f_i &lt; 0),
and yi_local will remain zero, until something (crystallization or
source) starts up to add mass.  At that point, you would have to
locate that startup point (with rootfinding if not explicitly known)
and restart the integration with y_i = 0 (and presumably f_i &gt; 0).
I don't see any good way around that.  But this means half as many
root stops and restarts as in my original suggestion of doing a
stop/restart at y_i = 0 as well as at the startup points (f_i &gt; 0).

My point is that, if and when there is a major discontinuity in the
model, it is best to stop there and restart.  Letting the ODE/DAE
solver locate the jump and get through it on its own is likely to be
less efficient.  The rootfinding calculation should only add
marginally, as long as the root function is inexpensive.  On the other
hand, if the jump is small, each of these solvers is designed to
handle it without extra assistance.

By the way, if and when you do a rootfinding stop on a condition like
y_i = 0, it is critical that y_i is allowed to go negative, as
governed by its ODE.  Otherwise the rootfinding can never find the
zero.  This is another reason why the change to max(0,y_i) must be
done only in a local variable.

P.S. A minor correction to my comment (1) in my previous message.
When I say &quot;This use of y_local is the correct way to handle problems
with such constraints&quot;, I should qualify that by adding: ... as long
as the true solution of the system satisfies those constraints (and
the violations of them are just from numerical errors).  If the true
solution violates a constraint, the something else (e.g. stopping and
restarting) really needs to be done.

-Alan H.


On Tue, 7 Feb 2006, Andreas Nicolai wrote:

&gt;<i> Now I have a problem. The discontinuity happens at unpredictable times, in my</i>
&gt;<i> case I look at crystallization and dissolution. The discontinuity happens</i>
&gt;<i> when I calculate the dissolution rate, which must of course be set to zero</i>
&gt;<i> once my crystalline mass disappears. Now if that were a process that happens</i>
&gt;<i> only once in my simulation, the root-finding suggestion would be perfect.</i>
&gt;<i> However, in my simulations I face crystallization and dissolution at &quot;random&quot;</i>
&gt;<i> times (at least not predictable beforehand, because they depend highly on</i>
&gt;<i> climatic conditions and material properties).</i>
&gt;<i></i>
&gt;<i> In order to use the root finding I would have to check after each completed</i>
&gt;<i> time step, if I now have a solid salt mass, turn on root finding, integrate</i>
&gt;<i> until the root is found, switch back to normal integration, and as soon as</i>
&gt;<i> new salt precipitates, start again with root finding...</i>
&gt;<i></i>
&gt;<i> Wouldn't that be overkill and slow down my solution tremendously? Or does the</i>
&gt;<i> root finding influence the normal integration only marginally?</i>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00239" href="msg00239.html">Avoiding discontinuities in y_dot</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
<li><strong><a name="00288" href="msg00288.html">[sundials-users] Re: Avoiding discontinuities in y_dot</a></strong>
<ul><li><em>From:</em> Alan Hindmarsh &lt;alanh@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00289" href="msg00289.html">Re: [sundials-users] Re: Avoiding discontinuities in y_dot</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00290.html">R: [sundials-users] Re: Avoiding discontinuities in y_dot</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00292.html">Re: R: [sundials-users] Re: Avoiding discontinuities in y_dot</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00289.html">Re: [sundials-users] Re: Avoiding discontinuities in y_dot</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00290.html">R: [sundials-users] Re: Avoiding discontinuities in y_dot</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00291">
<strong>Main</strong></a></li>
<li><a href="threads.html#00291">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
