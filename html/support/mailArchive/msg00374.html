<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] mass balance and negative values -->
<!--X-From-R13: EVGO@UQOW ZW <fhy19Ncfh.rqh> -->
<!--X-Date: Tue, 14 Mar 2006 12:41:51 &#45;0800 (PST) -->
<!--X-Message-Id: 200603142038.PAA03332@webmail17.cac.psu.edu -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] mass balance and negative values</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00373.html">Date Prev</a>] [<a href="msg00375.html">Date Next</a>] [<a href="msg00358.html">Thread Prev</a>] [<a href="msg00375.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00374">Date Index</a></b>]
[<b><a href="threads.html#00374">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] mass balance and negative values</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
SHUANGCAI LI &lt;<a href="mailto:sul19%40psu.edu">sul19@psu.edu</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Tue, 14 Mar 2006 15:38:40 -0500 (EST)</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Radu,

   We are indeed getting -ve y values which are of the order of absolute
tolerance. But abs(-ve value) &gt; Abs_TOL. For example y = -0.0023 and Abs_Tol=
1e-3. Is this expected?
   Thanks for your nice suggestions.

Shuangcai

On Wed, 08 Mar 2006 13:32:50 +0000, Radu Serban wrote:

&gt;<i> Hi Shuangcai,</i>
&gt;<i> </i>
&gt;<i> see below...</i>
&gt;<i> </i>
&gt;<i> SHUANGCAI LI wrote:</i>
&gt;<i> </i>
&gt;<i> &gt;Hello All</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;     I am solving a sytem of stiff ODEs y'=f(y,t) where y values denote water</i>
depth
&gt;<i> &gt;in each grid. I used CVODE in CV_NORMAL mode with GMRES-BDF solver. Many y</i>
&gt;<i> &gt;values obtained are found to be -ve. As suggested in this forum, I tried</i>
&gt;<i> &gt;reinitialization of variables. However, since y values already obtained are</i>
-ve
&gt;<i> &gt;before they are reinitialized for the next time step, causes mass balance</i>
&gt;<i> &gt;error. Infact this error become very large with time. When I account for this</i>
&gt;<i> &gt;error on all the grids in final algebra for mass balance, error becomes small</i>
&gt;<i> &gt;but still some error existed. The rest of the error comes from the -ve y</i>
values
&gt;<i> &gt;generated in the internal time steps.</i>
&gt;<i> &gt;So from CV_NORMAL I had to switch to CV_ONE_STEP. So now I know where the</i>
mass
&gt;<i> &gt;balance error is coming from. Now the question is to correct it.</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;       Assuming two neighboring grids, with local y values as y1 and y2</i>
&gt;<i> &gt;respectively which are such that y_i=max(0,global_y)</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;                 Flux(y1,y2) = k*(y1+y2)^5/3 * (Abs(y1-y2))</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;Now, when global y1 &lt; 0, even with some flux contribution to y1 from y2,</i>
global
&gt;<i> &gt;y1 can still remain -ve. depending on magnitude of Flux(y1,y2) from grid 2.</i>
So
&gt;<i> &gt;the flux which came out of grid 2 is wasted in adding water to grid 1 (as</i>
&gt;<i> &gt;global y1 is still -ve). Instead it should have been used in increasing</i>
global
&gt;<i> &gt;y1 from 0 to +ve value.So that much amount of water flux is lost. Also errors</i>
&gt;<i> &gt;creep in just by doing reinitialization of -ve y's to 0 at each time step.</i>
This
&gt;<i> &gt;contributes to errors and the subsequent solutions get messed up big time</i>
(for
&gt;<i> &gt;certain parameter settings).</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;</i>
&gt;<i> In his reply, Paolo suggested that you should first re-evaluating your </i>
&gt;<i> flux model. Indeed, the first thing to do when unphysical components </i>
&gt;<i> creep in the solution is to decide whether these are due to a wrong or </i>
&gt;<i> incomplete mathematical model of the physical phenomenon or if they are </i>
&gt;<i> due to the numerical solution of the model.</i>
&gt;<i> </i>
&gt;<i> In other words, you first need to ask yourself if, assuming the ODEs </i>
&gt;<i> were solved *exactly* (infinite precision), your model could ever give </i>
&gt;<i> negative water levels. If you are convinced that this cannot happen than </i>
&gt;<i> the negative values come from numerically solving the ODEs (with finite </i>
&gt;<i> precision). In that case, the size of the negative components should be </i>
&gt;<i> of the order of the absolute tolerances you have specified. Can you </i>
&gt;<i> confirm that? The absolute tolerance specifies what you consider to be </i>
&gt;<i> the noise level and as such, any solution component of magnitude </i>
&gt;<i> comparable to abstol or less is equivalent to zero as far as the </i>
&gt;<i> computation is concerned. So, in any output plot or table that you </i>
&gt;<i> generate, you can just put zero in place of any such component (because </i>
&gt;<i> *you* decided that they are equivalent to zero when you selected that </i>
&gt;<i> particular abstol!).</i>
&gt;<i> </i>
&gt;<i>  From the information you provided, I think your model is probably OK if </i>
&gt;<i> implemented correctly. Using your form for the magnitude of the flux and </i>
&gt;<i> your sign convention for outflux and influx, how about writing your RHS </i>
&gt;<i> like so:</i>
&gt;<i> </i>
&gt;<i> #include &quot;sundialsmath.h&quot;</i>
&gt;<i> #define Ith(v,i) NV_Ith_S(v,i-1)</i>
&gt;<i> static void f(realtype t, N_Vector y, N_Vector ydot, void *f_data)</i>
&gt;<i> {</i>
&gt;<i>   realtype y1, y2, flux, k;</i>
&gt;<i> </i>
&gt;<i>   y1 = Ith(y,1);</i>
&gt;<i>   y2 = Ith(y,2);</i>
&gt;<i> </i>
&gt;<i>   /* Note that we do NOT modify the N_Vector y,</i>
&gt;<i>      but rather the temporary, local variables y1 and y2 */</i>
&gt;<i>   y1 = (y1&lt;0) ? 0.0 : y1;</i>
&gt;<i>   y2 = (y2&lt;0) ? 0.0 : y2;</i>
&gt;<i> </i>
&gt;<i>   /* k some positive constant */</i>
&gt;<i>   k = 1.0;</i>
&gt;<i> </i>
&gt;<i>  /* flux -&gt; flux from y1 to y2</i>
&gt;<i>    flux&gt;0 if y1&gt;y2</i>
&gt;<i>    flux&lt;0 if y1&lt;y2</i>
&gt;<i>    flux=0 if y1=y2</i>
&gt;<i>   */</i>
&gt;<i>   flux = k * RPowerR(y1+y2 , 5./3.) * (y1-y2);</i>
&gt;<i> </i>
&gt;<i>   Ith(ydot,1) = -flux;</i>
&gt;<i>   Ith(ydot,2) = flux;</i>
&gt;<i>  </i>
&gt;<i> }</i>
&gt;<i> </i>
&gt;<i> As a further refinement, I would consider setting flux=0 if </i>
&gt;<i> |y1-y2|&lt;abstol (I assume you use a scalar absolute tolerance since all y </i>
&gt;<i> are similar and thus probably have the same noise level). Translated, </i>
&gt;<i> this means that if y1 and y2 differ by less than the noise level, they </i>
&gt;<i> are equal to each other as far as the computation is concerned.</i>
&gt;<i> </i>
&gt;<i> Any negative y1 or y2 values that you would see will have to be smaller </i>
&gt;<i> in magnitude that the absolute tolerance you specify in CVodeMalloc.</i>
&gt;<i> </i>
&gt;<i> &gt;In order to correct this problem, I have two options</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;a) To reinitialize y after every time step (CV_ONE_STEP) for the grid with</i>
-ve y
&gt;<i> &gt;and then modify the y values in the neighboring cells as well. However, due</i>
to
&gt;<i> &gt;logistical problems this is very hard to do.</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;</i>
&gt;<i> Changing the y values outside CVode is fine for output purposes (see </i>
&gt;<i> above), but it would not affect the current solution that CVODE knows </i>
&gt;<i> about (which is stored internally). Anyway, you should *not* even </i>
&gt;<i> consider changing the latter.</i>
&gt;<i> </i>
&gt;<i> &gt;b) To write the equations such that I don't get -ve y in the first place. So</i>
&gt;<i> &gt;here while running my CVode in CV_ONE_STEP mode I wrote the following code</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;         main()</i>
&gt;<i> &gt;     {</i>
&gt;<i> &gt;         while(t&lt;TMAX)</i>
&gt;<i> &gt;             {</i>
&gt;<i> &gt;             T=t;</i>
&gt;<i> &gt;             CVode(........,&amp;t,CV_ONE_STEP);</i>
&gt;<i> &gt;         }</i>
&gt;<i> &gt;     }</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;         f()</i>
&gt;<i> &gt;     {</i>
&gt;<i> &gt;         /****** This region (below) have been added now *******/</i>
&gt;<i> &gt;         If(y1&gt; Flux(y1,...)*(t-T) )</i>
&gt;<i> &gt;             /* Note: +ve Flux is going out from y1 to neighbors */</i>
&gt;<i> &gt;         {</i>
&gt;<i> &gt;             Flux(y1,...)=Flux(y1,y2);</i>
&gt;<i> &gt;              }</i>
&gt;<i> &gt;         else</i>
&gt;<i> &gt;         {</i>
&gt;<i> &gt;             Flux(y1,...)=y1/(t-T);</i>
&gt;<i> &gt;          }</i>
&gt;<i> &gt;          /****** This region (above) have been added now *******/</i>
&gt;<i> &gt;          ydot=Flux(y1,y2)</i>
&gt;<i> &gt;     }</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;What this was supposed to do is to restrict outward flux depending on the</i>
&gt;<i> &gt;availibity of water depth in that grid (similar to discussion in the group).</i>
So
&gt;<i> &gt;total water flow in a particular time step can't be greater than what is</i>
&gt;<i> &gt;available on that grid. However I still got -ve y values.</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;</i>
&gt;<i> There are many questionable things in the above code snippet. What is </i>
&gt;<i> the value of the flux used in the if test? Is it saved from the previous </i>
&gt;<i> RHS evaluation? Also recall that the integration order can be higher </i>
&gt;<i> than 1 at the time RHS is called, so your 1st order approximation can be </i>
&gt;<i> very crude...</i>
&gt;<i> </i>
&gt;<i> &gt;While debugging, I found that for several time steps though y(t-1) is -ve and</i>
&gt;<i> &gt;ydot = +ve, solution obtained for the next time step becomes such that y(t) &lt;</i>
&gt;<i> &gt;y(t-1). </i>
&gt;<i> &gt;</i>
&gt;<i> &gt;--&gt; How can this be possible. Because of this perhaps, I still get -ve y</i>
values.
&gt;<i> &gt;  </i>
&gt;<i> &gt;</i>
&gt;<i> You seem to think that CVODE only uses a 1st order method (Euler) which </i>
&gt;<i> is not true. The underlying BDF polynomial can have order higher than </i>
&gt;<i> one, so what you describe is possible and valid.</i>
&gt;<i> Consider y(t)=t(1-t), t_n = 0, t_{n+1} = 2. Then y(t_n)=0, y'(t_n)=1, </i>
&gt;<i> y(t_{n+1})=-2. By the way, the sign of y(t_n) is irrelevant.</i>
&gt;<i> </i>
&gt;<i> &gt;    Now, in one earlier discussions on -ve y values, Alan had suggested</i>
&gt;<i> &gt;using root finding. However even in that case y obtained is already -ve. More</i>
&gt;<i> &gt;so, can we get a snippet for how to use root finding when y gets -ve.</i>
&gt;<i> &gt;Meanwhile, I would also like to know your opinion over if the above</i>
&gt;<i> &gt;modifications in f() is ok or not and the error discussed above. </i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;</i>
&gt;<i> The root finding feature may be useful if your *model* was such that it </i>
&gt;<i> would lead to some unphysical negative values, in which case you'd want </i>
&gt;<i> to locate the time where that happens and then adjust the model before </i>
&gt;<i> proceeding. This does not apply to your case.</i>
&gt;<i> </i>
&gt;<i> &gt;Regards,</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;Shuangcai</i>
&gt;<i> &gt;  </i>
&gt;<i> &gt;</i>
&gt;<i> -- Radu</i>
&gt;<i> </i>
&gt;<i> -- </i>
&gt;<i>    Radu Serban</i>
&gt;<i>    Center for Applied Scientific Computing   [email] radu@llnl.gov</i>
&gt;<i>    Lawrence Livermore National Laboratory    [phone] 925-424-4852</i>
&gt;<i>    P.O. Box 808, L-560                       [fax]   925-422-6287</i>
&gt;<i>    Livermore, CA 94551</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i>   </i>
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> Hi Shuangcai,</i>
&gt;<i> </i>
&gt;<i> see below...</i>
&gt;<i> </i>
&gt;<i> SHUANGCAI LI wrote:</i>
&gt;<i> </i>
&gt;<i>   Hello All</i>
&gt;<i> </i>
&gt;<i>  I am solving a sytem of stiff ODEs y'=f(y,t) where y values denote water</i>
depth
&gt;<i> in each grid. I used CVODE in CV_NORMAL mode with GMRES-BDF solver. Many y</i>
&gt;<i> values obtained are found to be -ve. As suggested in this forum, I tried</i>
&gt;<i> reinitialization of variables. However, since y values already obtained are</i>
-ve
&gt;<i> before they are reinitialized for the next time step, causes mass balance</i>
&gt;<i> error. Infact this error become very large with time. When I account for this</i>
&gt;<i> error on all the grids in final algebra for mass balance, error becomes small</i>
&gt;<i> but still some error existed. The rest of the error comes from the -ve y</i>
values
&gt;<i> generated in the internal time steps.</i>
&gt;<i> So from CV_NORMAL I had to switch to CV_ONE_STEP. So now I know where the mass</i>
&gt;<i> balance error is coming from. Now the question is to correct it.</i>
&gt;<i>   </i>
&gt;<i>        Assuming two neighboring grids, with local y values as y1 and y2</i>
&gt;<i> respectively which are such that y_i=max(0,global_y)</i>
&gt;<i>   </i>
&gt;<i>                  Flux(y1,y2) = k*(y1+y2)^5/3 * (Abs(y1-y2))</i>
&gt;<i> </i>
&gt;<i> Now, when global y1 &lt; 0, even with some flux contribution to y1 from y2,</i>
global
&gt;<i> y1 can still remain -ve. depending on magnitude of Flux(y1,y2) from grid 2. So</i>
&gt;<i> the flux which came out of grid 2 is wasted in adding water to grid 1 (as</i>
&gt;<i> global y1 is still -ve). Instead it should have been used in increasing global</i>
&gt;<i> y1 from 0 to +ve value.So that much amount of water flux is lost. Also errors</i>
&gt;<i> creep in just by doing reinitialization of -ve y's to 0 at each time step.</i>
This
&gt;<i> contributes to errors and the subsequent solutions get messed up big time (for</i>
&gt;<i> certain parameter settings).</i>
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> In his reply, Paolo</i>
&gt;<i> suggested that you should first re-evaluating your flux model. Indeed,</i>
&gt;<i> the first thing to do when unphysical components creep in the solution</i>
&gt;<i> is to decide whether these are due to a wrong or incomplete</i>
&gt;<i> mathematical model of the physical phenomenon or if they are due to the</i>
&gt;<i> numerical solution of the model. </i>
&gt;<i> </i>
&gt;<i> In other words, you first need to ask yourself if, assuming the ODEs</i>
&gt;<i> were solved exactly</i>
&gt;<i> (infinite precision), your model could ever give negative water levels.</i>
&gt;<i> If you are convinced that this cannot happen than the negative values</i>
&gt;<i> come from numerically solving the ODEs (with finite precision). In that</i>
&gt;<i> case, the size of the negative components should be of the order of the</i>
&gt;<i> absolute tolerances you have specified. Can you confirm that? The</i>
&gt;<i> absolute tolerance specifies what you consider to be the noise level</i>
&gt;<i> and as such, any solution component of magnitude comparable to abstol</i>
&gt;<i> or less is equivalent to zero as far as the computation is concerned.</i>
&gt;<i> So, in any output plot or table that you generate, you can just put</i>
&gt;<i> zero in place of any such component (because you decided that</i>
&gt;<i> they are equivalent to zero when you selected that particular abstol!).</i>
&gt;<i> </i>
&gt;<i> From the information you provided, I think your model is probably OK if</i>
&gt;<i> implemented correctly. Using your form for the magnitude of the flux</i>
&gt;<i> and your sign convention</i>
&gt;<i> for outflux and influx, how about writing your RHS like so:</i>
&gt;<i> </i>
&gt;<i> #include &quot;sundialsmath.h&quot;</i>
&gt;<i> #define Ith(v,i) NV_Ith_S(v,i-1)</i>
&gt;<i> static void f(realtype t, N_Vector y, N_Vector ydot, void *f_data)</i>
&gt;<i> {</i>
&gt;<i> &#xA0; realtype y1, y2, flux, k;</i>
&gt;<i> </i>
&gt;<i> &#xA0; y1 = Ith(y,1); </i>
&gt;<i> &#xA0; y2 = Ith(y,2); </i>
&gt;<i> </i>
&gt;<i> &#xA0; /* Note that we do NOT modify the N_Vector y, </i>
&gt;<i> &#xA0;&#xA0;&#xA0;&#xA0; but rather the temporary, local variables y1 and y2 */</i>
&gt;<i> &#xA0; y1 = (y1&lt;0) ? 0.0 : y1;</i>
&gt;<i> &#xA0; y2 = (y2&lt;0) ? 0.0 : y2;</i>
&gt;<i> </i>
&gt;<i> &#xA0; /* k some positive constant */</i>
&gt;<i> &#xA0; k = 1.0;</i>
&gt;<i> </i>
&gt;<i> &#xA0;/* flux -&gt; flux from y1 to y2</i>
&gt;<i> &#xA0;&#xA0; flux&gt;0 if y1&gt;y2</i>
&gt;<i> &#xA0;&#xA0; flux&lt;0 if y1&lt;y2</i>
&gt;<i> &#xA0;&#xA0; flux=0 if y1=y2</i>
&gt;<i> &#xA0; */</i>
&gt;<i> &#xA0; flux = k * RPowerR(y1+y2 ,</i>
&gt;<i> 5./3.) * (y1-y2);</i>
&gt;<i> </i>
&gt;<i> &#xA0; Ith(ydot,1) = -flux;</i>
&gt;<i> &#xA0; Ith(ydot,2) = flux;</i>
&gt;<i> &#xA0; </i>
&gt;<i> }</i>
&gt;<i> </i>
&gt;<i> As a</i>
&gt;<i> further refinement, I would consider setting flux=0 if</i>
&gt;<i> |y1-y2|&lt;abstol (I assume you use a scalar absolute tolerance since</i>
&gt;<i> all y are similar and thus probably have the same noise level).</i>
&gt;<i> Translated, this means that if y1 and y2 differ by less than the noise</i>
&gt;<i> level, they are equal to each other as far as the computation is</i>
&gt;<i> concerned.</i>
&gt;<i> </i>
&gt;<i> Any</i>
&gt;<i> negative y1 or y2 values that you would see will have to be smaller in</i>
&gt;<i> magnitude that the absolute tolerance you specify in CVodeMalloc.</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i>   In order to correct this problem, I have two options</i>
&gt;<i> </i>
&gt;<i> a) To reinitialize y after every time step (CV_ONE_STEP) for the grid with -ve</i>
y
&gt;<i> and then modify the y values in the neighboring cells as well. However, due to</i>
&gt;<i> logistical problems this is very hard to do.</i>
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> Changing the y values</i>
&gt;<i> outside CVode is fine for output purposes (see above), but it would not</i>
&gt;<i> affect the current solution that CVODE knows about (which is stored</i>
&gt;<i> internally). Anyway, you should not even consider changing the</i>
&gt;<i> latter.</i>
&gt;<i> </i>
&gt;<i>   b) To write the equations such that I don't get -ve y in the first place. So</i>
&gt;<i> here while running my CVode in CV_ONE_STEP mode I wrote the following code</i>
&gt;<i> </i>
&gt;<i>          main()</i>
&gt;<i>  {</i>
&gt;<i>       while(t&lt;TMAX)</i>
&gt;<i>              {</i>
&gt;<i>          T=t;</i>
&gt;<i>          CVode(........,&amp;t,CV_ONE_STEP);</i>
&gt;<i>      }</i>
&gt;<i>  }</i>
&gt;<i> </i>
&gt;<i>          f()</i>
&gt;<i>  {</i>
&gt;<i>      /****** This region (below) have been added now *******/</i>
&gt;<i>      If(y1&gt; Flux(y1,...)*(t-T) )</i>
&gt;<i>              /* Note: +ve Flux is going out from y1 to neighbors */</i>
&gt;<i>      {</i>
&gt;<i>          Flux(y1,...)=Flux(y1,y2);</i>
&gt;<i>               }</i>
&gt;<i>      else</i>
&gt;<i>      {</i>
&gt;<i>   Flux(y1,...)=y1/(t-T);</i>
&gt;<i>       }</i>
&gt;<i>       /****** This region (above) have been added now *******/</i>
&gt;<i>       ydot=Flux(y1,y2)</i>
&gt;<i>  }</i>
&gt;<i> </i>
&gt;<i> What this was supposed to do is to restrict outward flux depending on the</i>
&gt;<i> availibity of water depth in that grid (similar to discussion in the group).</i>
So
&gt;<i> total water flow in a particular time step can't be greater than what is</i>
&gt;<i> available on that grid. However I still got -ve y values.</i>
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> There are many</i>
&gt;<i> questionable things in the above code snippet. What is the value of the</i>
&gt;<i> flux used in the if test? Is it saved from the previous RHS evaluation?</i>
&gt;<i> Also recall that the integration order can be higher than 1 at the time</i>
&gt;<i> RHS is called, so your 1st order approximation can be very crude...</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i>   While debugging, I found that for several time steps though y(t-1) is -ve</i>
and
&gt;<i> ydot = +ve, solution obtained for the next time step becomes such that y(t) &lt;</i>
&gt;<i> y(t-1). </i>
&gt;<i> </i>
&gt;<i> --&gt; How can this be possible. Because of this perhaps, I still get -ve y</i>
values.
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> You seem to think that</i>
&gt;<i> CVODE only uses a 1st order method (Euler) which is not true. The</i>
&gt;<i> underlying BDF polynomial can have order higher than one, so what you</i>
&gt;<i> describe is possible and valid. </i>
&gt;<i> Consider y(t)=t(1-t), t_n = 0, t_{n+1} = 2. Then y(t_n)=0, y'(t_n)=1,</i>
&gt;<i> y(t_{n+1})=-2. By the way, the sign of y(t_n) is irrelevant. </i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i>       Now, in one earlier discussions on -ve y values, Alan had suggested</i>
&gt;<i> using root finding. However even in that case y obtained is already -ve. More</i>
&gt;<i> so, can we get a snippet for how to use root finding when y gets -ve.</i>
&gt;<i> Meanwhile, I would also like to know your opinion over if the above</i>
&gt;<i> modifications in f() is ok or not and the error discussed above. </i>
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> The root finding</i>
&gt;<i> feature may be useful if your model was such that it would lead</i>
&gt;<i> to some unphysical negative values, in which case you'd want to locate</i>
&gt;<i> the time where that happens and then adjust the model before</i>
&gt;<i> proceeding. This does not apply to your case.</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i>   Regards,</i>
&gt;<i> </i>
&gt;<i> Shuangcai</i>
&gt;<i>   </i>
&gt;<i> </i>
&gt;<i> -- Radu</i>
&gt;<i> -- </i>
&gt;<i>    Radu Serban</i>
&gt;<i>    Center for Applied Scientific Computing   [email] radu@llnl.gov</i>
&gt;<i>    Lawrence Livermore National Laboratory    [phone] 925-424-4852</i>
&gt;<i>    P.O. Box 808, L-560                       [fax]   925-422-6287</i>
&gt;<i>    Livermore, CA 94551</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> </i>



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00375" href="msg00375.html">Re: [sundials-users] mass balance and negative values</a></strong>
<ul><li><em>From:</em> Alan Hindmarsh &lt;alanh@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00373.html">Re: [sundials-users] Sundials compilation error (problem with xlc/xlf?)</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00375.html">Re: [sundials-users] mass balance and negative values</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00358.html">Re: [sundials-users] mass balance and negative values</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00375.html">Re: [sundials-users] mass balance and negative values</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00374">
<strong>Main</strong></a></li>
<li><a href="threads.html#00374">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
