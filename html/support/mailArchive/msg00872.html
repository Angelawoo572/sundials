<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] The difference between these two codes using CVodeReInit -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Wed, 07 Feb 2007 08:51:16 &#45;0800 -->
<!--X-Message-Id: 45CA0340.6030604@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: BAY120&#45;F120E1863A8A321AD19E4B5909E0@phx.gbl -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] The difference between these two codes using CVodeReInit</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00871.html">Date Prev</a>] [<a href="msg00873.html">Date Next</a>] [<a href="msg00871.html">Thread Prev</a>] [<a href="msg00873.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00872">Date Index</a></b>]
[<b><a href="threads.html#00872">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] The difference between these two codes using CVodeReInit</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Wed, 07 Feb 2007 08:50:08 -0800</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Jean Claude,</pre><br>
<pre style="margin: 0em;">Let me get in the discussion. See answers below...</pre><br>
<pre style="margin: 0em;">--Radu</pre><br>
<tt>jean-claude charr wrote:
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hello Alan,</pre><br>
<pre style="margin: 0em;">thank you for the quick reply.</pre><br>
<tt>1. The two codes would not be expected to give identical answers,
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">because the restarts in Code 2 generate a different sequence of values
of the stepsize and method order than those chosen in Code 1.  (Here
stepsizes refer to the internal choice of actual integration step, not
related to your output interval DT.)
</pre></blockquote><tt><br>is there a way to force the solver to use a certain sequence of values 
of the stepsize and method order in both programs? (while keeping the 
reinitialising phase).</tt><br>
<br>
</blockquote><pre style="margin: 0em;"><br>The question of enforcing a given step size for the SUNDIALS solvers
keeps re-emerging every now and then on this mailing list. Browse the
archive (<a  href="http://www.llnl.gov/casc/sundials/support/mailArchive/maillist.html">http://www.llnl.gov/casc/sundials/support/mailArchive/maillist.html</a>)
for previous threads on this issue.
The short answer is no, it's not possible to prescribe the step size (or
method order for that matter) as this would defeat the purpose of an
adaptive solver. Step size and method order are simply means to reach
the end of integrating with a prescribed accuracy. The user specifies
the latter (through the relative and absolute tolerances) and the solver
selects the step size and method order needed to satisfy the accuracy
requirements.</pre><br>
<pre style="margin: 0em;">After a reinitialization, the solver necessarily starts at order 1 and with
a smaller step size. Moreover, since you specify a Tstop value at the
end of each integration &quot;window&quot; in the second code, the step size will
again be modified internally so that no function evaluations occur at
a time beyond Tstop.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">However, as long as the initial
values and tolerances are the same for both codes, the results should
agree within errors that are on the order of the tolerances.  Are the
differences in answers greater than that?
</pre></blockquote><pre style="margin: 0em;"><br>My tolerances are : reltol=1e-7
                              abstol=reltol*100</pre><br>
<tt>here is the results for the same point with the two different programs 
with the same parameters:<br>
9.936305e+11               9.936230e+11</tt><br>
<br>
<tt>as you can see the difference is huge.
</tt></blockquote><pre style="margin: 0em;"><br>Please consult the user guide on the meaning of relative and absolute
tolerances. The operative word here is relative, meaning &quot;relative to
the size of the solution itself&quot;. In other words, for the above values,
you should look at the quantity
(9.936305e+11 - 9.936230e+11) / (1e-7 * |9.936e11| + 1e-5) ~ 75
This is an acceptable value for one component of your solution
vector, meaning that the two codes did in fact agree within errors
of the order of the tolerances.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">2. I understand that you must reinitialize, if the u vector is changed
at each such point.  But of course when those changes are actually made,
the codes will certainly give different answers.
</pre></blockquote><tt><br>in fact, i need to iterate on an interval, so after each iteration, i 
initialize the next iteration with the output N_Vector u of the 
precedent iteration and with the same t0 initial time as the precedent 
iteration.</tt><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>3. Why do you use the CV_NORMAL_TSTOP mode instead of CV_NORMAL in 
Code 2?<br>
If there is no singularity at tout, there is no reason to do this, and<br>
it is less efficient.
</tt></blockquote><tt><br>i'm using a CV_NORMAL_TSTOP cause i realised that the the solver is 
integrating past tout and i m getting better results with  CV_NORMAL_TSTOP.
</tt></blockquote><pre style="margin: 0em;"><br>Again, I suspect we do not have the same understanding of &quot;better results&quot; 
(see
above). There is no reason to impose a tstop value (and integrate in
CVODE_NORMAL_TSTOP mode) unless evaluating the ODE right-hand side
function beyond this time is either physically meaningless or impossible
(e.g. you need some data which is not defined beyond that point).</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">regards
Jean claude charr
</pre></blockquote><pre style="margin: 0em;"><br>A couple more (minor) comments:</pre><br>
<tt>1. FYI, yet another reason why the two codes will use different step size sequences<br>
is that the tout values with which CVode is called the very first time after<br>
CVodeMalloc or CVodeReInit (T1 in Code 1 and wind+TWINDOW in Code 2)<br>
are different which will lead to different initial step sizes (unless specified 
by the<br>
user, the internal estimation of an acceptable initial step size uses this first<br>
value of tout).</tt><br>
<br>
<pre style="margin: 0em;">2. In Code 2, you can call CVSpgmr only once, when wind==T0, where you
initialize the solver. You do not need to reattach the linear solver after a 
CVODE
reinitialization, unless you also want to use different linear solver options.</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>From: Alan Hindmarsh &lt;alanh@llnl.gov&gt;<br>
Reply-To: sundials-users@llnl.gov<br>
To: jeanclaude charr &lt;charr@iut-bm.univ-fcomte.fr&gt;<br>
CC: sundials-users@llnl.gov, alanh@llnl.gov<br>
Subject: Re: [sundials-users] The difference between these two codes 
using CVodeReInit<br>
Date: Tue, 6 Feb 2007 13:45:31 -0800 (PST)</tt><br>
<br>
<pre style="margin: 0em;">Hello Jean Claude,</pre><br>
<pre style="margin: 0em;">1. The two codes would not be expected to give identical answers,
because the restarts in Code 2 generate a different sequence of values
of the stepsize and method order than those chosen in Code 1.  (Here
stepsizes refer to the internal choice of actual integration step, not
related to your output interval DT.)  However, as long as the initial
values and tolerances are the same for both codes, the results should
agree within errors that are on the order of the tolerances.  Are the
differences in answers greater than that?</pre><br>
<pre style="margin: 0em;">2. I understand that you must reinitialize, if the u vector is changed
at each such point.  But of course when those changes are actually made,
the codes will certainly give different answers.</pre><br>
<tt>3. Why do you use the CV_NORMAL_TSTOP mode instead of CV_NORMAL in 
Code 2?<br>
If there is no singularity at tout, there is no reason to do this, and<br>
it is less efficient.</tt><br>
<br>
<pre style="margin: 0em;">4. I see that you are choosing SPGMR without preconditioning for the
linear system solver.  This is generally not very effective.  You
should look for a preconditioner based on the dominant features of the
system Jacobian.  See the User Document for more on this.</pre><br>
<pre style="margin: 0em;">Alan H.</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">On Tue, 6 Feb 2007, jeanclaude charr wrote:</pre><br>
<tt>&gt; Hello , i'm a phd student  in a french university  and i'm using cvode<br>
&gt; in my studies.<br>
&gt; i wish u can explain to me why the execution of these 2 codes return<br>
&gt; differents results?<br>
&gt; in the first code, i integrate the interval [0,T1] with steps equal 
to DT.<br>
&gt; but in the second code, i integrate every TWINDOW=10*DT then i<br>
&gt; reinitialize cvode and integrate the next TWINDOW until i integrate the<br>
&gt; whole interval [0,T1].<br>
&gt; Because, in a more complex program, i need to reinitialize the solver<br>
&gt; every TWINDOW with a new N_Vector ( u  in the code), and i m surprised<br>
&gt; to to  see that the execution of these two programs doesn't give the<br>
&gt; same results.<br>
&gt; if u have any idea why they differ please reply.<br>
&gt;<br>
&gt; I will be utterly greatful<br>
&gt; regards,<br>
&gt; Jean claude charr<br>
&gt;<br>
&gt; *_1st code:_*<br>
&gt;  .<br>
&gt;  .<br>
&gt;  .<br>
&gt;  cvode_mem = CVodeCreate(CV_BDF, CV_NEWTON);<br>
&gt;  flag = CVodeSetFdata(cvode_mem, data);<br>
&gt;<br>
&gt;  flag = CVodeMalloc(cvode_mem, f, T0, u, CV_SS, reltol, &amp;abstol);<br>
&gt;<br>
&gt;  flag = CVSpgmr(cvode_mem, PREC_NONE, 0);<br>
&gt;<br>
&gt;  for (tout = DT;tout&lt;=T1; tout += DT) {<br>
&gt;    flag = CVode(cvode_mem, tout, u, &amp;t, CV_NORMAL);<br>
&gt;    if (check_flag(&amp;flag, &quot;CVode&quot;, 1, my_pe)) break;<br>
&gt;    PrintOutput(cvode_mem, my_pe, comm, u, t);<br>
&gt;  }<br>
&gt; //display results<br>
&gt;   udata = NV_DATA_P(u);<br>
&gt;   for(i=0;i&lt;MYSUB;i++){<br>
&gt;        for(j=MXSUB*2*i;j&lt;(MXSUB*2*i)+(MXSUB*2);j++)<br>
&gt;            if(j%2==0)<br>
&gt;            fprintf(fileu,&quot;%d %d<br>
&gt; 
%6e\n&quot;,(int)(data-&gt;isubx)*(MXSUB)+(j/2)%MXSUB,(int)(data-&gt;isuby)*(MYSUB)+i,udata[j]); </tt><br>
<br>
<tt>&gt;<br>
&gt;        else<br>
&gt;            fprintf(filev,&quot;%d %d<br>
&gt; 
%6e\n&quot;,(int)(data-&gt;isubx)*(MXSUB)+(j/2)%MXSUB,(int)(data-&gt;isuby)*(MYSUB)+i,udata[j]); </tt><br>
<br>
<tt>&gt;<br>
&gt;    }<br>
&gt;  .<br>
&gt;  .<br>
&gt;  .<br>
&gt;<br>
&gt;<br>
&gt; _*2nd code:*_<br>
&gt;<br>
&gt; .<br>
&gt; .<br>
&gt; .<br>
&gt; for(wind=T0;wind&lt;T1;wind+=TWINDOW){    /*TWINDOW=10*DT;*/<br>
&gt;        if(wind==T0){<br>
&gt;            cvode_mem = CVodeCreate(CV_BDF, CV_NEWTON);<br>
&gt;            flag = CVodeSetFdata(cvode_mem, data);<br>
&gt;            flag = CVodeMalloc(cvode_mem, f, T0, u, CV_SS, reltol, 
&amp;abstol);<br>
&gt;        }<br>
&gt;        else{<br>
&gt;            ret=CVodeReInit(cvode_mem, f, wind , u,CV_SS, 
reltol,&amp;abstol);<br>
&gt;                      if(ret!=CV_SUCCESS) {<br>
&gt;                printf(&quot;pb de reinit\n&quot;);<br>
&gt;                exit(0);<br>
&gt;            }<br>
&gt;         }<br>
&gt;<br>
&gt;      flag = CVSpgmr(cvode_mem, PREC_NONE, 0);<br>
&gt;<br>
&gt;      flag = CVodeSetStopTime(cvode_mem,wind+TWINDOW);<br>
&gt;<br>
&gt;      for (tout = wind+DT;tout&lt;=wind+TWINDOW &amp;&amp; tout&lt;=T1; tout += DT) {<br>
&gt;        flag = CVode(cvode_mem, tout, u, &amp;t, CV_NORMAL_TSTOP);<br>
&gt;        if (check_flag(&amp;flag, &quot;CVode&quot;, 1, my_pe)) break;<br>
&gt;      }<br>
&gt; }<br>
&gt; //display results<br>
&gt; udata = NV_DATA_P(u);<br>
&gt; for(i=0;i&lt;MYSUB;i++){<br>
&gt;   for(j=MXSUB*2*i;j&lt;(MXSUB*2*i)+(MXSUB*2);j++)<br>
&gt;       if(j%2==0)<br>
&gt;          fprintf(fileu,&quot;%d %d<br>
&gt; 
%6e\n&quot;,(int)(data-&gt;isubx)*(MXSUB)+(j/2)%MXSUB,(int)(data-&gt;isuby)*(MYSUB)+i,udata[j]); </tt><br>
<br>
<tt>&gt;<br>
&gt;       else<br>
&gt;          fprintf(filev,&quot;%d %d<br>
&gt; 
%6e\n&quot;,(int)(data-&gt;isubx)*(MXSUB)+(j/2)%MXSUB,(int)(data-&gt;isuby)*(MYSUB)+i,udata[j]); </tt><br>
<br>
<pre style="margin: 0em;">&gt;
&gt; }
&gt; .
&gt; .
&gt; .
&gt;
</pre></blockquote><tt><br>_________________________________________________________________<br>
Get in the mood for Valentine's Day. View photos, recipes and more on 
your Live.com page. 
<a  href="http://www.live.com/?addTemplate=ValentinesDay&amp;ocid=T001MSN30A0701">http://www.live.com/?addTemplate=ValentinesDay&amp;ocid=T001MSN30A0701</a></tt><br>
<br>
</blockquote><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00871" href="msg00871.html">Re: [sundials-users] The difference between these two codes using CVodeReInit</a></strong>
<ul><li><em>From:</em> &quot;jean-claude charr&quot; &lt;j_charr@hotmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00871.html">Re: [sundials-users] The difference between these two codes using CVodeReInit</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00873.html">[sundials-users] Sundials wiki</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00871.html">Re: [sundials-users] The difference between these two codes using CVodeReInit</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00873.html">[sundials-users] Sundials wiki</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00872">
<strong>Main</strong></a></li>
<li><a href="threads.html#00872">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
