<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Interesting rounding error problem... -->
<!--X-From-R13: Dnqh Ereona <freona1Nyyay.tbi> -->
<!--X-Date: Fri, 17 Feb 2006 06:35:53 &#45;0800 (PST) -->
<!--X-Message-Id: 43F5DED3.3010400@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: op.s42rlrwgt8lo91@smtp.kuleuven.ac.be -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Interesting rounding error problem...</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00298.html">Date Prev</a>] [<a href="msg00300.html">Date Next</a>] [<a href="msg00296.html">Thread Prev</a>] [<a href="msg00297.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00299">Date Index</a></b>]
[<b><a href="threads.html#00299">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Interesting rounding error problem...</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:serban1%40llnl.gov">serban1@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Fri, 17 Feb 2006 06:33:55 -0800</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Andreas Nicolai wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi there,</pre><br>
here's again a problem of the wonderful world of real-life-physics and 
associated numerical problems :-)<br>
<br>
<pre style="margin: 0em;">I have a state variable that stores salt masses.
I also have a water mass state variable.</pre><br>
Now I run a simulation with salt masses = 0. During the simulation I get 
values around the noise level (typically salt masses -1e-15 &gt; ms &gt; 1e-15.<br>
<br>
The problem arises when I have very low water masses (mw &lt; 1e-8) and I 
calculate molalities: ms/mw. Then I get molalities that result purely 
from numerical errors, up to an order of magnitude bigger then 1e-6. 
However, the sensitivity of my solution properties and calculated fluxes 
already starts at this level, resulting in some interesting errors that 
just keep increasing over time...<br>
<br>
The fix I'm using right now is to control my salt masses: If they are in 
the range of my (user defined) noise level, I set them to zero and my 
molalities stay zero, too. Still, that seems to be some kind of ugly hack.<br>
<br>
Does anybody have a similar problem and some suggestions how to correct 
for it?<br>
<br>
<pre style="margin: 0em;">Andreas</pre><br>
</blockquote><pre style="margin: 0em;"><br>Andreas,</pre><br>
Issues like the one you describe are commonplace in multiphase simulations, in regions where one of 
the phases disappears (e.g. dry-out in water-air). I don't know your exact equations, but I suspect 
that the molal concentration of salt (ms/mw) gets multiplied by the water mass somewhere along the 
evaluation of the right-hand side. If this is indeed the case, a reformulation of the equations that 
does not rely on intermediate calculations based on the molality, should fix it. If what you need to 
get out of the simulation are the molalities themselves, you should probably compute them outside 
f(), using the solutions (ms and mw) returned by CVODE and taking care there of the case ms~uround.<br>
<br>
More generally, this is an issue that can be taken care of by proper scaling of your equations. If 
you do have an equation that does involve (ms/mw) by itself (i.e. not multiplied by something of the 
order of mw), try to see if you can scale that entire equation by (mw).<br>
<br>
<pre style="margin: 0em;">If your equations are not too involved, maybe you could post them (or at least 
the relevant ones).</pre><br>
<pre style="margin: 0em;">--Radu</pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00296" href="msg00296.html">[sundials-users] Interesting rounding error problem...</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00298.html">Re: [sundials-users] Communication between processors within time step</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00300.html">Re: [sundials-users] Communication between processors within time step</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00296.html">[sundials-users] Interesting rounding error problem...</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00297.html">[sundials-users] Communication between processors within time step</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00299">
<strong>Main</strong></a></li>
<li><a href="threads.html#00299">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
