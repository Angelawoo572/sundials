<!-- MHonArc v2.6.10 -->
<!--X-Subject: RE: [sundials&#45;users] Using CVODE to solve Difrancesco Noble Cell model -->
<!--X-From-R13: "Oyna Uneal" <ntzyNuryyvk.pbz> -->
<!--X-Date: Mon, 09 Oct 2006 13:03:25 &#45;0700 -->
<!--X-Message-Id: 001b01c6ebdd$9f375060$0a01a8c0@PCHEARTBREAK -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 452AA498.7080907@llnl.gov -->
<!--X-Head-End-->
<html>
<head>
<title>RE: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00727.html">Date Prev</a>] [<a href="msg00729.html">Date Next</a>] [<a href="msg00727.html">Thread Prev</a>] [<a href="msg00729.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00728">Date Index</a></b>]
[<b><a href="threads.html#00728">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>RE: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
&quot;Alan Garny&quot; &lt;<a href="mailto:agml%40hellix.com">agml@hellix.com</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Mon, 9 Oct 2006 21:00:51 +0100</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Kanakapriya,

Radu's comment is (obviously) right, but you may also want to check the way
you update tout. You first initialise it using:

tout = Simtime/counter;

And then update it using:

tout += tout;

This means that after each call to Cvode you are increasing the risks of
reaching the maximum number of steps allowed per call (not to mention that
tout probably doesn't hold the value you want in the first place). Instead,
you probably want to do something like:

tstep = Simtime/counter;

...

flag = CVode(cvode_mem, (i+1)*tstep, u, &amp;t, CV_NORMAL);

Note that I have discarded tout (not necessary anymore). Also, in general, I
would avoid having something like:

tout += tstep;

in your code, since this may lead to some floating point accuracy issues.

        Cheers, Alan.

&gt;<i> -----Original Message-----</i>
&gt;<i> From: owner-sundials-users@lists.llnl.gov </i>
&gt;<i> [<a  href="mailto:owner-sundials-users@lists.llnl.gov">mailto:owner-sundials-users@lists.llnl.gov</a>] On Behalf Of Radu Serban</i>
&gt;<i> Sent: 09 October 2006 20:36</i>
&gt;<i> To: sundials-users@llnl.gov</i>
&gt;<i> Subject: Re: [sundials-users] Using CVODE to solve </i>
&gt;<i> Difrancesco Noble Cell model</i>
&gt;<i> </i>
&gt;<i> mxsteps (default value=500, but can be changed through </i>
&gt;<i> CVodeSetMaxNumSteps) specifies he maximum number of steps to </i>
&gt;<i> be taken by the solver in its attempt to reach the next </i>
&gt;<i> output time. This check is provided to catch potential </i>
&gt;<i> problems with the problem definition and/or the </i>
&gt;<i> implementation and, in your case, it did exactly that :-) </i>
&gt;<i> Indeed, double check the way you increment the next output </i>
&gt;<i> time (is tout += tout the right way to do it?). For Simtime = </i>
&gt;<i> 1.0, this will request output from CVode until </i>
&gt;<i> tout=1.0715e+298, most likely not what you meant.</i>
&gt;<i> </i>
&gt;<i> --Radu</i>
&gt;<i> </i>
&gt;<i> P.S. If the functions cellptr-&gt;updateState and  </i>
&gt;<i> cellptr-&gt;cvodeCompute do not modify their arguments, I </i>
&gt;<i> suggest you replace the copy loops with just </i>
&gt;<i> uinit=NV_DATA_S(y), both in the main program and in the rhs </i>
&gt;<i> function. Same for</i>
&gt;<i> ydiff: use ydiff=NV_DATA_S(ydot) before calling cellptr-&gt;getDiff.</i>
&gt;<i> (The assignment v_data = NV_DATA_S(v) sets v_data to be a </i>
&gt;<i> pointer to the first component of v. v_data must be a pointer </i>
&gt;<i> to realtype.)</i>
&gt;<i> </i>
&gt;<i> </i>
&gt;<i> kanakapriya Kalyanasundaram wrote:</i>
&gt;<i> &gt; Hi,</i>
&gt;<i> &gt; I am trying to set up CVODE to solve DFN states.  I know </i>
&gt;<i> the model is </i>
&gt;<i> &gt; fairly accurate because with a timestep of about 0.01 ms I </i>
&gt;<i> can run the </i>
&gt;<i> &gt; model with just basic Y = Y +ydot*dtand get decent results.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; The model consists of about 16 states and corresponding </i>
&gt;<i> first degree </i>
&gt;<i> &gt; equations;  The states ARE dependent on one another.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; The chief parameter of interest is Vm (state [0]), the membrane </i>
&gt;<i> &gt; voltage.  I get continuous &quot;mxsteps steps taken before </i>
&gt;<i> reaching tout&quot;</i>
&gt;<i> &gt; error and the output sort of oscillates between -200 and </i>
&gt;<i> +20 instead </i>
&gt;<i> &gt; of going from -80 to about +20, falling sharply and then </i>
&gt;<i> combing back </i>
&gt;<i> &gt; to around -80.  These cells are autorhythmic and the curves repeat </i>
&gt;<i> &gt; automatically.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; If someone can see where I am erring please please help!</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; I will be utterly greatful.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; Regards,</i>
&gt;<i> &gt; KPKS</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; These are my steps in using CVODE:</i>
&gt;<i> &gt; //declare y, errorvector and memory space for CVODE</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;  N_Vector u,vAbsTol;</i>
&gt;<i> &gt;   void *cvode_mem;</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //define and initialize CVODE vars</i>
&gt;<i> &gt;     u = N_VMake_Serial(N,uinit); //uinit is initialized by the </i>
&gt;<i> &gt; getState function</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //some day I will figure out the rt tol for each of the </i>
&gt;<i> states , hence </i>
&gt;<i> &gt; CV instead of SS</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;     vAbsTol = N_VNew_Serial(N);</i>
&gt;<i> &gt;     if (check_flag((void *)vAbsTol, &quot;N_VNew_Serial&quot;, 0)) return(1);</i>
&gt;<i> &gt;     //intialize with vAbsTol</i>
&gt;<i> &gt;     for (int z = 0; z &lt; N; z++)</i>
&gt;<i> &gt;     NV_Ith_S(vAbsTol,z) = abstol;</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; </i>
&gt;<i> &gt;     cvode_mem = CVodeCreate(CV_BDF, CV_NEWTON);</i>
&gt;<i> &gt;     if (check_flag((void *)cvode_mem, &quot;CVodeCreate&quot;, 0)) return(1);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; // Allocate internal memory.</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;     flag = CVodeMalloc(cvode_mem, f, t, u, CV_SV, reltol, vAbsTol);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //. Attach linear solver module</i>
&gt;<i> &gt;     CVDense(cvode_mem, N);</i>
&gt;<i> &gt;     if (check_flag(&amp;flag, &quot;CVDense&quot;, 1)) return(1);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;     //user default jacobean</i>
&gt;<i> &gt;     CVDenseSetJacFn(cvode_mem, NULL, NULL);</i>
&gt;<i> &gt;     if (check_flag(&amp;flag, &quot;CVDenseSetJacFn&quot;, 1)) return(1);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //set up loop to calculate states over desired time i.e. 4s</i>
&gt;<i> &gt;    int counter = int (Simtime*1000.0);</i>
&gt;<i> &gt;     tout = Simtime/counter;</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;     for (int i = 0; i &lt; counter; i++)</i>
&gt;<i> &gt;     {</i>
&gt;<i> &gt;         int z;</i>
&gt;<i> &gt;         flag = CVode(cvode_mem, tout, u, &amp;t, CV_NORMAL);</i>
&gt;<i> &gt;         if (check_flag((void *)cvode_mem, &quot;CVode&quot;, 0)) return(1);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;       //update cell state with u vector from cvode</i>
&gt;<i> &gt;       for ( z = 0; z &lt; N; z++)</i>
&gt;<i> &gt;             uinit[z]=NV_Ith_S(u,z);</i>
&gt;<i> &gt;         cellptr-&gt;updateState(uinit);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //increment time step</i>
&gt;<i> &gt;           tout+=tout;</i>
&gt;<i> &gt;     }</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; This is the function f called by cvode to calculate the RHS::</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; static int f(realtype t, N_Vector y, N_Vector ydot, void *f_data) {</i>
&gt;<i> &gt;     double ydiff[16],uinit[16];</i>
&gt;<i> &gt;     int z;</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //put y vector into a temperory state vector</i>
&gt;<i> &gt;     for ( z = 0; z &lt; DFN_STATES; z++)</i>
&gt;<i> &gt;         uinit[z]=NV_Ith_S(y,z);</i>
&gt;<i> &gt;     //cellptr-&gt;updateState(uinit);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //call cell to compute ydot.</i>
&gt;<i> &gt;     cellptr-&gt;cvodeCompute(uinit);</i>
&gt;<i> &gt;     cellptr-&gt;getDiff(ydiff);</i>
&gt;<i> &gt; </i>
&gt;<i> &gt; //compute ydot vector used by cvode</i>
&gt;<i> &gt;     for ( z = 0; z &lt; DFN_STATES; z++)</i>
&gt;<i> &gt;         NV_Ith_S(ydot,z) = ydiff[z];</i>
&gt;<i> &gt; </i>
&gt;<i> &gt;     return(0);</i>
&gt;<i> &gt; }</i>
&gt;<i> </i>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00729" href="msg00729.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;radu@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00727" href="msg00727.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;radu@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00727.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00729.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00727.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00729.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00728">
<strong>Main</strong></a></li>
<li><a href="threads.html#00728">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
