<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Suggested annotation to documentation -->
<!--X-From-R13: Dnqh Ereona <freona1Nyyay.tbi> -->
<!--X-Date: Tue, 04 Apr 2006 16:03:34 &#45;0700 (PDT) -->
<!--X-Message-Id: 4432FA0D.3070401@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: op.s7dt58u7t8lo91@smtp.kuleuven.ac.be -->
<!--X-Reference: 44308809.2090108@llnl.gov -->
<!--X-Reference: 200604030814.08592.Andreas.Nicolai@gmx.net -->
<!--X-Reference: 443150AA.6070303@llnl.gov -->
<!--X-Reference: Pine.LNX.4.58.0604041456190.25159@tux64.llnl.gov -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Suggested annotation to documentation</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00408.html">Date Prev</a>] [<a href="msg00410.html">Date Next</a>] [<a href="msg00408.html">Thread Prev</a>] [<a href="msg00410.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00409">Date Index</a></b>]
[<b><a href="threads.html#00409">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Suggested annotation to documentation</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:serban1%40llnl.gov">serban1@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Tue, 04 Apr 2006 15:58:21 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Alan Hindmarsh wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">On Mon, 3 Apr 2006, Radu Serban wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">No, as I mentioned above, t=t_out only if result==CV_SUCCESS and
(itask==CV_NORMAL or itask==CV_NORMAL_TSTOP). Is it suggested
otherwise anywhere in the documentation?
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;"><br>Actually, this is not true in Andreas's context.  There, t_out = tstop.
In either TSTOP mode, CVODE sets t = tstop (exactly) when it returns
CV_TSTOP_RETURN.  So for Andreas's code, if t stayed strictly &lt; t_out,
something else must have been going on that was causing trouble.</pre><br>
<pre style="margin: 0em;">-Alan</pre><br>
</blockquote><pre style="margin: 0em;"><br>Alan is correct. I didn't think it through.</pre><br>
But, since you are calling CVode in CV_ONE_STEP_TSTOP mode, there is nothing unusual to get a successful return (result=CV_SUCCESS) with t &lt; 
t_out = tstop. Your code should just loop again through the inner loop. The only strange thing is that t=7199.99... happens to be that close 
to the current t_out = 7200. Can you print and post the values of the step size (both last and current) and maybe some sampled solution 
values? Is your problem going into any kind of trouble at that point?<br>
<br>
Also, this brings out another question. Why do you have to set a stop time at all? After all, your use of the outer loop suggests that you 
can very well evaluate the functions beyond tstop. If all you want is having the solution both at the intermediate steps (which I assume is 
true since you're using a ONE_STEP mode) but also at the exact times in the t_out sequence, it would be much more efficient to use 
CVodeGetDky to compute the latter, rather than enforcing a tstop. This would mean modifying the code as follows:<br>
<br>
<pre style="margin: 0em;">while (t &lt; t_end) {</pre><br>
<pre style="margin: 0em;">  set_next_t_out(t_out);</pre><br>
<pre style="margin: 0em;">  while (t &lt; t_out) {</pre><br>
<pre style="margin: 0em;">    result = CVode(cvode_mem, t_out, y_storage, &amp;t, CV_ONE_STEP_TSTOP);</pre><br>
<pre style="margin: 0em;">    if (result &lt; 0) {
      // An error occurred. Break from inner loop.
      break;
    }</pre><br>
<pre style="margin: 0em;">    // Successful step taken (result=CV_SUCCESS)</pre><br>
<pre style="margin: 0em;">    if (t &gt; t_out) {
       CVodeGetDky(cvode_mem, t_out, 0, y_other);
       // Do something with y_other = y(t_out)
    }</pre><br>
<pre style="margin: 0em;">    // Do something with y_storage = y(t) and go back in inner loop</pre><br>
<pre style="margin: 0em;">  }</pre><br>
<pre style="margin: 0em;">  if (result &lt; 0) {
     // An error occurred. Break from outer loop.
     break;
  }
}</pre><br>
The additional N_Vector y_other is needed in order to process all times in the right order. An alternative is to re-evaluate y(t) using 
CVodeGetDky when t &gt; t_out. The if block above should then be replaced with<br>
<br>
<pre style="margin: 0em;">    if (t &gt; t_out) {
       CVodeGetDky(cvode_mem, t_out, 0, y_storage);
       // Do something with y_storage = y(t_out)
       CVodeGetDky(cvode_mem, t, 0, y_storage);
       // Do something with y_storage = y(t)
       break;
    }</pre><br>
<pre style="margin: 0em;"><br>--Radu</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;"><br>On Mon, 3 Apr 2006, Radu Serban wrote:</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Andreas Nicolai wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">Morning,
</blockquote><pre style="margin: 0em;"><br>Good Morning Andreas (of course, it's all relative),</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">On Sunday 02 April 2006 22:27, Radu Serban wrote:</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Andreas,</pre><br>
<pre style="margin: 0em;">I'm not quite sure I understand what it is you describe here. Maybe you
can be a bit more clear (for example, what is the context of the 7199.99
value you mention?).
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">What happens is, that the inner loop compares t with t_out and keeps going,
even though t_out was reached. When CVODE returns successfully, the value of
t is != t_out, which causes the problem. So in my example, if t_out is set to
7200 the solver returns with CVODE_SUCCESS but t is still = 7199.99...</pre><br>
</blockquote><pre style="margin: 0em;"><br>t=t_out only on a successful return in CV_NORMAL mode.</pre><br>
<pre style="margin: 0em;">In CV_ONE_STEP (or CV_ONE_STEP_TSTOP) mode, t_out is used only on the first 
CVode() call, to get the direction of integration (i.e. to
decide if the step size is positive or negative) and to roughly estimate the 
time scale (in order to compute an initial step size).</pre><br>
<pre style="margin: 0em;">In any case, what happens in your situation is due to the fact that we declare 
t_stop reached when tn (the internal time) is 'close enough'
to t_stop. In other words, we do not test tn==t_stop (such test are not a good 
idea when dealing with floating point variables), but rather
we test if the difference between tn and t_stop is of the order of magnitude of 
the unit roundoff (with a safety factor of 100). If you are
interested in the actual implementation, look at the block between lines 1204 
and 1222 in cvode.c. For this reason, if this condition is
satisfied, the return value of CVode has a special code, a positive value named 
CV_TSTOP_RETURN (which is a &quot;successful&quot; return code, but
different from CV_SUCCESS). Therefore, here's how I would implement the two 
loops:</pre><br>
<pre style="margin: 0em;">while (t &lt; t_end) {</pre><br>
<pre style="margin: 0em;">  set_next_t_out(t_out);
  CVodeSetStopTime(cvode_mem, t_out);</pre><br>
<pre style="margin: 0em;">  while (t &lt; t_out) {</pre><br>
<pre style="margin: 0em;">    result = CVode(cvode_mem, t_out, y_storage, &amp;t, CV_ONE_STEP_TSTOP);</pre><br>
<pre style="margin: 0em;">    if (result &lt; 0) {
      // An error occurred. Break from inner loop.
      break;
    }</pre><br>
<pre style="margin: 0em;">    // Successful step taken.
    // Do something with t and y_storage (y_storage contains the solution at 
time t)</pre><br>
<pre style="margin: 0em;">    if (result == CV_TSTOP_RETURN) {
      // For all practical purposes, t_stop was reached. Break from inner loop.
      break;
    }</pre><br>
<pre style="margin: 0em;">  }</pre><br>
<pre style="margin: 0em;">  if (result &lt; 0) {
     // An error occurred. Break from outer loop.
     break;
  }
}</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">So, this problem has nothing do to with step sizes or iteration, just the
break condition of my inner loop was not quite correct (I thought t = t_out
when CVODE returns successfully).
</pre></blockquote><pre style="margin: 0em;"><br>No, as I mentioned above, t=t_out only if result==CV_SUCCESS and 
(itask==CV_NORMAL or itask==CV_NORMAL_TSTOP). Is it suggested otherwise
anywhere in the documentation?</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">The first &quot;Usage Notes&quot; on the updated SUNDIALS website (accessible from
the Support page) discusses in more detail the differences between
t_out, t_ret, t_stop, and the internal steps (t_n) taken by CVODE. The
discussion there may be helpful.
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">Btw, the new webpage and the added content is great!
Would it be possible to get a black'n white version of your solver &quot;evolution&quot;
tree, that I could use in my thesis when I discuss the different solver
variants?
</pre></blockquote><pre style="margin: 0em;"><br>You mean the timeline image on the main SUNDIALS webpage?
Sure, I could generate a black and white version for you.</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">P.S. Note that the call to CVodeSetStopTime makes no sense inside the
inner loop. You should call it only once after set_next_t_out.
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">Yes, I'll move it outside the loop.</pre><br>
<pre style="margin: 0em;">Bye,
Andreas</pre><br>
</blockquote><pre style="margin: 0em;"><br>--Radu</pre><br>
<pre style="margin: 0em;">--
   Radu Serban
   Center for Applied Scientific Computing   [email] radu@llnl.gov
   Lawrence Livermore National Laboratory    [phone] 925-424-4852
   P.O. Box 808, L-560                       [fax]   925-422-6287
   Livermore, CA 94551</pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">--
   Radu Serban
   Center for Applied Scientific Computing   [email] radu@llnl.gov
   Lawrence Livermore National Laboratory    [phone] 925-424-4852
   P.O. Box 808, L-560                       [fax]   925-422-6287
   Livermore, CA 94551</pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00410" href="msg00410.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00400" href="msg00400.html">[sundials-users] Suggested annotation to documentation</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
<li><strong><a name="00395" href="msg00395.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00396" href="msg00396.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
<li><strong><a name="00403" href="msg00403.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00408" href="msg00408.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
<ul><li><em>From:</em> Alan Hindmarsh &lt;alanh@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00408.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00410.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00408.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00410.html">Re: [sundials-users] Suggested annotation to documentation</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00409">
<strong>Main</strong></a></li>
<li><a href="threads.html#00409">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
