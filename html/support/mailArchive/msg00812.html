<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Stiff ODE solution is slow? -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Tue, 05 Dec 2006 12:28:47 &#45;0800 -->
<!--X-Message-Id: 4575D5E8.6080500@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20061204231913.37112.qmail@web58414.mail.re3.yahoo.com -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Stiff ODE solution is slow?</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00811.html">Date Prev</a>] [<a href="msg00813.html">Date Next</a>] [<a href="msg00809.html">Thread Prev</a>] [<a href="msg00815.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00812">Date Index</a></b>]
[<b><a href="threads.html#00812">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Stiff ODE solution is slow?</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Tue, 05 Dec 2006 12:26:16 -0800</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Greg,</pre><br>
<tt>You should look into preconditioning. Your problem is probably too small to 
consider for parallelization. Any speed-up you'd get from evaluating the RHS in 
parallel and using the parallel vector operations in nvec_parallel would 
probably be shadowed by the communication cost. Moreover, even with a parallel 
implementation, you'll still want to look into preconditioning (which would be 
harder, as it'd have to be done also in parallel).</tt><br>
<br>
<tt>A good preconditioner will lead to many fewer iterations in the linear solver 
and hence function evaluations (which usually dominate the cost of the entire 
simulation). This is because at each iteration, a Krylov solver needs to 
evaluate a Jacobian vector product, which by default is done with a difference 
quotient approximation which requires one function evaluation. With a really 
good preconditioner, you can hope for a number of function evaluations that is 
roughly about twice the number of steps. For example, the cvkryx example, 
modified to disable preconditioning, runs in nst=491 steps with nfe=1953 total 
RHS evaluations. On the other hand, the example cvkryx_bp (same problem but with 
left preconditioning using the CVBANDPRE module) runs in 487 steps using 1239 
RHS evaluations.</tt><br>
<br>
<tt>What are the run statistics from your run? You do not have to run the problem 
until t=30000. Use something that will finish in a reasonable amount of time, 
but please provide complete statistics, both from CVODE (use CVodeGet** 
functions) and from the linear solver (use CVSPils** functions).</tt><br>
<br>
<tt>Depending on the exact structure of your Jacobian (I understand it has a 
significant block which is banded, but what about the rest? what can you tell 
about the sparsity pattern and/or magnitude of components in the remainder 
blocks?) you may be able to use the banded preconditioner module CVBANDPRE (not 
CVBBDPRE -- that one is meant for the parallel case). Otherwise, you'll have to 
write a custom preconditioner by providing the setup and solve functions. Again, 
the two rules for a preconditioner matrix P are (1) it must approximate 
reasonably well the Newton iteration matrix M=I-gamma*J, where J is the Jacobian 
of your ODE, I is the identity matrix, and gamma is a constant (proportional to 
the step size) which is passed to your preconditioner functions by the CVODE 
solver; and (2) linear systems of the form Px=b, with some vector b passed to 
you by the CVODE solver, must be &quot;cheap&quot; to solve.</tt><br>
<br>
<pre style="margin: 0em;">Finally, a couple more things:</pre><br>
<tt>1) Regarding setting negative y values to zero in the RHS function, are you 
confident that such negative values come only from the approximate solution of 
the ODEs? In other words, if the integration were perfect, is your mathematical 
model such that all y stay positive? Unless you need the y values to be positive 
to be able to evaluate the RHS (e.g. if you use sqrt or ln), try to remove that 
and see how well does CVODE preserve the positivity constraint. Also, try to 
tighten the tolerances and see if that leads to smaller violations of these 
constraints.</tt><br>
<br>
<tt>2) How you get the k's in y'=-ky? They cannot be constants, otherwise you'd have 
a bunch of decoupled ODEs? Do you ignore some (small) coupling terms at some 
(relevant) configuration? Are you using a linearization of the ODEs?</tt><br>
<br>
<pre style="margin: 0em;">--Radu</pre><br>
<tt>P.S. Stiffness is characterized by the presence of strongly damped modes. In a 
linear approximation, this would mean modes corresponding to y'=-ky with k large 
and positive (if real), not small.</tt><br>
<br>
<tt><br>Gregory Mason wrote:
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>Hi There<br>
  I have few questions...<br>
   I have a set of stiff ODEs. THe RHS matrix is sparse but is not 
banded. Infact assuming that I have 4000 ODEs to solve......if I use 
only 3500 of them, they do form a sparse banded matrix. Other relevant 
information regarding the ODEs: If I write them in form of y' = -ky, k 
for 1000 of them(odes) is ~ 10^6, while for the rest of them it is 
~10^-1. All the (&quot;y&quot;)s vary between 0 to 10. And the tolerances I am 
setting is a scaler abs tolerance of 10^-4 and and rel. tolerance of 
10^-3. Now for solving this system, on a 2.5 gHZ machine, it takes 6 hrs 
to go from t =0 to t =30000. I was wondering if this is the average 
computational time for solving this a set of stiff ODEs this big. 
Because for my needs, its still quite slow. If this is what is expected, 
then perhaps I have two choices: i) Use of preconditioner ii) 
Parallelizing the code. I forgot to mention that I am running the the 
code using Newton_Krylov solver. Btw, When I try to plot the internal 
time steps taken by the solver, I see that for initial few time steps 
(t&lt;100) it took relatively larger time steps starting with an initial 
time step provided by me, however after that its decreasing 
exponentially (almost) uptill I ran the simulations to.<br>
 Since I dont' have any prior experience with the preconditioners, I 
tried to incorporate CVBDDPRE (the default banded precond). But the code 
which works ok (but slow) without the preconditioners starts generating  
&quot;nan&quot; values just after few time steps (t&lt;50). In the code, all -ve 
values are temporarily set to 0 in the f() function.<br>
 Can some please suggest some ways to make the code run faster. Is the 
selection of my tolerances ok. What kind of experiment should I do to 
derive a preconditioner and what might be the possible cause of failure 
of BDDPRE. And, can someone also give me a rough estimate of how much 
computational time i can save using the preconditioner with krylov 
solver which will help me in prioritizing my subsequent work in terms of 
parallelizing the code or developing a preconditioner.<br>
Regards<br>
Greg<br>
p.s-&gt; Also, once I tried to set of the slower variables (with smaller k) 
by putting y'=0 for all of them. And I presumed that<br>
this will essentially mean that the solver will be solving only ODEs 
with large k and then the system should not remain stiff , which should 
eventually lead to drastic decrease in solver time. But this didn't 
happened. Any explanation?</tt><br>
<br>
</blockquote><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00809" href="msg00809.html">[sundials-users] Stiff ODE solution is slow?</a></strong>
<ul><li><em>From:</em> Gregory Mason &lt;gregbrickmason@yahoo.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00811.html">Re: [sundials-users] CVODES with fortran</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00813.html">[sundials-users] CMake build system for Sundials</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00809.html">[sundials-users] Stiff ODE solution is slow?</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00815.html">Re: [sundials-users] Stiff ODE solution is slow?</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00812">
<strong>Main</strong></a></li>
<li><a href="threads.html#00812">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
