<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] intermediate output with CVodeF -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Fri, 15 Sep 2006 11:47:48 &#45;0700 -->
<!--X-Message-Id: 450AF41E.8070308@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 17672.25732.590396.652814@segfault.lan -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] intermediate output with CVodeF</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00685.html">Date Prev</a>] [<a href="msg00687.html">Date Next</a>] [<a href="msg00670.html">Thread Prev</a>] [<a href="msg00687.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00686">Date Index</a></b>]
[<b><a href="threads.html#00686">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] intermediate output with CVodeF</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Fri, 15 Sep 2006 11:42:38 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi John,</pre><br>
Indeed, this is a bug in CVodeF. The wrong behavior you see can happen only when 
output is requested more than once within the same internal step (notice that 
the step size used by cvodes when this error occurs is about 0.14, larger than 
0.1). The reason for this is that, whether you call CVodeF in NORMAL or ONE_STEP 
mode, it will in turn call CVode always in ONE_STEP mode and the current 
implementation will take a new step even if not necessary...<br>
I fixed this in the current development version. If you want to fix your CVODES 
copy, in the file cvodea.c, function CVodeF(), replace the block<br>
<br>
<pre style="margin: 0em;">  /* On the first step, load dt_mem[0] */
  if ( nst == 0) {
    dt_mem[0]-&gt;t = ca_mem-&gt;ck_mem-&gt;ck_t0;
    storePnt(cv_mem, dt_mem[0]);
  }</pre><br>
<pre style="margin: 0em;">starting at line 354 (in Revision: 1.37.2.7), with the block:</pre><br>
<pre style="margin: 0em;">  /* On the first step, load dt_mem[0].
     On subsequent steps, test if taking a new step is necessary. */
  if ( nst == 0) {</pre><br>
<pre style="margin: 0em;">    dt_mem[0]-&gt;t = ca_mem-&gt;ck_mem-&gt;ck_t0;
    storePnt(cv_mem, dt_mem[0]);</pre><br>
<pre style="margin: 0em;">  } else if ( (tn - tout)*h &gt;= ZERO ) {</pre><br>
<pre style="margin: 0em;">    /* If tout was passed, return interpolated solution.
       No changes to ck_mem or dt_mem are needed. */
    *tret = tout;
    flag = CVodeGetDky(cv_mem, tout, 0, yout);
    *ncheckPtr = nckpnts;
    newData = TRUE;
    ckpntData = ca_mem-&gt;ck_mem;
    np = nst % nsteps + 1;
    return(flag);</pre><br>
<pre style="margin: 0em;">  }</pre><br>
<pre style="margin: 0em;">This should fix the problem.</pre><br>
<pre style="margin: 0em;">--Radu</pre><br>
<br>John W. Eaton wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">I'm using sundials 2.2.0 on a Debian amd64 system.  I installed the
sundials libraries using the Debian package manager.</pre><br>
<pre style="margin: 0em;">If I compile the attached code with</pre><br>
<pre style="margin: 0em;">  gcc -I/usr/include/cvodes -I/usr/include/sundials -o foo foo.c 
-lsundials_cvodes -lsundials_nvecserial</pre><br>
<pre style="margin: 0em;">and then run the resulting program I see the following output:</pre><br>
<pre style="margin: 0em;">  $ ./foo
  i =  0, tout = 0.1, flag = 0, x = 0.0951668
  i =  1, tout = 0.2, flag = 0, x = 0.181273
  i =  2, tout = 0.3, flag = 0, x = 0.259182
  i =  3, tout = 0.4, flag = 0, x = 0.32968
  i =  4, tout = 0.5, flag = 0, x = 0.393469
  i =  5, tout = 0.6, flag = 0, x = 0.451188
  i =  6, tout = 0.7, flag = 0, x = 0.503415
  i =  7, tout = 0.8, flag = 0, x = 0.550671
  i =  8, tout = 0.9, flag = 0, x = 0.593431
  i =  9, tout = 1.0, flag = 0, x = 0.632122
  i = 10, tout = 1.1, flag = 0, x = 0.667132</pre><br>
<pre style="margin: 0em;">If I add -DUSE_CVODEF_AND_ADJOINT_MEM to the compiler flags so that
the program uses CVodeF and the adjoint memory allocated with</pre><br>
<pre style="margin: 0em;">  cvadj_mem = CVadjMalloc (cvode_mem, 150, CV_HERMITE);</pre><br>
<pre style="margin: 0em;">then I see the following output:</pre><br>
<pre style="margin: 0em;">  i =  0, tout = 0.1, flag = 0, x = 0.0951668
  i =  1, tout = 0.2, flag = 0, x = 0.181273
  i =  2, tout = 0.3, flag = 0, x = 0.259182
  i =  3, tout = 0.4, flag = 0, x = 0.32968
  i =  4, tout = 0.5, flag = 0, x = 0.393469
  i =  5, tout = 0.6, flag = 0, x = 0.451188
  i =  6, tout = 0.7, flag = 0, x = 0.503415
  i =  7, tout = 0.8, flag = 0, x = 0.550671
  i =  8, tout = 0.9, flag = 0, x = 0.593431</pre><br>
<pre style="margin: 0em;">  [CVODES ERROR]  CVodeGetDky
    Illegal value for t.t = 1 is not between tcur - hu = 1.02294 and tcur = 
1.16349.</pre><br>
<pre style="margin: 0em;">  i =  9, tout = 1.0, flag = 0, x = 0.687612</pre><br>
<pre style="margin: 0em;">  [CVODES ERROR]  CVodeGetDky
    Illegal value for t.t = 1.1 is not between tcur - hu = 1.16349 and tcur = 
1.26711.</pre><br>
<pre style="margin: 0em;">  i = 10, tout = 1.1, flag = 0, x = 0.718359</pre><br>
<pre style="margin: 0em;">Why doesn't CVodeF provide intermediate output in the same way as
CVode?  Is this a bug in CVodeF or am I misunderstanding how things
are supposed to work?  If it is my error, then what is the appropriate
way to get intermediate output when using CVodeF?</pre><br>
<pre style="margin: 0em;">Thanks,</pre><br>
<pre style="margin: 0em;">jwe</pre><br>
<br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00687" href="msg00687.html">Re: [sundials-users] intermediate output with CVodeF</a></strong>
<ul><li><em>From:</em> &quot;John W. Eaton&quot; &lt;jwe@bevo.che.wisc.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00670" href="msg00670.html">[sundials-users] intermediate output with CVodeF</a></strong>
<ul><li><em>From:</em> &quot;John W. Eaton&quot; &lt;jwe@bevo.che.wisc.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00685.html">Re: [sundials-users] Maximum order of 12 in the non-stiff IVP is not reached!</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00687.html">Re: [sundials-users] intermediate output with CVodeF</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00670.html">[sundials-users] intermediate output with CVodeF</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00687.html">Re: [sundials-users] intermediate output with CVodeF</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00686">
<strong>Main</strong></a></li>
<li><a href="threads.html#00686">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
