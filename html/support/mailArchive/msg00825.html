<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Stiff ODE solution is slow? -->
<!--X-From-R13: Oyna Vvaqznefu <nynauNyyay.tbi> -->
<!--X-Date: Wed, 13 Dec 2006 14:57:24 &#45;0800 -->
<!--X-Message-Id: Pine.LNX.4.58.0612131442100.460@tux64.llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20061206234813.76148.qmail@web58413.mail.re3.yahoo.com -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Stiff ODE solution is slow?</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00823.html">Date Prev</a>] [<a href="msg00826.html">Date Next</a>] [<a href="msg00816.html">Thread Prev</a>] [<a href="msg00827.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00825">Date Index</a></b>]
[<b><a href="threads.html#00825">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Stiff ODE solution is slow?</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Alan Hindmarsh &lt;<a href="mailto:alanh%40llnl.gov">alanh@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Wed, 13 Dec 2006 14:44:32 -0800 (PST)</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>
Hello Greg,

I have several comments and questions.

1. Your matrix is indeed approximately equal to a band matrix, and so
the band preconditioner should do well on it.  In your picture, the
bandwith is determined by the diagonal lines of elements just outside
the main blocks.  In the case shown, ml and mu would be 11, meaning
that the band includes locations (i,j) with |i-j| &lt;= 11.  You would do
slightly better if you interchange components 34 and 35, because that
would bring two elements into the band that would not be included
otherwise.

2. With the band preconditioner, you are counting on the Krylov
iteration to take care of the couplings that are outside the band.
(I see 12 such elements in this case.)  What is important is the
relative size of these matrix elements (actually the Jacobian elements
in the nonlinear case).  When you were giving ydot values, that is not
relevant.  If some of those Jacobian elements are small, the iteration
will perform even better.  By the way, you did not say which Krylov
method you chose; we recomment GMRES in general.

3. Is the number of elements outside the band (or of those that are
relatively large) going to grow as the problem size grows?  If so,
this could make the efficiency degrade.  In that case you may need to
using a preconditioner that includes some or all of those outside
elements.  That could be done with a border-band linear system solver,
provided that you can generate the Jacobian elements themselves.
(I have such a solver, in Fortran.)

4. When you tried CVBANDPRE but got nan-s and a blow-up, I have no
idea what caused that.  Even if you gave bad values for ml and mu,
there should not be any nan-s in a state vector.  Divisions by zero
are prevented by singularity checks during the banded LU decomposition.

5. Your table of statistics (with unpreconditioned Krylov) shows that
the average stepsize was exactly 1 out to t = 12050, then dropped to
.04 in the last interval.  At the same time the Krylov iteration was
having lots of convergence failures (ncfl).  And from your 11-fold
increase in run-time for the time interval 18000 to 36000, the
stesizes dropped even more then.  But it is not clear whether those Krylov
failures were the sole cause of the stepsize reductions.  They could
be, and in that case you just need to work on the preconditioner.  But
is there something else happening in the solution that requires
reduced stepsizes?  If so, you may have other problems -- most likely
in the choice of tolerances.  The way to answer this question is to
run the problem with the Dense linear solver choice, so that there can
be no failures in the linear system solution.  Even though that is
expensive, it will tell you if there are other issues to deal with.

6. You say you had trouble getting second derivatives.  Your call to
CVodeGetDky looks correct.  Did you check the return value to make
sure t and the order (=2) are legal?  (The order would be illegal
only if CVODE was running at order 1 at the time of the call.)
Did you make sure the Y_other is of type N_Vector?

I hope this helps.

-Alan H

On Wed, 6 Dec 2006, Gregory Mason wrote:

&gt;<i> Hi There</i>
 Thanks for your prompt response. In continuation with the discussion, I am 
attaching with this mail a .doc file showing the matrix A in Y'=AY. In the 
first table, there are four colored blocks, say M1, M2, M3 and M4 corresponding 
to different states which are being calculated.Matrix M1 is same as M3 in 
topology though Y' equations are different. And their relation to M4 is also 
same, meaning that ith element of M4 relates to nth element of both M1 and M3. 
Also maximum number of non diagonal terms for any Y in M1 and M3 can be 4, for 
M2 it is 0 and for M4 it can be 2. Size of M1, M2 and M3 are same. The  real 
problem which i am solving looks similar to what I have shown in this 36x36 
matrix.The y_dot equation which I wrote about last time is acutally not linear. 
I was just trying to give a sense of the relative magnitude of y_dot values. 
The actual y_dot values for y in M1 is 0 to 10^8, M2 is 0 to 10^1, M3 is 0 to 
10^2 and M4 is 0 to 10^4. Meanwhile I did try CVBANDPRE
&gt;<i>  earlier. It was my mistake that i mentioned it as CVBDDPRE in last mail. And </i>
&gt;<i> for CVBANDPRE, the solver gave &quot;nan&quot; value for few state variable before </i>
&gt;<i> blowing up though it was working ok without preconditioner. Also I didn't </i>
&gt;<i> have any idea about what value of mu and ml should be taken.</i>
 The second table shows the statistics obtained from solver run. They have been 
obtained uptill t = 18000. Simulation for first 18000 runs in 30 min and the 
rest 18000 in 5 hrs 30 min.
 Seems like I will have to go through Dr. Hindmarsh's paper on preconditioners 
before I make any foray here..
Regards
Greg
p.s-&gt; Btw, while trying to calculate 2nd derivative I used 
CVodeGetDky(cvode_mem,t,2,Y_other). But when I try to print NV_Ith_S(Y_other, 
i) I dont' get the expected value. How should I access Y_other vector?



----- Original Message ----
From: Alan Hindmarsh &lt;alanh@llnl.gov&gt;
To: Gregory Mason &lt;gregbrickmason@yahoo.com&gt;
Cc: sundials-users@llnl.gov; alanh@llnl.gov
Sent: Wednesday, December 6, 2006 5:33:30 PM
Subject: Re: [sundials-users] Stiff ODE solution is slow?


Hi Gregory,

I agree with Radu's answers to your latest quesions.  In summary: run
serial, use Newton-Krylov, but use a preconditioner.  I strongly
suspect that a banded preconditioner which includes the banded part of
the RHS coefficient matrix will work well.  The Krylov iterations take
care of what that does not include.

Also: stiffness is charactarized by a large value of the ratio
  (time span of interest) / (smallest decay time constant)
If you just remove equations like y' = -ky with small k, the stiffness
does not change at all, because you have not changed either the large k's
or the time span.

-Alan H

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00816" href="msg00816.html">Re: [sundials-users] Stiff ODE solution is slow?</a></strong>
<ul><li><em>From:</em> Gregory Mason &lt;gregbrickmason@yahoo.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00823.html">[sundials-users] [ANNOUNCE] Gentoo ebuild for sundials now available</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00826.html">[sundials-users] IDA stochastic problem</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00816.html">Re: [sundials-users] Stiff ODE solution is slow?</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00827.html">Re: [sundials-users] Stiff ODE solution is slow?</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00825">
<strong>Main</strong></a></li>
<li><a href="threads.html#00825">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
