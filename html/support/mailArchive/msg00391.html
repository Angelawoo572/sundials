<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] memory leaks -->
<!--X-From-R13: Oqevna Rvrgm <nqevna.qvrgmNtznvy.pbz> -->
<!--X-Date: Thu, 23 Mar 2006 00:32:56 &#45;0800 (PST) -->
<!--X-Message-Id: 13eaacd00603230030v46270f66t@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 13eaacd00603210708l562e614s@mail.gmail.com -->
<!--X-Reference: 442021BD.10605@llnl.gov -->
<!--X-Reference: 13eaacd00603210946y69a894d8x@mail.gmail.com -->
<!--X-Reference: 13eaacd00603211000p1d6c46b3o@mail.gmail.com -->
<!--X-Reference: 44204304.3000100@llnl.gov -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] memory leaks</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00390.html">Date Prev</a>] [<a href="msg00392.html">Date Next</a>] [<a href="msg00388.html">Thread Prev</a>] [<a href="msg00394.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00391">Date Index</a></b>]
[<b><a href="threads.html#00391">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] memory leaks</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Adrian Dietz &lt;<a href="mailto:adrian.dietz%40gmail.com">adrian.dietz@gmail.com</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Thu, 23 Mar 2006 09:30:04 +0100</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Thank you for the explanation..
but it is not so clear in the notice, I used a dense solver because I
was using a CV_FUNCTINAL what it is logic, but the dense solver is
already selected (and allocated) when specifing CV_FUNTIONAL, the
problem come of course when deallocating memory. The CVODE logic it is
not false, it should be just explicit in the notice.
Of course this was my first test of the C version of lsoda, this was
why you see for exmple a vector for a_tol, in the future I am going to
takle real size problem (4*320*4),
Thanks again,
Adrian Dietz


2006/3/21, Radu Serban &lt;serban1@llnl.gov&gt;:
&gt;<i> Aha!</i>
&gt;<i> It didn't even occur to me to see what type of nonlinear solver you are </i>
&gt;<i> using. By passing CV_FUNCTIONAL as the second parameter to</i>
&gt;<i> CVodeCreate, you specify using functional iterations to solve the nonlinear </i>
&gt;<i> systems. As such, you do not need to attach a linear solver to</i>
&gt;<i> CVODE (CVDense specifies the direct dense linear solver). A linear solver is </i>
&gt;<i> needed only if you use Newton method (specified with CV_NEWTON).</i>
&gt;<i></i>
&gt;<i> The memory for the linear solver (allocated by CVDense) is deallocated by </i>
&gt;<i> CVodeFree, but that is done inside an if statement which tests</i>
&gt;<i> whether the method is CV_NEWTON. In your case, the linear solver memory </i>
&gt;<i> deallocation is not called because the solver did NOT expect to have</i>
&gt;<i> a linear solver attached to it.</i>
&gt;<i></i>
&gt;<i> Maybe we should consider removing the conditional linear solver memory </i>
&gt;<i> deallocation to prevent such misuses...</i>
&gt;<i></i>
&gt;<i> --Radu</i>
&gt;<i></i>
&gt;<i></i>
&gt;<i></i>
&gt;<i> Adrian Dietz wrote:</i>
&gt;<i> &gt; I have suppresed the line</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;&gt;       flag = CVDense(cvode,state);</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; related to the solver.. and the memory leaks desappear, the results</i>
&gt;<i> &gt; are the same. what does it means.. ??</i>
&gt;<i> &gt; shall I not allocated the solver memory?</i>
&gt;<i> &gt; shall I deallocate the memory solver on my own??</i>
&gt;<i> &gt; if somebody can clarify it ...</i>
&gt;<i> &gt; many thanks</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; 2006/3/21, Adrian Dietz &lt;adrian.dietz@gmail.com&gt;:</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;&gt;Thanks for the remark.. I am going to correct it...</i>
&gt;<i> &gt;&gt;I am still having problems with memory leaks, it doenst comme from the</i>
&gt;<i> &gt;&gt;&quot;retour&quot; pointer</i>
&gt;<i> &gt;&gt;did your heard about somebody having this kind of problem.? I am very</i>
&gt;<i> &gt;&gt;strict in this point.</i>
&gt;<i> &gt;&gt;was the memory management tested for the kind of use that I am doing?</i>
&gt;<i> &gt;&gt;because when using a simple method as Runge-Kutta written by myself I</i>
&gt;<i> &gt;&gt;dont have this problem.</i>
&gt;<i> &gt;&gt;Many thanks again..</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;Adrian Dietz</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;my code again</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;static Model *global_pointer_this;</i>
&gt;<i> &gt;&gt;static void f(realtype t, N_Vector u, N_Vector udot, void *f_data);</i>
&gt;<i> &gt;&gt;void Model::Evolve_Artificial_CVODE(double time) {</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       global_pointer_this = this;</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       int a = 0;</i>
&gt;<i> &gt;&gt;       int flag = 0;</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       long int state = this-&gt;n_states;</i>
&gt;<i> &gt;&gt;       N_Vector Y0 = N_VMake_Serial(state , this-&gt;States);</i>
&gt;<i> &gt;&gt;       N_Vector Y1 = N_VNew_Serial(state);</i>
&gt;<i> &gt;&gt;       void *cvode = CVodeCreate(CV_BDF, CV_FUNCTIONAL);</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       double rtol = 1.e-12;</i>
&gt;<i> &gt;&gt;       double *atol =  new double[this-&gt;n_states];</i>
&gt;<i> &gt;&gt;       for(a = 0; a &lt; this-&gt;n_states; ++a) {</i>
&gt;<i> &gt;&gt;               atol[a] = 1.e-12;</i>
&gt;<i> &gt;&gt;       }</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       void *a_tol = (void *)atol;</i>
&gt;<i> &gt;&gt;       flag = CVodeMalloc(cvode, f, 0., Y0, CV_SS, rtol, a_tol);</i>
&gt;<i> &gt;&gt;       double tret = 0.;</i>
&gt;<i> &gt;&gt;       flag = CVDense(cvode,state);</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       flag = CVode(cvode, time, Y1, &amp;tret, CV_NORMAL);</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       double *mon_Y1 = N_VGetArrayPointer_Serial(Y1);</i>
&gt;<i> &gt;&gt;       for(a = 0; a &lt; this-&gt;n_states; ++a) {</i>
&gt;<i> &gt;&gt;               this-&gt;States[a] = mon_Y1[a];</i>
&gt;<i> &gt;&gt;       }</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       this-&gt;Compute_Outputs(this-&gt;States);</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       N_VDestroy_Serial(Y0);</i>
&gt;<i> &gt;&gt;       N_VDestroy_Serial(Y1);</i>
&gt;<i> &gt;&gt;       CVodeFree(cvode);</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       delete [] atol;</i>
&gt;<i> &gt;&gt;}</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;static void f(realtype t, N_Vector u, N_Vector udot, void *f_data) {</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;&gt;       double *mon_u = N_VGetArrayPointer_Serial(u);</i>
&gt;<i> &gt;&gt;       double *retour = global_pointer_this-&gt;Get_State_Derivatives(mon_u);</i>
&gt;<i> &gt;&gt;       double *le_pointeur = N_VGetArrayPointer_Serial(udot);</i>
&gt;<i> &gt;&gt;       int a = 0;</i>
&gt;<i> &gt;&gt;       int a_max = global_pointer_this-&gt;N_States();</i>
&gt;<i> &gt;&gt;       for(a = 0; a &lt; a_max; ++a) {</i>
&gt;<i> &gt;&gt;               le_pointeur[a] = retour[a];</i>
&gt;<i> &gt;&gt;       }</i>
&gt;<i> &gt;&gt;       delete [] retour;</i>
&gt;<i> &gt;&gt;}</i>
&gt;<i> &gt;&gt;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; --</i>
&gt;<i> &gt; Adrian Dietz</i>
&gt;<i> &gt; 35 rue de Lothaire II</i>
&gt;<i> &gt; appartement 69</i>
&gt;<i> &gt; 54000 Nancy</i>
&gt;<i> &gt; France</i>
&gt;<i> &gt; +33-(0)3.83.44.63.62</i>
&gt;<i> &gt; <a  href="http://adrian.dietz.free.fr">http://adrian.dietz.free.fr</a></i>
&gt;<i> &gt;</i>
&gt;<i> &gt;</i>
&gt;<i></i>
&gt;<i></i>
&gt;<i> --</i>
&gt;<i>     Radu Serban</i>
&gt;<i>     Center for Applied Scientific Computing   [email] radu@llnl.gov</i>
&gt;<i>     Lawrence Livermore National Laboratory    [phone] 925-424-4852</i>
&gt;<i>     P.O. Box 808, L-560                       [fax]   925-422-6287</i>
&gt;<i>     Livermore, CA 94551</i>
&gt;<i></i>


--
Adrian Dietz
35 rue de Lothaire II
appartement 69
54000 Nancy
France
+33-(0)3.83.44.63.62
<a  href="http://adrian.dietz.free.fr">http://adrian.dietz.free.fr</a>


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00394" href="msg00394.html">Re: [sundials-users] memory leaks</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00382" href="msg00382.html">[sundials-users] memory leaks</a></strong>
<ul><li><em>From:</em> Adrian Dietz &lt;adrian.dietz@gmail.com&gt;</li></ul></li>
<li><strong><a name="00384" href="msg00384.html">Re: [sundials-users] memory leaks</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00386" href="msg00386.html">Re: [sundials-users] memory leaks</a></strong>
<ul><li><em>From:</em> Adrian Dietz &lt;adrian.dietz@gmail.com&gt;</li></ul></li>
<li><strong><a name="00387" href="msg00387.html">Re: [sundials-users] memory leaks</a></strong>
<ul><li><em>From:</em> Adrian Dietz &lt;adrian.dietz@gmail.com&gt;</li></ul></li>
<li><strong><a name="00388" href="msg00388.html">Re: [sundials-users] memory leaks</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00390.html">Re: [sundials-users] Offline Manipulation of y values</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00392.html">[sundials-users] interpolation</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00388.html">Re: [sundials-users] memory leaks</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00394.html">Re: [sundials-users] memory leaks</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00391">
<strong>Main</strong></a></li>
<li><a href="threads.html#00391">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
