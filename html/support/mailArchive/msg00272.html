<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Finite difference Jacobian &#45; information to f() when Jacobian is built -->
<!--X-From-R13: Dnqh Ereona <freona1Nyyay.tbi> -->
<!--X-Date: Fri, 27 Jan 2006 10:05:32 &#45;0800 (PST) -->
<!--X-Message-Id: 43DA607A.2060203@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: op.s31ptsr2t8lo91@smtp.kuleuven.ac.be -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Finite difference Jacobian - information to f() when Jacobian is built</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00271.html">Date Prev</a>] [<a href="msg00273.html">Date Next</a>] [<a href="msg00273.html">Thread Prev</a>] [Thread Next]<br>
[<b><a href="maillist.html#00272">Date Index</a></b>]
[<b><a href="threads.html#00272">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Finite difference Jacobian - information to f() when Jacobian is built</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:serban1%40llnl.gov">serban1@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Fri, 27 Jan 2006 10:03:38 -0800</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Andreas Nicolai wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi there,</pre><br>
here's another feature request for CVODE. It might be nice to find out 
from within f() whether the Jacobian-Difference-Quotient algorithm is 
currently running?<br>
<br>
My algorithm in the f() function is kind of heavy on lengthy and since 
my Jacobian would not need to be soo accurate, I'd rather skip some 
iterations inside my f() function, when it is used to generate the 
Jacobian. Right now I set a flag before I call CVBandDQJac() and clear 
it when I leave the function. Checking that flag I can simplify and 
speed up the f() function execution quite a bit. Especially for large 
2D/3D systems this makes quite a difference.<br>
<br>
It would be nice to have that as a standard feature in CVODE. However, I 
would rate it as low priority...<br>
<br>
<pre style="margin: 0em;">Andreas</pre><br>
</blockquote><pre style="margin: 0em;"><br>Andreas,</pre><br>
This would require unnecessarily changing the function type CVRhsFn. The internal DQ Jacobian 
approximation is provided as a default and is one of several possibilities. It just happens to 
estimate a Jacobian approximation with first-order forward difference quotient approximations using 
the 'full' right-hand side function. This is why we allow for a user-supplied Jacobian approximation 
function.<br>
<br>
I suggest you provide your own Jacobian function written based on the internal DQ function (it 
should take you about 5 minutes to write it):<br>
<br>
<pre style="margin: 0em;">Copy CVBandDQJac() from cvband.c to my_BandDQJac() and make the following 
modifications:
1) cast jac_data to your data type (a structure 'my_data' containing the field 
flag initially=1)
2) set the flag on 0 at the beginning and remember to set it back on 1 before 
returning
3) get the current step size (h) using CVodeGetCurrentStep()
4) get the error weights (ewt) using CVodeGetErrWeights()
5) set uround=UNIT_ROUNDOFF (defined in sundialstypes.h)
6) change the call to f() to call your right-hand side function with jac_data 
as the last argument.
7) remove the line 'nfeB += ngroups'</pre><br>
Make sure f_data (passed to the rhs function) and jac_data (passed to the band Jacobian function) 
are the same. In the main program, call<br>
<br>
<pre style="margin: 0em;">  CVodeSetFdata(cvode_mem, my_data);
  CVBandSetJacFn(cvode_mem, my_BandDQJac, my_data);</pre><br>
and in the right-hand side function, use the flag from my_data to include all terms if flag=1 and 
discard them if flag=0.<br>
<br>
The exact same thing can be done for a dense DQ Jacobian approximation or for the DQ-based 
approximation for Jacobian*vector for the iterative linear solvers.<br>
<br>
<pre style="margin: 0em;">Hope that this helps,
--Radu</pre><br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00270" href="msg00270.html">[sundials-users] Finite difference Jacobian - information to f() when Jacobian is built</a></strong>
<ul><li><em>From:</em> Andreas Nicolai &lt;Andreas.Nicolai@gmx.net&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00271.html">R: [sundials-users] Finite difference Jacobian - information to f() when Jacobian is built</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00273.html">Re: R: [sundials-users] Finite difference Jacobian - information to f() when Jacobian is built</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00273.html">Re: R: [sundials-users] Finite difference Jacobian - information to f() when Jacobian is built</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00272">
<strong>Main</strong></a></li>
<li><a href="threads.html#00272">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
