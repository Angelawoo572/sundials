<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] coordinate projection with CVODE -->
<!--X-From-R13: Dnqh Ereona <freona1Nyyay.tbi> -->
<!--X-Date: Tue, 11 Apr 2006 10:10:12 &#45;0700 (PDT) -->
<!--X-Message-Id: 443BE263.3050609@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 003a01c65c4d$331f3c00$6601a8c0@ShermsNotebook -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] coordinate projection with CVODE</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00426.html">Date Prev</a>] [<a href="msg00428.html">Date Next</a>] [<a href="msg00421.html">Thread Prev</a>] [<a href="msg00430.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00427">Date Index</a></b>]
[<b><a href="threads.html#00427">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] coordinate projection with CVODE</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:serban1%40llnl.gov">serban1@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Tue, 11 Apr 2006 10:07:47 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Sherm,</pre><br>
The short answer is no, you cannot use coordinate projection without modifying CVODE (probably quite substantially). From this point of 
view, CVODE is really the same as &quot;DASSL in ODE mode&quot;. With any adaptive multistep integrator, you need to basically replace the underlying 
nonlinear solver so that the Nordsieck history array contains projected values from past timesteps. We have been thinking of ways of 
&quot;decoupling&quot; the nonlinear solver, as we do with the linear solvers, in the SUNDIALS solvers (which would allow the user to provide their 
own), but that is no easy task.<br>
<br>
In any case (as you have experienced with DASSL), it is non-trivial to implement the explicit projection that you describe in any BDF solver 
with order and stepsize control. However, your problem is not a generic ODE with invariants, but rather an index-3 DAE of multibody rigid 
dynamics, so you can take advantage of that. My suggestion is to use a different formulation - stabilized index-2 (or Gear-Gupta-Leimkuhler) 
- that contains implicitly the projection on the constraint manifold. The resulting index-2 DAE can then be solved robustly and efficiently 
with a BDF solver (you'll need the IDA solver though). Granted, in this formulation, the problem size is increased with additional Lagrange 
multipliers, but that should be no major show-stopper in your case since, as you indicate, your problems have a modest number of constraints.<br>
<br>
Is there any reason why you do not want to use the stabilized index-2 formulation? I'm not sure if SimTK can directly provide the constraint 
Jacobian needed to put together the additional correction term, but even if it cannot, an approximation to this Jacobian can be extracted 
from the DAE Jacobian used in IDA.<br>
<br>
Since we are having this discussion on the sundials-users forum and I'm not sure how many of our users are familiar with multibody dynamics, 
to allow everybody to follow this, I gave the actual index-3 DAE for multibody dynamics below.<br>
<br>
<pre style="margin: 0em;">--Radu</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<br>If q are (any) generalized coordinates constrained by g(q)=0 (your equation 2 below where, for simplicity, I only consider scleronomic 
constraints; i.e. no explicit time dependence), and v=q' are the generalized velocities, then the index-3 DAEs are<br>
<br>
<pre style="margin: 0em;">(1)   Mq'' = f(t,q,q') - G^T * l
(2)   0 = g(q)</pre><br>
<pre style="margin: 0em;">or, in first order form</pre><br>
<pre style="margin: 0em;">(1')   q' = v
(1'')  Mv' = f(t,q,v) - G^T * l
(2)    0 = g(q)</pre><br>
where G is the Jacobian of the constraints g, G^T is its transpose, and l is a vector of Lagrange multipliers. M is a generalized mass 
matrix (usually non-singular, in particular when using relative coordinates as you do) and f is a vector of generalized external forces. 
G^T*l represent constraint forces; i.e. the forces that restrict the system to evolve on the manifold defined by g.<br>
<br>
<pre style="margin: 0em;">Taking successive differentiations of the algebraic constraint equations 
0=g(q), we get the so-called hidden constraints, namely</pre><br>
<pre style="margin: 0em;">velocity constraint:     (3)  0 = G * v
acceleration constraint: (4)  0 = G * v' + v^T * G_q * v</pre><br>
<pre style="margin: 0em;">where G_q is a tensor (G_q=d2g/dq2).</pre><br>
If G has full rank (i.e. there are no redundant constraints), one can solve Eqs. (1)+(4) for the Lagrange multipliers l and substitute them 
back into (1) to obtain your first equation below.<br>
<br>
The stabilized index-2 formulation considers the position and velocity constraints (2) and (3) simultaneously and includes a correction term 
at the velocity level (in terms of additional Lagrange multipliers - m), resulting in the following index-2 DAE:<br>
<br>
<pre style="margin: 0em;">  q' = v - G^T * m
  Mv' = f(t,q,v) - G^T * l
  0 = g(q)
  0 = G * v</pre><br>
This system can be solved directly by IDA. Note that the correction term vanishes identically for the analytical solution (m=0) and remains 
of the size of the prescribed tolerances for the numerical solution.<br>
<br>
<pre style="margin: 0em;"><br></pre><br>
Michael Sherman wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">We are trying in SimTK to solve biomechanics and molecular dynamics problems<br>
using relative coordinate rigid body mechanics with algebraic constraints.<br>
(As we discussed when you were here, Radu.) These problems have a large<br>
number of joint-connected rigid bodies (&gt;1000) with a modest number of<br>
constraints (&lt;100), and are often stiff. <br>
<br>
Over many years I have tried most of the methods in the literature and by<br>
far prefer a formulation in which the acceleration constraints are solved<br>
directly, and coordinate projection is used to keep the positions (&quot;q&quot;<br>
below) and velocities hugging their constraint manifolds. Then the equations<br>
look like this:<br>
    
    (1) q''       = f(t,q,q')<br>
    (2) p(t,q)    = 0<br>
    (3) v(t,q,q') = 0<br>
<br>
<pre style="margin: 0em;">The coordinate projection integration step procedure is:
    1 advance the ODE (1) by a single error-controlled step
    2 project q onto position constraint manifold using (2)
    3 project q' onto velocity constraint manifold using (3)
    4 the new (q,q') is the end-of-step result
    5 final value of the derivative is f(t+h,q,q')
As long as the projections are done normal to the manifolds, this is
guaranteed not to damage the solution accuracy, and usually improves it. It
is a very nice method in practice.</pre><br>
We would like to use CVODE as the ODE solver for step 1. It is very easy to<br>
use this procedure with one-step ODE methods (I've used Radau5, e.g.), but<br>
it is trickier with multistep methods because the solution adjustment and<br>
new derivative needs to be recorded properly in the internal data structure.<br>
I have done this successfully with BDF (specifically DASSL in ODE mode) but<br>
had to hack it up quite a lot (with Linda's help). I would much prefer to<br>
use CVODE as a black box. <br>
<br>
<pre style="margin: 0em;">Is there a reasonable way to use CVODE in a coordinate projection scheme?</pre><br>
Thanks and best regards,<br>
Sherm <br>
<br>
<pre style="margin: 0em;"><br></pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">--
   Radu Serban
   Center for Applied Scientific Computing   [email] radu@llnl.gov
   Lawrence Livermore National Laboratory    [phone] 925-424-4852
   P.O. Box 808, L-560                       [fax]   925-422-6287
   Livermore, CA 94551</pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00430" href="msg00430.html">RE: [sundials-users] coordinate projection with CVODE</a></strong>
<ul><li><em>From:</em> Michael Sherman &lt;msherman@stanford.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00421" href="msg00421.html">[sundials-users] coordinate projection with CVODE</a></strong>
<ul><li><em>From:</em> Michael Sherman &lt;msherman@stanford.edu&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00426.html">Re: [sundials-users] Arbitrary precision for sundials solvers?</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00428.html">Re: [sundials-users] Arbitrary precision for sundials solvers?</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00421.html">[sundials-users] coordinate projection with CVODE</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00430.html">RE: [sundials-users] coordinate projection with CVODE</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00427">
<strong>Main</strong></a></li>
<li><a href="threads.html#00427">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
