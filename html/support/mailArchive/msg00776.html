<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Compiling ODE with very long equations -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Mon, 20 Nov 2006 09:49:36 &#45;0800 -->
<!--X-Message-Id: 4561EA66.10101@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20061114_100545_089554.ronanrmo@ig.com.br -->
<!--X-Reference: 4561D986.5060703@ineti.pt -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Compiling ODE with very long equations</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00773.html">Date Prev</a>] [<a href="msg00777.html">Date Next</a>] [<a href="msg00773.html">Thread Prev</a>] [<a href="msg00781.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00776">Date Index</a></b>]
[<b><a href="threads.html#00776">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Compiling ODE with very long equations</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Mon, 20 Nov 2006 09:48:22 -0800</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<tt>Mario Amaral wrote:
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hello,</pre><br>
<tt>I am trying to integrate an ODE system which contains equations with 
very long lines. These lines are generated by a computer algebra system 
(in this case MAPLE) and are contained inside the right hand side 
c-function which is passed to CVodeMalloc(). A short excerpt of this 
function would be:</tt><br>
<br>
<tt><br>int f (realtype t, N_Vector Y, N_Vector YP, void *fdata)<br>
{<br>
  // SOME MORE LINES<br>
 Ith(YP,6) = 0.1372839770e4 * Ith(Y,3) * Ith(Y,2) + 0.3095498663e1 * 
Ith(Y,0) - 0.1248421244e2 * Ith(Y,1) + 0.9265765425e1 * Ith(Y,2) - 
0.2329514029e3 * Ith(Y,5) * Ith(Y,1) + 0.1363937665e3 * Ith(Y,4) * 
Ith(Y,1) + 0.3151834803e2 * Ith(Y,5) * Ith(Y,0) - 0.1149007874e0 * 
Ith(Y,6) + 0.5860802032e-1 * Ith(Y,7) - 0.9275092096e-2 * Ith(Y,8) + 
0.3742151646e-3 * Ith(Y,12) - 0.1162223907e-2 * Ith(Y,13) + 
0.2613134199e-3 * Ith(Y,14) + 0.1599767108e3 * Ith(Y,4) * Ith(Y,2) - 
0.6524989577e0 * Ith(Y,3) * Ith(Y,1) + 0.1385735430e4 * Ith(Y,6) * 
Ith(Y,5) - 0.2145024290e3 * Ith(Y,4) * Ith(Y,0) - 0.4600666339e3 * 
Ith(Y,3) * Ith(Y,0) + 0.5015842973e3 * Ith(Y,8) * Ith(Y,5) + 
0.7773471676e2 * Ith(Y,7) * Ith(Y,5) - 0.2322390252e3 * Ith(Y,8) * 
Ith(Y,4) + 0.1355981678e3 * Ith(Y,7) * Ith(Y,4) + 0.6707112518e2 * 
Ith(Y,6) * Ith(Y,4) - 0.1491603563e3 * Ith(Y,7) * Ith(Y,3) + 
0.1094689093e3 * Ith(Y,8) * Ith(Y,3) - 0.5564373132e3 * Ith(Y,6) * 
Ith(Y,3) + 0.4686469056e3 * Ith(Y,5) * Ith(Y,2);<br>
 //SOME MORE LINES<br>
 return(0);<br>
}</tt><br>
<br>
<tt>In the example I chose a small line, but they can contain up to 25000 
characteres.</tt><br>
<br>
<tt>What happens is that the c compiler (gcc 4.1) takes a lot of time 
compiling and if the lines are really huge it returns an error saying 
something about stack overflow or something alike.  I suppose the 
parsing is done line by line and when the line buffer is full it can't 
process anymore.</tt><br>
<br>
<tt>Can some one indicate me a more efficient (and smaller) way to store 
information about large ODE systems like this?<br>
I thought about using a fdata structure to store data, but I can't think 
of a good way to organize data in it.</tt><br>
<br>
<pre style="margin: 0em;">Thank you.</pre><br>
<pre style="margin: 0em;">Mario Amaral.</pre><br>
</blockquote><pre style="margin: 0em;"><br>Mario,</pre><br>
<tt>First of all, if you use the Ith macro from the CVODE examples, beware that it 
is 1-based (and not 0-based). The NV_Ith_S macro on which Ith is based and which 
is defined in nvector_serial.h is 0-based.</tt><br>
<br>
<tt>In any case, you should change the code generation Maple function so that it 
does NOT use the Ith macro in the generated code. This macro should be used only 
with small-size problems (such as the examples provided with CVODE):<br>
-  On one hand, this will considerably reduce the length of your lines since all 
macros are expanded by the C preprocessor. Since the macro Ith is based on the 
macro NV_Ith_S which is based on the macro NV_DATA_S which is based on the macro 
NV_CONTENT_S, an instance such as &quot;Ith(Y,3)&quot; in a line of your code will be 
expanded to: &quot;( ( ( (N_VectorContent_Serial)(Y-&gt;content) )(v)-&gt;data )(v)[3-1] 
)&quot;. In other words, 8 characters are replaced by 65 characters!<br>
- Moreover, except for small problems, using the macros is also inefficient ,as 
each instance of Ith in your code will involve a typecast and a subtraction.</tt><br>
<br>
<tt>Instead, generate the right-hand side functions such that you first get a 
pointer to the data arrays of the Y and YP N_Vector (using either the macro 
NV_DATA_S or the function N_VGetArrayPointer_Serial) and then use those as you 
would any C arrays. In other words, the example above should be as follows:</tt><br>
<br>
<pre style="margin: 0em;">int f (realtype t, N_Vector Y, N_Vector YP, void *fdata)
{
realtype *Yd, *YPd;</pre><br>
<pre style="margin: 0em;">// Get data array for the Y and YP vectors.
// Use Yd and YPd as you would any C arrays (0-based)</pre><br>
<pre style="margin: 0em;">Yd = N_VGetArrayPointer_Serial(Y);
YPd = N_VGetArrayPointer_Serial(YP);</pre><br>
<pre style="margin: 0em;"> // SOME MORE LINES
YPd[6] = 0.1372839770e4 * Y[3] * Y[2] + 0.3095498663e1 *
Y[0] - 0.1248421244e2 * Y[1] + 0.9265765425e1 * Y[2] -
0.2329514029e3 * Y[5] * Y[1] + 0.1363937665e3 * Y[4] *
Y[1] + 0.3151834803e2 * Y[5] * Y[0] - 0.1149007874e0 *
Y[6] + 0.5860802032e-1 * Y[7] - 0.9275092096e-2 * Y[8] +
0.3742151646e-3 * Y[12] - 0.1162223907e-2 * Y[13] +
0.2613134199e-3 * Y[14] + 0.1599767108e3 * Y[4] * Y[2] -
0.6524989577e0 * Y[3] * Y[1] + 0.1385735430e4 * Y[6] *
Y[5] - 0.2145024290e3 * Y[4] * Y[0] - 0.4600666339e3 *
Y[3] * Y[0] + 0.5015842973e3 * Y[8] * Y[5] +
0.7773471676e2 * Y[7] * Y[5] - 0.2322390252e3 * Y[8] *
Y[4] + 0.1355981678e3 * Y[7] * Y[4] + 0.6707112518e2 *
Y[6] * Y[4] - 0.1491603563e3 * Y[7] * Y[3] +
0.1094689093e3 * Y[8] * Y[3] - 0.5564373132e3 * Y[6] *
Y[3] + 0.4686469056e3 * Y[5] * Y[2];
//SOME MORE LINES
return(0);
}</pre><br>
<tt>Of course, if this is still does not shorten the lines enough for the compiler, 
you may want to consider changing your Maple function to generate code that uses 
some temporary variables.</tt><br>
<br>
<pre style="margin: 0em;">Hope that this helps,</pre><br>
<pre style="margin: 0em;">--Radu</pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00781" href="msg00781.html">Re: [sundials-users] Compiling ODE with very long equations</a></strong>
<ul><li><em>From:</em> Mario Amaral &lt;mario.amaral@ineti.pt&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00770" href="msg00770.html">[sundials-users] Setting Dependent Variables without reinit</a></strong>
<ul><li><em>From:</em> ronanrmo &lt;ronanrmo@ig.com.br&gt;</li></ul></li>
<li><strong><a name="00773" href="msg00773.html">[sundials-users] Compiling ODE with very long equations</a></strong>
<ul><li><em>From:</em> Mario Amaral &lt;mario.amaral@ineti.pt&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00773.html">[sundials-users] Compiling ODE with very long equations</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00777.html">[sundials-users] Missing files in sundialsTB</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00773.html">[sundials-users] Compiling ODE with very long equations</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00781.html">Re: [sundials-users] Compiling ODE with very long equations</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00776">
<strong>Main</strong></a></li>
<li><a href="threads.html#00776">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
