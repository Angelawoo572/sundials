<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] slow convergence with IDABand -->
<!--X-From-R13: [vpunry Arireznaa <zvpunry.brireznaaNgh&#45;oreyva.qr> -->
<!--X-Date: Tue, 01 Aug 2006 12:21:45 &#45;0700 -->
<!--X-Message-Id: 44CFA8D3.2090802@tu&#45;berlin.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 44CF2DAA.2010707@tu&#45;berlin.de -->
<!--X-Reference: 44CF66DD.4050908@llnl.gov -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] slow convergence with IDABand</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00599.html">Date Prev</a>] [<a href="msg00601.html">Date Next</a>] [<a href="msg00599.html">Thread Prev</a>] [<a href="msg00602.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00600">Date Index</a></b>]
[<b><a href="threads.html#00600">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] slow convergence with IDABand</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Michael Oevermann &lt;<a href="mailto:michael.oevermann%40tu-berlin.de">michael.oevermann@tu-berlin.de</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Tue, 01 Aug 2006 21:17:39 +0200</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Radu,</pre><br>
<tt>thanks for your message. And yes, there was a bug in my Jacobian 
function. Just an<br>
index bug messing up the bandwidth.<br>
Thanks again and I apologize for  any inconvenience I caused!</tt><br>
<br>
<pre style="margin: 0em;">Best regards from Berlin</pre><br>
<pre style="margin: 0em;">Michael</pre><br>
<pre style="margin: 0em;">Radu Serban wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi Michael,</pre><br>
<tt>You must have some bug in your code.<br>
1) Are you solving the two cases in the same program? If yes, do you 
properly reinitialize the solver before the second run?<br>
2) Are you providing the Jacobian functions? If so, have you checked 
they are correctly implemented?</tt><br>
<br>
<tt>I have quickly coded something similar and everything works fine for 
me. I modified the CVODES cvsdenx code (Richardson's problem) to solve 
multiple copies of the same system, both with the dense solver and 
with the band solver (with bandwidths equal to NEQ-1, where NEQ=3 is 
the original problem size). The results are shown below.</tt><br>
<br>
<tt>I attached the cvsrichardsonx.c code. Note that it uses the CVODES 
libraries. To use it with CVODE, just replace the appropriate header 
files at the top of the file.</tt><br>
<br>
<pre style="margin: 0em;">--Radu</pre><br>
<pre style="margin: 0em;">3-species kinetics problem (4 copies) - DENSE linear solver</pre><br>
<pre style="margin: 0em;">At t = 4.0000e-01      y =  9.851641e-01    3.386242e-05    1.480205e-02
At t = 4.0000e+00      y =  9.055097e-01    2.240338e-05    9.446793e-02
At t = 4.0000e+01      y =  7.158009e-01    9.185093e-06    2.841899e-01
At t = 4.0000e+02      y =  4.504994e-01    3.222704e-06    5.494973e-01
At t = 4.0000e+03      y =  1.832044e-01    8.942779e-07    8.167947e-01
At t = 4.0000e+04      y =  3.899513e-02    1.622265e-07    9.610047e-01
At t = 4.0000e+05      y =  4.936157e-03    1.984099e-08    9.950638e-01
At t = 4.0000e+06      y =  5.168162e-04    2.068322e-09    9.994832e-01
At t = 4.0000e+07      y =  5.204751e-05    2.082008e-10    9.999480e-01
At t = 4.0000e+08      y =  5.192935e-06    2.077185e-11    9.999948e-01
At t = 4.0000e+09      y =  5.199724e-07    2.079890e-12    9.999995e-01
At t = 4.0000e+10      y =  6.546306e-08    2.618523e-13    9.999999e-01</pre><br>
<pre style="margin: 0em;">Final Statistics:
nst = 605    nfe  = 881    nsetups = 117    nfeLS = 144    nje = 12
nni = 877    ncfn = 0      netf = 32</pre><br>
<pre style="margin: 0em;"><br>3-species kinetics problem (4 copies) - BAND linear solver</pre><br>
<pre style="margin: 0em;">At t = 4.0000e-01      y =  9.851641e-01    3.386242e-05    1.480205e-02
At t = 4.0000e+00      y =  9.055097e-01    2.240338e-05    9.446793e-02
At t = 4.0000e+01      y =  7.158009e-01    9.185093e-06    2.841899e-01
At t = 4.0000e+02      y =  4.504994e-01    3.222704e-06    5.494973e-01
At t = 4.0000e+03      y =  1.832044e-01    8.942779e-07    8.167947e-01
At t = 4.0000e+04      y =  3.898936e-02    1.622028e-07    9.610105e-01
At t = 4.0000e+05      y =  4.937780e-03    1.984840e-08    9.950622e-01
At t = 4.0000e+06      y =  5.169572e-04    2.068880e-09    9.994830e-01
At t = 4.0000e+07      y =  5.206041e-05    2.082523e-10    9.999479e-01
At t = 4.0000e+08      y =  5.201572e-06    2.080639e-11    9.999948e-01
At t = 4.0000e+09      y =  5.228252e-07    2.091302e-12    9.999995e-01
At t = 4.0000e+10      y =  7.616506e-08    3.046603e-13    9.999999e-01</pre><br>
<pre style="margin: 0em;">Final Statistics:
nst = 616    nfe  = 934    nsetups = 142    nfeLS = 60     nje = 12
nni = 930    ncfn = 0      netf = 47</pre><br>
<pre style="margin: 0em;"><br>Michael Oevermann wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Dear sundials users,</pre><br>
<tt>I am having some performance problems/questions with the IDABand 
linear solver.<br>
I'm trying to solve some chemical reaction equations which works just 
fine<br>
with the dense solver. Just for testing, I have simply multiplied the 
set of equations.<br>
Lets say I have initially  ns equations and by multiplying n timesI 
have now n*ns equations.<br>
By just copying the equations the bandwidth should be  exactly ns-1.<br>
The Dense solver still works very fine, but with the IDABand solver I 
observe the following<br>
performance:</tt><br>
<br>
<tt>IDABand(mem,  n*ns, n*ns-1, n*ns-1) -&gt; more or less identical 
behaviour to the dense solver as<br>
                                                                  
expected</tt><br>
<br>
<tt>IDABand(mem, n*ns, ns-1, ns-1) -&gt; much slower convergence with lots 
of messages like:</tt><br>
<br>
<pre style="margin: 0em;"> At t = 0.000194651, , mxstep steps taken before reaching tout.</pre><br>
<tt>Changing the bandwidth slightly (e.g. 2*ns) doesn't make a difference.<br>
What is going on here? Why does the banded solver behave differently 
than the dense<br>
solver, although the problem as I set it up is strictly banded?</tt><br>
<br>
<pre style="margin: 0em;">Thanks for any hints and help!</pre><br>
<pre style="margin: 0em;">Michael</pre><br>
</blockquote><pre style="margin: 0em;">------------------------------------------------------------------------</pre><br>
<tt>/*<br>
* -----------------------------------------------------------------<br>
* $Revision: 1.1 $<br>
* $Date: 2006-09-19 16:46:09 $<br>
* -----------------------------------------------------------------<br>
* Programmer(s): Radu Serban @ LLNL<br>
* -----------------------------------------------------------------<br>
* Example problem:<br>
* 
* Solve NC copies of Richardson's ODEs, first using the dense<br>
* linear solver, then using the band linear solver.<br>
* -----------------------------------------------------------------<br>
*/</tt><br>
<br>
<pre style="margin: 0em;">#include &lt;stdio.h&gt;
#include &lt;cvodes/cvodes.h&gt;
#include &lt;cvodes/cvodes_dense.h&gt;
#include &lt;cvodes/cvodes_band.h&gt;
#include &lt;nvector/nvector_serial.h&gt;</pre><br>
<pre style="margin: 0em;">/* Problem Constants */</pre><br>
<pre style="margin: 0em;">#define NC    4</pre><br>
<pre style="margin: 0em;">#define NEQ   3                /* number of equations  */
#define Y1    RCONST(1.0)      /* initial y components */
#define Y2    RCONST(0.0)
#define Y3    RCONST(0.0)
#define RTOL  RCONST(1.0e-4)   /* scalar relative tolerance            */
#define ATOL1 RCONST(1.0e-8)   /* vector absolute tolerance components */
#define ATOL2 RCONST(1.0e-14)
#define ATOL3 RCONST(1.0e-6)
#define T0    RCONST(0.0)      /* initial time           */
#define T1    RCONST(0.4)      /* first output time      */
#define TMULT RCONST(10.0)     /* output time factor     */
#define NOUT  12               /* number of output times */</pre><br>
<pre style="margin: 0em;">static int f1(realtype *y, realtype *yd);
static int f(realtype t, N_Vector y, N_Vector yd, void *f_data);
static void PrintOutput(realtype t, realtype y1, realtype y2, realtype y3);
static void PrintFinalStats(void *cvode_mem, int ls);</pre><br>
<pre style="margin: 0em;">/*
*-------------------------------
* Main Program
*-------------------------------
*/</pre><br>
<pre style="margin: 0em;">int main()
{
 realtype reltol, t, tout;
 N_Vector y0, y, abstol;
 void *cvode_mem;
 int i, flag, iout;</pre><br>
<tt> /* Create serial vectors of length NC*NEQ for I.C., solution, and abstol */<br>
 y0 = N_VNew_Serial(NC*NEQ);<br>
 y = N_VNew_Serial(NC*NEQ);<br>
 abstol = N_VNew_Serial(NC*NEQ); </tt><br>
<br>
<pre style="margin: 0em;"> /* Initialize y0 */
 for(i=0; i&lt;NC; i++) {
   NV_Ith_S(y0,i*NEQ  ) = Y1;
   NV_Ith_S(y0,i*NEQ+1) = Y2;
   NV_Ith_S(y0,i*NEQ+2) = Y3;
 }</pre><br>
<pre style="margin: 0em;"> /* Set the scalar relative tolerance */
 reltol = RTOL;
 /* Set the vector absolute tolerance */
 for(i=0; i&lt;NC; i++) {
   NV_Ith_S(abstol,i*NEQ ) = ATOL1;
   NV_Ith_S(abstol,i*NEQ+1) = ATOL2;
   NV_Ith_S(abstol,i*NEQ+2) = ATOL3;
 }</pre><br>
<pre style="margin: 0em;"> /* Call CVodeCreate and CVodeMalloc */
 cvode_mem = CVodeCreate(CV_BDF, CV_NEWTON);
 flag = CVodeMalloc(cvode_mem, f, T0, y0, CV_SV, reltol, abstol);</pre><br>
<pre style="margin: 0em;"> /* Attach dense (use DQ Jacobian) */
 flag = CVDense(cvode_mem, NC*NEQ);</pre><br>
<pre style="margin: 0em;"> /* In loop, call CVode, print results, and test for error.*/
 printf(&quot; \n3-species kinetics problem (%d copies) - DENSE linear 
solver\n\n&quot;,NC);
 for(iout=0, tout=T1; iout&lt;NOUT; iout++, tout*=TMULT) {
   flag = CVode(cvode_mem, tout, y, &amp;t, CV_NORMAL);
   PrintOutput(t, NV_Ith_S(y,0), NV_Ith_S(y,1), NV_Ith_S(y,2));
 }
 PrintFinalStats(cvode_mem, 0);</pre><br>
<tt> /* Reinitialize problem */<br>
 flag = CVodeReInit(cvode_mem, f, T0, y0, CV_SV, reltol, abstol);<br>
 
 /* Attach band linear solver (use DQ Jacobian) */<br>
 flag = CVBand(cvode_mem, NC*NEQ, NEQ-1, NEQ-1);</tt><br>
<br>
<pre style="margin: 0em;"> /* In loop, call CVode, print results, and test for error.*/
 printf(&quot; \n3-species kinetics problem (%d copies) - BAND linear 
solver\n\n&quot;,NC);
 for(iout=0, tout=T1; iout&lt;NOUT; iout++, tout*=TMULT) {
   flag = CVode(cvode_mem, tout, y, &amp;t, CV_NORMAL);
   PrintOutput(t, NV_Ith_S(y,0), NV_Ith_S(y,1), NV_Ith_S(y,2));
 }
 PrintFinalStats(cvode_mem, 1);</pre><br>
<pre style="margin: 0em;"> /* Free memory */
 N_VDestroy_Serial(y0);
 N_VDestroy_Serial(y);
 N_VDestroy_Serial(abstol);
 CVodeFree(&amp;cvode_mem);</pre><br>
<pre style="margin: 0em;"> return(0);
}</pre><br>
<pre style="margin: 0em;">static int f(realtype t, N_Vector y, N_Vector yd, void *f_data)
{
 realtype *y_data, *yd_data;
 int i;</pre><br>
<pre style="margin: 0em;"> y_data = NV_DATA_S(y);
 yd_data = NV_DATA_S(yd);</pre><br>
<pre style="margin: 0em;"> for(i=0; i&lt;NC; i++) {
   f1(&amp;(y_data[i*NEQ]), &amp;(yd_data[i*NEQ]));
 }</pre><br>
<pre style="margin: 0em;"> return(0);
}</pre><br>
<pre style="margin: 0em;">static int f1(realtype *y, realtype *yd)
{
 yd[0] =  RCONST(-0.04)*y[0] + RCONST(1.0e4)*y[1]*y[2];
 yd[2] =  RCONST(3.0e7)*y[1]*y[1];
 yd[1] =  -yd[0]-yd[2];
 return(0);
}</pre><br>
<pre style="margin: 0em;">static void PrintOutput(realtype t, realtype y1, realtype y2, realtype y3)
{
 printf(&quot;At t = %0.4le      y =%14.6le  %14.6le  %14.6le\n&quot;, t, y1, y2, y3);
 return;
}</pre><br>
<pre style="margin: 0em;">static void PrintFinalStats(void *cvode_mem, int ls)
{
 long int nst, nfe, nsetups, nje, nfeLS, nni, ncfn, netf;
 int flag;</pre><br>
<pre style="margin: 0em;"> flag = CVodeGetNumSteps(cvode_mem, &amp;nst);
 flag = CVodeGetNumRhsEvals(cvode_mem, &amp;nfe);
 flag = CVodeGetNumLinSolvSetups(cvode_mem, &amp;nsetups);
 flag = CVodeGetNumErrTestFails(cvode_mem, &amp;netf);
 flag = CVodeGetNumNonlinSolvIters(cvode_mem, &amp;nni);
 flag = CVodeGetNumNonlinSolvConvFails(cvode_mem, &amp;ncfn);</pre><br>
<pre style="margin: 0em;"> if(ls==0) {
   flag = CVDenseGetNumJacEvals(cvode_mem, &amp;nje);
   flag = CVDenseGetNumRhsEvals(cvode_mem, &amp;nfeLS);
 }</pre><br>
<tt> if(ls==1) {<br>
   flag = CVBandGetNumJacEvals(cvode_mem, &amp;nje);<br>
   flag = CVBandGetNumRhsEvals(cvode_mem, &amp;nfeLS);<br>
 }<br>
   
 printf(&quot;\nFinal Statistics:\n&quot;);<br>
 printf(&quot;nst = %-6ld nfe  = %-6ld nsetups = %-6ld nfeLS = %-6ld nje = %ld\n&quot;,<br>
	 nst, nfe, nsetups, nfeLS, nje);<br>
 printf(&quot;nni = %-6ld ncfn = %-6ld netf = %-6ld\n \n&quot;,<br>
	 nni, ncfn, netf);</tt><br>
<br>
<pre style="margin: 0em;">}</pre><br>
<tt> </tt><br>
<br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00598" href="msg00598.html">[sundials-users] slow convergence with IDABand</a></strong>
<ul><li><em>From:</em> Michael Oevermann &lt;michael.oevermann@tu-berlin.de&gt;</li></ul></li>
<li><strong><a name="00599" href="msg00599.html">Re: [sundials-users] slow convergence with IDABand</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;radu@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00599.html">Re: [sundials-users] slow convergence with IDABand</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00601.html">Re: [sundials-users] using sundials for ill-conditioned problem</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00599.html">Re: [sundials-users] slow convergence with IDABand</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00602.html">[sundials-users] How to compile the libs 'libsundialsXXX.l ib' with '/clr' support?</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00600">
<strong>Main</strong></a></li>
<li><a href="threads.html#00600">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
