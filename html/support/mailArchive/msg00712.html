<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: Re&#45;4: [sundials&#45;users] performance for chemical kinetic problems -->
<!--X-From-R13: Oyna Vvaqznefu <nynauNyyay.tbi> -->
<!--X-Date: Wed, 27 Sep 2006 16:16:19 &#45;0700 -->
<!--X-Message-Id: Pine.LNX.4.58.0609271610271.16395@tux64.llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: Pine.LNX.4.58.0609201521260.28545@tux64.llnl.gov -->
<!--X-Reference: 4511C60E.3000405@uni&#45;bielefeld.de -->
<!--X-Reference: Pine.LNX.4.58.0609271401190.16395@tux64.llnl.gov -->
<!--X-Reference: 451AF248.3060208@uni&#45;bielefeld.de -->
<!--X-Head-End-->
<html>
<head>
<title>Re: Re-4: [sundials-users] performance for chemical kinetic problems</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00711.html">Date Prev</a>] [<a href="msg00713.html">Date Next</a>] [<a href="msg00710.html">Thread Prev</a>] [<a href="msg00713.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00712">Date Index</a></b>]
[<b><a href="threads.html#00712">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: Re-4: [sundials-users] performance for chemical kinetic problems</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Alan Hindmarsh &lt;<a href="mailto:alanh%40llnl.gov">alanh@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Wed, 27 Sep 2006 16:13:54 -0700 (PDT)</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hello Michael,

I think I had completely misinterpreted your 4-step scheme, thinking
that each pass was one pulse.  Now I see differently.

Tell me if this right:  I gather that a pulse consists of a short
excitation interval, followed by a longer relaxation interval.  For
the short excitation interval of each pulse, you use the 4-step loop
to make CVODE hit each of a set of time points at which you have
stored values of a power profile. (You say &quot;tstop is the next
available sample of the pulse&quot;.)

This is the WRONG way to handle a data-defined right-hand side
function.  If k(t) is in part defined by stored sample power values,
you have to make sure that that power [hence k(t)] can be computed at
ANY given t as a continuous function.  That means fitting your
data-defined power values with a smooth fit function, and using that
when you compute k(t).  A simple piecewise linear fit would be
easiest, but a smoother (e.g. spline) fit would make the integration
more efficient.  If there is noise in the data, the fit should be a
least-squares fit instead of a straight interpolation.  When this is
done right, you will probably find that the number of time steps the
integrator needs is much less than the number of data points.

Because both the start and end of the short excitation interval is a
major discontinuity in the RHS function of the ODE system, both of
those points should be restart points for CVODE (using calls to
CVodeReInit after the very first excitiation).

If you set up the excitation integration this way, I doubt that the
solver will &quot;miss most of my pulse&quot;.  But if you want to guarantee
that CVODE samples the RHS at the end point of the excitation as well,
I suggest you use tstop to stop at that point (and then restart CVODE
to do the relaxation interval).

In general, the frequency at which Jacobian values are sampled by
CVODE is determined by how well its Newton-Krylov method is
working, and you should not have to force that frequency externally.
That is, if the Jacobian changes greatly (because of k(t) or whatever)
during a pulse, there will be convergence failures internally, which
will cause the CVODE to sample the Jacobian more frequently.

I hope this clarifies things.

-Alan H.



On Wed, 27 Sep 2006, Michael Letzgus wrote:

&gt;<i> Hi Alan.</i>
&gt;<i></i>
&gt;<i></i>
&gt;<i> Alan Hindmarsh schrieb:</i>
&gt;<i> &gt;</i>
&gt;<i> &gt; I'm not sure what step 1 here means.  If each pass through these steps</i>
&gt;<i> &gt; is a pulse, and the function k(t) is different for different pulses,</i>
&gt;<i> &gt; then you just need to be sure that you communicate to the RHS and</i>
&gt;<i> &gt; Jacobian functions what pulse is currently being computed.  You can do</i>
&gt;<i> &gt; that either with global variables or with the f_data pointer.</i>
&gt;<i></i>
&gt;<i> I'm simulating a multi-level spectroscopic system, and my pulse is an</i>
&gt;<i> excitation laser pulse applied to this system.</i>
&gt;<i> The laser pulse is short (~1E-12 sec) compared to the behavior of the</i>
&gt;<i> total system (~1E-7 sec).</i>
&gt;<i> I'm interested in what happens during the excitation and in the behavior</i>
&gt;<i> of the relaxation  process.</i>
&gt;<i></i>
&gt;<i> To do so, I have to multiply the excitation coefficients by the temporal</i>
&gt;<i> laser pulse shape. This laser pulse shape could be an analytic function,</i>
&gt;<i> but I also need a sampled (measured) pulse profile, so I have ~300</i>
&gt;<i> samples of laser power in time ( pulse(t) in my last post ).</i>
&gt;<i> To apply this pulse, I have to force the solver not to step over my</i>
&gt;<i> (short) pulse - this is the sequence 1-4:</i>
&gt;<i></i>
&gt;<i> 1) calculate excitation coefficients based on current laser power</i>
&gt;<i> 2) CVodesetstoptime(tstop);  // tstop is the next available sample of</i>
&gt;<i>    the pulse</i>
&gt;<i> 3) Cvode(...., CV_NORMAL_STOP);</i>
&gt;<i> 4) goto 1</i>
&gt;<i></i>
&gt;<i> &gt; Otherwise, your 4-step outline looks fine.  Jacobians should be</i>
&gt;<i> &gt; recomputed (or recalled from storage, depending on jok) within the</i>
&gt;<i> &gt; CVSpilsPrecSetupFn function when it is called.</i>
&gt;<i></i>
&gt;<i> Hm, I think this is only possible for me if I can force the solver to</i>
&gt;<i> call CVSpilsPrecSetupFn between t_pulsestart and t_pulseend several</i>
&gt;<i> times. Otherwise, the solver will miss most of my pulse.</i>
&gt;<i></i>
&gt;<i></i>
&gt;<i> My (block) diagonal approach works very well, the number of convergence</i>
&gt;<i> failures is now 0.</i>
&gt;<i></i>
&gt;<i> My earlier reported loss of performance when changing from diagonal</i>
&gt;<i> approach via block-diagonal to full preconditioning was a stupid &quot;flaw&quot;</i>
&gt;<i> in my matrix setup, I accidentally used J[i][j] - but it must be J[j][i].</i>
&gt;<i> I used a transposed jacobian as preconditioner which caused the loss in</i>
&gt;<i> performance.</i>
&gt;<i></i>
&gt;<i> Best regards,</i>
&gt;<i>  Michael</i>

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00713" href="msg00713.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
<ul><li><em>From:</em> Michael Letzgus &lt;michael.letzgus@uni-bielefeld.de&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00702" href="msg00702.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
<ul><li><em>From:</em> Alan Hindmarsh &lt;alanh@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00703" href="msg00703.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
<ul><li><em>From:</em> Michael Letzgus &lt;michael.letzgus@uni-bielefeld.de&gt;</li></ul></li>
<li><strong><a name="00709" href="msg00709.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
<ul><li><em>From:</em> Alan Hindmarsh &lt;alanh@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00710" href="msg00710.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
<ul><li><em>From:</em> Michael Letzgus &lt;michael.letzgus@uni-bielefeld.de&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00711.html">[sundials-users] Re: large stiff ODE system</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00713.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00710.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00713.html">Re: Re-4: [sundials-users] performance for chemical kinetic problems</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00712">
<strong>Main</strong></a></li>
<li><a href="threads.html#00712">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
