<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams -->
<!--X-From-R13: Dnqh Ereona <freona1Nyyay.tbi> -->
<!--X-Date: Mon, 14 Nov 2005 11:44:29 &#45;0800 (PST) -->
<!--X-Message-Id: 4378E79D.2030202@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: C3B5FCC014972B42BAF524423D8DAE9E044BCF@physbs01.Physiomics&#45;plc.local -->
<!--X-Reference: 4378D01A.6060404@llnl.gov -->
<!--X-Reference: Pine.LNX.4.62.0511141920500.7024@mescalin.tbi.univie.ac.at -->
<!--X-Head-End-->
<html>
<head>
<title>Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00167.html">Date Prev</a>] [<a href="msg00169.html">Date Next</a>] [<a href="msg00167.html">Thread Prev</a>] [<a href="msg00169.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00168">Date Index</a></b>]
[<b><a href="threads.html#00168">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:serban1%40llnl.gov">serban1@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Mon, 14 Nov 2005 11:38:05 -0800</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Rainer,</pre><br>
Hmmm, although it doesn't show in your code snippet, I bet that even 
when you use the internal DQ sensitivity RHS approximation, you still 
set a user data pointer through CVodeSetSensFdata, right? That is not 
needed, since you do not have a fS function where to use it. However, 
CVODES uses that for its own 'user data' which is overwritten when 
calling CVodeSetSensFdata...<br>
<br>
This is a bug in CVODES which I'll fix right now. Until then, the fix is 
to move the call to CVodeSetSensFdata inside the if statement, as 
follows (I assume you use the same data structure?)<br>
<br>
<pre style="margin: 0em;">    /* was construction of parametric matrix successfull ? */
    if ( om-&gt;sensitivity ) {
      /*!!! THIS WORKS FINE !!!*/
      flag = CVodeSetSensRhs1Fn(solver-&gt;cvode_mem, fS);
      flag = CVodeSetSensFdata(solver-&gt;cvode_mem, data);
    }
    else {
      /*!!! ??? DOESNT WORK CURRENTLY ??? !!!*/
      /* SIGSEV: ... at ./cvodes.c:6501  pbari = pbar[is];*/
      for ( i=0; i&lt;data-&gt;nsens; i++ ) {
    data-&gt;p[i] = data-&gt;value[om-&gt;index_sens[i]];
      }
      flag = CVodeSetSensParams(solver-&gt;cvode_mem, data-&gt;p, NULL, NULL);
    }</pre><br>
<pre style="margin: 0em;">Thanks for spotting this!
--Radu</pre><br>
Rainer Machne wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi Radu,</pre><br>
<pre style="margin: 0em;">I am working with Andrew on the same project.</pre><br>
Thanks for your detailed explanations. They will help us a lot to select 
correct pbar values.<br>
<br>
<pre style="margin: 0em;">As I understand I can use either</pre><br>
<pre style="margin: 0em;">CVodeSetSensRhs1Fn
(and optionally set pbar via CVodeSetSensParams)</pre><br>
<pre style="margin: 0em;">or</pre><br>
<pre style="margin: 0em;">CVodeSetSensParams
where at least p must be non-NULL. Right?</pre><br>
<pre style="margin: 0em;"><br>Then, I have an additional problem:
does the following messages from gdb ring a bell?</pre><br>
0x080637ae in CVSensRhs1DQ (Ns=4, t=0, y=0x8a906d0, ydot=0x8a90650, is=0,<br>
    yS=0x8aabfc0, ySdot=0x8a92c98, fS_data=0x8aa3120, ytemp=0x8a96ac0,<br>
    ftemp=0x8a96a48) at ./cvodes.c:6501<br>
6501      pbari = pbar[is];<br>
(gdb) where<br>
#0  0x0806377e in CVSensRhs1DQ (Ns=4, t=0, y=0x8a3d6d0, ydot=0x8a3d650, 
is=0,<br>
    yS=0x8a58fc0, ySdot=0x8a3fc98, fS_data=0x8a50120, ytemp=0x8a43ac0,<br>
    ftemp=0x8a43a48) at ./cvodes.c:6501<br>
#1  0x080597f1 in CVSensRhs (cv_mem=0x8a3ece0, time=0, ycur=0x8a3d6d0,<br>
    fcur=0x8a3d650, yScur=0x8a5bf88, fScur=0x8a5a9b8, temp1=0x8a43ac0,<br>
    temp2=0x8a43a48) at ./cvodes.c:6407<br>
#2  0x08062919 in CVode (cvode_mem=0x8a3ece0, tout=30, yout=0x8a44148,<br>
    tret=0x8a455e8, itask=144945160) at ./cvodes.c:1509<br>
<br>
<br>Our program runs fine if we provide a Rhs1 function, but we have cases 
where we cannot provide this function. Find below the code for the two 
cases, where the first one works fine, but the second causes this 
failure. As you see, pbar was passed as NULL. The same error occurs if I 
set pbar to some positive values. data-&gt;p should be set correctly.<br>
<br>
<pre style="margin: 0em;">Many Thanks,
Rainer</pre><br>
<pre style="margin: 0em;">code snippet from our program:</pre><br>
<pre style="margin: 0em;">    /* was construction of parametric matrix successfull ? */
    if ( om-&gt;sensitivity ) {
      /*!!! THIS WORKS FINE !!!*/
      flag = CVodeSetSensRhs1Fn(solver-&gt;cvode_mem, fS);
    }
    else {
      /*!!! ??? DOESNT WORK CURRENTLY ??? !!!*/
      /* SIGSEV: ... at ./cvodes.c:6501  pbari = pbar[is];*/
      for ( i=0; i&lt;data-&gt;nsens; i++ ) {
    data-&gt;p[i] = data-&gt;value[om-&gt;index_sens[i]];
      }
      flag = CVodeSetSensParams(solver-&gt;cvode_mem, data-&gt;p, NULL, NULL);
    }</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">On Mon, 14 Nov 2005, Radu Serban wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">Hi Andrew,<br>
I am aware that the use of p, plist, and pbar can be confusing. I 
would like to clean that up and feedback from users such as yourself 
would be very welcome. In the next SUNDIALS release, I will try to 
make that a bit more intuitive (or at least provide more details in 
the documentation).<br>
In the meanwhile, see the answers below.<br>
Thanks,<br>
--Radu<br>
<br>
<pre style="margin: 0em;">Andrew Finney wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">
Does anyone know the answer to the following question?
</blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">Yes :-)</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">We are passing a non null fS argument to CVodeSetSensRhs1Fn.
Is that compatible with passing a non null plist argument to
CVodeSetSensParams?
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
Yes, a non-NULL plist can be passed but will NOT be used when a 
user-provided sensitivity RHS function (of either type: CVSensRhsFn or 
CVSensRhs1Fn) is used.<br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">If yes please explain the effect of the plist argument and how it should
be constructed.
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
plist is used ONLY if the sensitivity right-hand sides are evaluated 
using the internal difference-quotient approximations. In that case, 
plist should contain the indeces in the array of problem parameters 
(p) with respect to which sensitivities are desired. Note that, in the 
current CVODES release (I am thinking of changing this for 
consistency), the plist values start at 1: if you want to compute 
sensitivities with respect to the first parameter in the p array, 
p[0], you need to set one of the components of plist to 1.<br>
<br>
As always, an actual example is better than anything else. I attached 
a modification of the cvfdx CVODES example that uses a user-provided 
sensitivity RHS function (of type CVSensRhs1Fn) to compute 
sensitivities with respect to two problem parameters (NS=2). To 
emphasize that the p array is not needed in this case, the three 
problem parameters are stored as three separate doubles in the user 
data structure (not as an array in the original cvfdx example). The 
example computes sensitivities with respect to the problem parameters 
p1 and p3. As such, pbar is set to be an array of dimension NS=2 with 
components pbar[0]=|p1| and pbar[1]=|p3| (see below why pbar is 
needed), while the function fS1 computes the RHS of the sensitivity 
system with respect to p1 if iS=0 and with respect to p3 if iS=1.<br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Specifically we'd be interested whether the indices in plist are also
passed to the Rhs1 function (as int iS).
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
No, iS does not represent a plist value, but just the index of the 
current sensitivity RHS to be evaluated (see the explanation above). 
As mentioned before, in this case plist is not needed (moreover, p 
itself is not needed so plist would have no meaning).<br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">If we can not provide a Rhs1 function, we understand that we need to set
p (and use it's contents in the ODE evaluation function f), and
optionally plist and pbar:
What else should be set for using the internal approximation method
instead of a Rhs function?
</pre></blockquote><pre style="margin: 0em;"><br></pre><br>
That's it. Note that if plist is not provided, CVODES will compute 
sensitivities with respect to the first NS parameters in the array p 
(i.e. it will automatically set plist to: plist[i]=i+1, i=0,1,...Ns). 
Also, if pbar is not provided, CVODES will use pbar[i]=1, i=0,1,...Ns.<br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">
What and how important are pbar values?
</blockquote><pre style="margin: 0em;"><br></pre><br>
The pbar values are needed in two places:<br>
1) when the internal difference-quotient functions are used for the 
evaluation of the sensitivity RHS, pbar is used in computing an 
appropriate perturbation for the finite-difference approximation (see 
Eqs. 3.12-3.13 in the user guide).<br>
2) unless the user explicitly specifies tolerances for the sensitivity 
variables, appropriate values for them are estimated from the 
tolerances specified for the state variables and pbar values (see 
Section 3.2.2 in the user guide).<br>
<br>
Therefore, pbar is used (possibly the default value of 1.0 if the user 
does not provide other values) for the second item even when supplying 
a sensitivity RHS function.<br>
<br>
Providing good pbar values is important when the problem is not scaled 
(i.e. the parameters with respect to which sensitivities are computed 
are either very small or very large, i.e. far from unity). Appropriate 
pbar values will result in finite-difference perturbations that strike 
a better balance between truncation and round-off errors (item 1 
above) and in more accurate noise levels for the sensitivity variables 
(i.e. absolute tolerances for the sensitivity variables).<br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Many thanks</pre><br>
<pre style="margin: 0em;">Andrew Finney PhD
Physiomics PLC</pre><br>
<br>
</blockquote><pre style="margin: 0em;"><br>Cheers,
--Radu</pre><br>
<br>
</blockquote><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00169" href="msg00169.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
<ul><li><em>From:</em> Rainer Machne &lt;raim@tbi.univie.ac.at&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00165" href="msg00165.html">using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
<ul><li><em>From:</em> Andrew Finney &lt;afinney@physiomics-plc.com&gt;</li></ul></li>
<li><strong><a name="00166" href="msg00166.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00167" href="msg00167.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
<ul><li><em>From:</em> Rainer Machne &lt;raim@tbi.univie.ac.at&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00167.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00169.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00167.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00169.html">Re: using CVODES with CVodeSetSensRhS1Fn and CVodeSetSensParams</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00168">
<strong>Main</strong></a></li>
<li><a href="threads.html#00168">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
