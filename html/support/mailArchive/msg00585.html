<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Problems with IDACalcIC() -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Wed, 19 Jul 2006 09:01:43 &#45;0700 -->
<!--X-Message-Id: 44BE552A.3090804@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 449FF72D.1050304@eas.iis.fraunhofer.de -->
<!--X-Reference: 44A0044E.7030404@llnl.gov -->
<!--X-Reference: 44A00F10.3040708@eas.iis.fraunhofer.de -->
<!--X-Reference: 44A137AA.8000405@llnl.gov -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Problems with IDACalcIC()</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00584.html">Date Prev</a>] [<a href="msg00586.html">Date Next</a>] [<a href="msg00553.html">Thread Prev</a>] [<a href="msg00555.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00585">Date Index</a></b>]
[<b><a href="threads.html#00585">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Problems with IDACalcIC()</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Wed, 19 Jul 2006 08:52:10 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Jens,</pre><br>
<tt>After further consideration, both Alan H. and I agreed that the current IDACalcIC implementation only invites misuse. We are therefore 
considering changing it so that it will not take (t0,yy0,yp0) as arguments anymore and, instead, will always compute consistent initial 
conditions starting from the triplet (t0,yy0,yp0) specified through IDAMalloc or IDAReInit (which these two functions store in the Nordsieck 
history arrays phi). This implies that IDACalcIC will have to be called right after IDAMalloc (or IDAReInit) and not the way it's done in 
your simulator.<br>
Note that this is practically a rollback to the IDACalcIC implementation in IDA v2.2.2 (sundials v2.0.2) with the exception that we will not 
use the user's yy0 and yp0 as workspace, but rather make temporary copies.</tt><br>
<br>
<tt>If you have a compelling argument against this (the inconvenience of changing the order in your simulator doesn't count :-)), please let me 
know. We cannot think of any...</tt><br>
<br>
<pre style="margin: 0em;">--Radu</pre><br>
<tt>Radu Serban wrote:
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><tt>Jens,<br>
Although your changes will probably work, I still suggest you reorder 
things in the simulator, as it seems unnatural to specify some initial 
conditions to IDA only to have them modified before the next call to an 
IDA function. This is not the intended use of IDACalcIC (with or without 
modifications).<br>
--Radu</tt><br>
<br>
<tt>Jens Bastian wrote:
</tt><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi Radu,</pre><br>
<pre style="margin: 0em;">if I used IDA stand alone I would call IDAMalloc() with yy0. But IDA is
built into a simulator and between the initialization and calculating
consistent initial values another part of the simulator changes yy0.</pre><br>
<pre style="margin: 0em;">It would be possible to change the order in the simulator but I assumed
that IDACalcIC() would work like the documentation says. ;) I think (or
hope) my changes will work as an interim solution. Otherwise an option
would still be changing the alignment in the simulator.</pre><br>
<pre style="margin: 0em;">Best regards
Jens</pre><br>
<pre style="margin: 0em;">Radu Serban wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi Jens,</pre><br>
<pre style="margin: 0em;">Indeed, although the documentation says that IDACalcIC can be called to
correct any pair (y,y'), the current implementation assumes it is used
only to correct the values y0 and yp0 passed to IDAMalloc (or
IDAReInit). This also implicitly forces the user to pass to IDACalcIC
the same y0 and yp0 that were specified in the previous call to
IDAMalloc (or IDAReInit).</pre><br>
<pre style="margin: 0em;">Thanks for pointing this out. I'll look into modifying IDACalcIC to
behave as advertised.</pre><br>
<pre style="margin: 0em;">In the meantime, could you tell me how exactly you wish to use IDACalcIC
(i.e. why the y0 passed to it is different from the one passed to
IDAMalloc) to see if there is some other interim solution for you?</pre><br>
<pre style="margin: 0em;">What confuses me a bit is the fact that the changes you've made are
basically equivalent to having previously called IDAMalloc with the same
yy0 as that in the call to IDACalcIC.</pre><br>
<pre style="margin: 0em;">--Radu</pre><br>
<pre style="margin: 0em;">Jens Bastian wrote:</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Hi,</pre><br>
<pre style="margin: 0em;">when trying to solve a DAE system I ran into trouble with IDA. I could
track it down to an initialization problem. Here I must mention that I
call IDACalcIC(..., y0, ...) with a different y0 (that means same
pointer but some values have changed) than the y I used in
IDAMalloc(..., y, ...).</pre><br>
<pre style="margin: 0em;">The first problem is that in IDACalcIC() the function IDAInitialSetup()
is called where the error weight vector ewt is calculated from phi[0]
(that is y) and not from y0.</pre><br>
<pre style="margin: 0em;">The second problem - the one that made me grey hairs ;) - is also
located in IDACalcIC() in the nwt (1...2) and nh (1...mxnh) loops. If
the lines
       N_VScale (ONE, phi[0], yy0);
       N_VScale (ONE, phi[1], yp0);
are called, my precious y0 is overwritten with the old y set by
IDAMalloc().</pre><br>
<pre style="margin: 0em;">Is solved the problems for me by adding the lines
 ier = efun(yy0, ewt, edata);
 N_VScale (ONE, yy0, phi[0]);
after the checks at the beginning of IDACalcIC() before the line
 tdist = ABS(tout1 - tn);
but surely this is not the perfect solution.</pre><br>
<pre style="margin: 0em;">Best regards
Jens</pre><br>
</blockquote></blockquote><pre style="margin: 0em;"><br></pre><br>
<br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">--
   Radu Serban
   Center for Applied Scientific Computing   [email] radu@llnl.gov
   Lawrence Livermore National Laboratory    [phone] 925-424-4852
   P.O. Box 808, L-560                       [fax]   925-422-6287
   Livermore, CA 94551</pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00545" href="msg00545.html">[sundials-users] Problems with IDACalcIC()</a></strong>
<ul><li><em>From:</em> Jens Bastian &lt;Jens.Bastian@eas.iis.fraunhofer.de&gt;</li></ul></li>
<li><strong><a name="00548" href="msg00548.html">Re: [sundials-users] Problems with IDACalcIC()</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;radu@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00550" href="msg00550.html">Re: [sundials-users] Problems with IDACalcIC()</a></strong>
<ul><li><em>From:</em> Jens Bastian &lt;Jens.Bastian@eas.iis.fraunhofer.de&gt;</li></ul></li>
<li><strong><a name="00553" href="msg00553.html">Re: [sundials-users] Problems with IDACalcIC()</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;radu@llnl.gov&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00584.html">Re: [sundials-users] custom linear solvers for cvodes, and ida</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00586.html">Re: [sundials-users] custom linear solvers for cvodes, and ida</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00553.html">Re: [sundials-users] Problems with IDACalcIC()</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00555.html">[sundials-users] Re: problem in running the parallel fortran example</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00585">
<strong>Main</strong></a></li>
<li><a href="threads.html#00585">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
