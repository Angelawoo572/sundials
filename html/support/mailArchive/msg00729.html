<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Using CVODE to solve Difrancesco Noble Cell model -->
<!--X-From-R13: Dnqh Ereona <enqhNyyay.tbi> -->
<!--X-Date: Mon, 09 Oct 2006 13:13:59 &#45;0700 -->
<!--X-Message-Id: 452AAD6B.8060809@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 001b01c6ebdd$9f375060$0a01a8c0@PCHEARTBREAK -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00728.html">Date Prev</a>] [<a href="msg00730.html">Date Next</a>] [<a href="msg00728.html">Thread Prev</a>] [<a href="msg00730.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00729">Date Index</a></b>]
[<b><a href="threads.html#00729">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:radu%40llnl.gov">radu@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Mon, 09 Oct 2006 13:13:31 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Hi Alan,<br>
I did warn Kanakapriya of the wrong tout update, but I left the solution as 
homework :-)<br>
--Radu<br>
<br>
Alan Garny wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Kanakapriya,</pre><br>
<pre style="margin: 0em;">Radu's comment is (obviously) right, but you may also want to check the way
you update tout. You first initialise it using:</pre><br>
<pre style="margin: 0em;">tout = Simtime/counter;</pre><br>
<pre style="margin: 0em;">And then update it using:</pre><br>
<pre style="margin: 0em;">tout += tout;</pre><br>
<pre style="margin: 0em;">This means that after each call to Cvode you are increasing the risks of
reaching the maximum number of steps allowed per call (not to mention that
tout probably doesn't hold the value you want in the first place). Instead,
you probably want to do something like:</pre><br>
<pre style="margin: 0em;">tstep = Simtime/counter;</pre><br>
<pre style="margin: 0em;">...</pre><br>
<pre style="margin: 0em;">flag = CVode(cvode_mem, (i+1)*tstep, u, &amp;t, CV_NORMAL);</pre><br>
<pre style="margin: 0em;">Note that I have discarded tout (not necessary anymore). Also, in general, I
would avoid having something like:</pre><br>
<pre style="margin: 0em;">tout += tstep;</pre><br>
<pre style="margin: 0em;">in your code, since this may lead to some floating point accuracy issues.</pre><br>
<pre style="margin: 0em;">        Cheers, Alan.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">-----Original Message-----<br>
From: owner-sundials-users@lists.llnl.gov 
[<a  href="mailto:owner-sundials-users@lists.llnl.gov">mailto:owner-sundials-users@lists.llnl.gov</a>] On Behalf Of Radu Serban<br>
Sent: 09 October 2006 20:36<br>
To: sundials-users@llnl.gov<br>
Subject: Re: [sundials-users] Using CVODE to solve 
Difrancesco Noble Cell model<br>
<br>
mxsteps (default value=500, but can be changed through 
CVodeSetMaxNumSteps) specifies he maximum number of steps to 
be taken by the solver in its attempt to reach the next 
output time. This check is provided to catch potential 
problems with the problem definition and/or the 
implementation and, in your case, it did exactly that :-) 
Indeed, double check the way you increment the next output 
time (is tout += tout the right way to do it?). For Simtime = 
1.0, this will request output from CVode until 
tout=1.0715e+298, most likely not what you meant.<br>
<br>
<pre style="margin: 0em;">--Radu</pre><br>
P.S. If the functions cellptr-&gt;updateState and  
cellptr-&gt;cvodeCompute do not modify their arguments, I 
suggest you replace the copy loops with just 
uinit=NV_DATA_S(y), both in the main program and in the rhs 
function. Same for<br>
ydiff: use ydiff=NV_DATA_S(ydot) before calling cellptr-&gt;getDiff.<br>
(The assignment v_data = NV_DATA_S(v) sets v_data to be a 
pointer to the first component of v. v_data must be a pointer 
to realtype.)<br>
<br>
<br>kanakapriya Kalyanasundaram wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">Hi,<br>
I am trying to set up CVODE to solve DFN states.  I know 
</blockquote>the model is 
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">fairly accurate because with a timestep of about 0.01 ms I 
</blockquote>can run the 
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">model with just basic Y = Y +ydot*dtand get decent results.</pre><br>
The model consists of about 16 states and corresponding 
</blockquote>first degree 
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">equations;  The states ARE dependent on one another.</pre><br>
The chief parameter of interest is Vm (state [0]), the membrane 
voltage.  I get continuous &quot;mxsteps steps taken before 
</blockquote>reaching tout&quot;
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">error and the output sort of oscillates between -200 and 
</blockquote>+20 instead 
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">of going from -80 to about +20, falling sharply and then 
</blockquote>combing back 
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">to around -80.  These cells are autorhythmic and the curves repeat 
automatically.<br>
<br>
<pre style="margin: 0em;">If someone can see where I am erring please please help!</pre><br>
<pre style="margin: 0em;">I will be utterly greatful.</pre><br>
<pre style="margin: 0em;">Regards,
KPKS</pre><br>
<pre style="margin: 0em;">These are my steps in using CVODE:
//declare y, errorvector and memory space for CVODE</pre><br>
<pre style="margin: 0em;"> N_Vector u,vAbsTol;
  void *cvode_mem;</pre><br>
//define and initialize CVODE vars<br>
    u = N_VMake_Serial(N,uinit); //uinit is initialized by the 
getState function<br>
<br>
//some day I will figure out the rt tol for each of the 
</blockquote>states , hence 
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">CV instead of SS</pre><br>
<pre style="margin: 0em;">    vAbsTol = N_VNew_Serial(N);
    if (check_flag((void *)vAbsTol, &quot;N_VNew_Serial&quot;, 0)) return(1);
    //intialize with vAbsTol
    for (int z = 0; z &lt; N; z++)
    NV_Ith_S(vAbsTol,z) = abstol;</pre><br>
<pre style="margin: 0em;"><br>    cvode_mem = CVodeCreate(CV_BDF, CV_NEWTON);
    if (check_flag((void *)cvode_mem, &quot;CVodeCreate&quot;, 0)) return(1);</pre><br>
<pre style="margin: 0em;">// Allocate internal memory.</pre><br>
<pre style="margin: 0em;">    flag = CVodeMalloc(cvode_mem, f, t, u, CV_SV, reltol, vAbsTol);</pre><br>
<pre style="margin: 0em;">//. Attach linear solver module
    CVDense(cvode_mem, N);
    if (check_flag(&amp;flag, &quot;CVDense&quot;, 1)) return(1);</pre><br>
<pre style="margin: 0em;">    //user default jacobean
    CVDenseSetJacFn(cvode_mem, NULL, NULL);
    if (check_flag(&amp;flag, &quot;CVDenseSetJacFn&quot;, 1)) return(1);</pre><br>
<pre style="margin: 0em;">//set up loop to calculate states over desired time i.e. 4s
   int counter = int (Simtime*1000.0);
    tout = Simtime/counter;</pre><br>
<pre style="margin: 0em;">    for (int i = 0; i &lt; counter; i++)
    {
        int z;
        flag = CVode(cvode_mem, tout, u, &amp;t, CV_NORMAL);
        if (check_flag((void *)cvode_mem, &quot;CVode&quot;, 0)) return(1);</pre><br>
<pre style="margin: 0em;">      //update cell state with u vector from cvode
      for ( z = 0; z &lt; N; z++)
            uinit[z]=NV_Ith_S(u,z);
        cellptr-&gt;updateState(uinit);</pre><br>
<pre style="margin: 0em;">//increment time step
          tout+=tout;
    }</pre><br>
<pre style="margin: 0em;">This is the function f called by cvode to calculate the RHS::</pre><br>
<pre style="margin: 0em;">static int f(realtype t, N_Vector y, N_Vector ydot, void *f_data) {
    double ydiff[16],uinit[16];
    int z;</pre><br>
<pre style="margin: 0em;">//put y vector into a temperory state vector
    for ( z = 0; z &lt; DFN_STATES; z++)
        uinit[z]=NV_Ith_S(y,z);
    //cellptr-&gt;updateState(uinit);</pre><br>
<pre style="margin: 0em;">//call cell to compute ydot.
    cellptr-&gt;cvodeCompute(uinit);
    cellptr-&gt;getDiff(ydiff);</pre><br>
<pre style="margin: 0em;">//compute ydot vector used by cvode
    for ( z = 0; z &lt; DFN_STATES; z++)
        NV_Ith_S(ydot,z) = ydiff[z];</pre><br>
<pre style="margin: 0em;">    return(0);
}
</pre></blockquote></blockquote><pre style="margin: 0em;"><br></pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00730" href="msg00730.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
<ul><li><em>From:</em> &quot;kanakapriya Kalyanasundaram&quot; &lt;kanakapriya@gmail.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00728" href="msg00728.html">RE: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
<ul><li><em>From:</em> &quot;Alan Garny&quot; &lt;agml@hellix.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00728.html">RE: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00730.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00728.html">RE: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00730.html">Re: [sundials-users] Using CVODE to solve Difrancesco Noble Cell model</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00729">
<strong>Main</strong></a></li>
<li><a href="threads.html#00729">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
