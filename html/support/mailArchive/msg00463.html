<!-- MHonArc v2.6.10 -->
<!--X-Subject: Re: [sundials&#45;users] Re: Inquiry regarding CVODE -->
<!--X-From-R13: Dnqh Ereona <freona1Nyyay.tbi> -->
<!--X-Date: Thu, 01 Jun 2006 10:14:05 &#45;0700 (PDT) -->
<!--X-Message-Id: 447F1D64.8000407@llnl.gov -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 90004056.1148981680079.JavaMail.wwwadmin@phoebe.mathworks.com -->
<!--X-Reference: 447C851C.70405@llnl.gov -->
<!--X-Reference: 1149021746.447cae32de85a@webmail.technion.ac.il -->
<!--X-Head-End-->
<html>
<head>
<title>Re: [sundials-users] Re: Inquiry regarding CVODE</title>
<meta name="author" content="Radu Serban">
<meta name="description" content="suite of nonlinear differential algebraic equation solvers">
<meta name="keywords" content="SUNDIALS, CVODE, CVODES, IDA, KINSOL">
<meta name="keywords" content="ODE, DAE, sensitivity">
<meta name="keywords" content="differential, algebraic">
<link REL="SHORTCUT ICON" HREF="img/favicon.ico" type="image/x-icon">
<link REL="ICON" HREF="img/favicon.ico" type="image/x-icon">
<link href="../../sundials_styles.css" rel="stylesheet" type="text/css">
<script language="JavaScript">
<!--
homeon = new Image();           homeon.src = "../../graphics/home_buttonH.png";
homeoff = new Image();          homeoff.src = "../../graphics/home_button.png";
descriptionon = new Image();    descriptionon.src = "../../graphics/description_buttonH.png";
descriptionoff = new Image();   descriptionoff.src = "../../graphics/description_button.png";
documentationon = new Image();  documentationon.src = "../../graphics/documentation_buttonH.png";
documentationoff = new Image(); documentationoff.src = "../../graphics/documentation_button.png";
downloadon = new Image();       downloadon.src = "../../graphics/download_buttonH.png";
downloadoff = new Image();      downloadoff.src = "../../graphics/download_button.png";
supporton = new Image();        supporton.src = "../../graphics/support_buttonH.png";
supportoff = new Image();       supportoff.src = "../../graphics/support_button.png";
//-->
</script>
<script src="../../sunjs.js" type="text/javascript" language="javascript1.2"></script>
</head>
<!-- ******************************************************************************** -->
<body>
<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
  <tr valign="top">
  <td height="60" background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  <td width="116"><img SRC="../../graphics/head_top_left.png" height="60" width="116" border="0"></td>
  <td width="720"><img SRC="../../graphics/head_mail_top_right.png" height="60" width="720" border="0"></td>
  <td background="../../graphics/table_bck1.gif"><img src="../../graphics/table_bck1.gif" width="5" height="60"></td>
  </tr>
  <tr valign="top">
  <td height="127" background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  <td width="116">
    <a href="../../main.html" onMouseOver="img_act('home'); return true;" onMouseOut="img_inact('home'); return true;"><img src="../../graphics/home_button.png" border="0" name="home"></a><br>
    <a href="../../description/description.html" onMouseOver="img_act('description'); return true;" onMouseOut="img_inact('description'); return true;"><img src="../../graphics/description_button.png" border="0" name="description"></a><br>
    <a href="../../documentation/documentation.html" onMouseOver="img_act('documentation'); return true;" onMouseOut="img_inact('documentation'); return true;"><img src="../../graphics/documentation_button.png" border="0" name="documentation"></a><br>
    <a href="../../download/download.html" onMouseOver="img_act('download'); return true;" onMouseOut="img_inact('download'); return true;"><img src="../../graphics/download_button.png" border="0" name="download"></a><br>
    <a href="../../support/support.html" onMouseOver="img_act('support'); return true;" onMouseOut="img_inact('support'); return true;"><img src="../../graphics/support_button.png" border="0" name="support"></a><br>
    <img SRC="../../graphics/line_tl.gif" height="7" width="116" border="0"></td>
  <td width="720">
      <img SRC="../../graphics/head_bottom_right.png" height="120" width="720" border="0"><br>
      <img SRC="../../graphics/line_tr.gif" height="7" width="720" border="0"></td>
  <td background="../../graphics/table_bck2.gif"><img src="../../graphics/table_bck2.gif" width="5" height="127"></td>
  </tr>
  <tr valign="top">
  <td background="../../graphics/table_bck3.gif"></td>
  <td width="116" valign="bottom" align="center" background="../../graphics/table_bck5.gif"><img SRC="../../graphics/logo.png" border="0"></td>
  <td width="720" bgcolor="#ffffff">
  <div id="content">   
<!-- Start content for this page -->
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<p class="links">
[<a href="msg00462.html">Date Prev</a>] [<a href="msg00464.html">Date Next</a>] [<a href="msg00460.html">Thread Prev</a>] [<a href="msg00461.html">Thread Next</a>]<br>
[<b><a href="maillist.html#00463">Date Index</a></b>]
[<b><a href="threads.html#00463">Thread Index</a></b>]
</p>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [sundials-users] Re: Inquiry regarding CVODE</h1>
<div class="frame">
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<table border=0 cellpadding=2 cellspacing=0>
<tr>
<td align="right"><b>
<em>From</em></b></td>
<td align="left">
Radu Serban &lt;<a href="mailto:serban1%40llnl.gov">serban1@llnl.gov</a>&gt;</td>
</tr>

<tr>
<td align="right"><b>
<em>Date</em></b></td>
<td align="left">
Thu, 01 Jun 2006 10:01:24 -0700</td>
</tr>

</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
</div>
<div class="container">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">Hi Dotan,</pre><br>
Your problem has a really interesting sparsity pattern, especially since it seems to be one of few (that I know of) which truly require a 
parallel sparse direct linear solver. As it happens, I'm currently working on graph coloring algorithms for efficiently generating parallel 
sparse Jacobians with finite differences (one of the ingredients we need before including a parallel sparse direct linear solver in 
SUNDIALS). I'd be very interested in using your problem as a test for our coloring method, so let me to start with some questions of my own 
before answering your questions related to preconditioning and parallel requirements.<br>
<br>
If I understand it correctly, you could in principle scale up the problem size as much as you wish (well, up to the total number of blood 
vessels in the coronary system), correct? A problem size of 5*10^6 indicates a binary tree like the one you provided with a depth of around 
22 (the number of edges in a complete binary tree of depth D being 2^D-1). Is this pretty much the number of times an artery &quot;splits&quot; all 
the way down to capillaries, or can there be even more levels?<br>
<br>
What would be a more realistic tree representing the coronary system? Would it still be a binary tree, or could you have more than 2 vessels 
stemming from the same node? I also assume that in reality not all branches go down to the finest level. Could you provide such a tree?<br>
<br>
Lastly, you mention that the A matrix actually depends on the state vector. Does A_{i,j} depend only on y_j, meaning that he Jacobian 
sparsity pattern is the same as that of A? What about b_j? If a sparse direct linear solver were available, it would require the nonzero 
Jacobian elements for given (t,y). Would you be able to easily compute these or would you rather have the solver approximate them with 
finite differences?<br>
<br>
<pre style="margin: 0em;">Now back to your questions:</pre><br>
<pre style="margin: 0em;">1) Preconditioning</pre><br>
A preconditioner matrix for solving Jx=b is a matrix P which approximates J as well as possible but such that solving systems Px=c can be 
done as efficiently as possible. For CVODE, you provide a preconditioner by providing two functions: a required &quot;psolve&quot; function which 
solves Px=c for a vector c passed to it by CVODE and an optional &quot;psetup&quot; function which performs any prerequisite computation (storing, 
decomposition, etc). Depending on your choice for the matrix P you may not need &quot;psetup&quot; at all. For example, if you use the diagonal of J 
as your P matrix, you can just compute J_{i,i} in &quot;psolve&quot; and solve for x. However, keep in mind that CVODE calls &quot;psetup&quot; infrequently, 
but then calls &quot;psolve&quot; repeatedly to solve Px=c with different values for c (and same P). Therefore it would be more efficient to store the 
diagonal of J in some user data structure when &quot;psetup&quot; is called and use it within &quot;psolve&quot;.<br>
<br>
By only looking at your matrix A (without any physical considerations) I could consider building a matrix P which discards the two &quot;rays&quot;. 
Therefore P would be a block diagonal matrix (with 2x2 blocks) for which solving Px=c is a breeze (I would probably store the 2*N-1 values 
in the user data structure in &quot;psetup&quot;). However, that would be the same as claiming that the pressure in a vessel is most influenced by 
itself and the pressure in its neighboring vessel on the same level which probably does not make much sense physically.<br>
<br>
What I suspect is more sensible is to assume that the pressure in a vessel is most influenced by itself and the pressure in its parent 
vessel (is that so?). In this case, the matrix P is obtained from J by keeping its diagonal and the left &quot;ray&quot;. You'll need again to store 
2*N-1 values in &quot;psetup&quot; while &quot;psolve&quot; would again be trivial (sequentially solving Px=c starting at x_1).<br>
<br>
Finally, it seems to me that it wouldn't be all that difficult to code a sparse direct linear solver specific to this particular type of 
matrices. Then (to avoid having to interface a new linear solver module to CVODE) you could just use that linear solver as your &quot;psolve&quot; 
function, in which case you'd use the perfect preconditioner P=J (by the way, this is always the easiest way to use a new linear solver in 
SUNDIALS: use one of the iterative linear solvers with a perfect preconditioner which will lead to the iterative solver taking exactly one 
iteration).<br>
<br>
<pre style="margin: 0em;">2) Parallel implementation</pre><br>
Whether or not you need to parallelize your code depends on many factors, including the platform you plan on using. If you have enough 
memory available, you may be able to use a serial code. But if memory and/or efficiency are of concern you'll have to bite the bullet and 
write a parallel code. For 5*10^6 variables you'll probably have to do that (for some parallel performance results for CVODES on a problem 
of similar size, take a look at slide #31 of <a  href="http://www.llnl.gov/casc/sundials/documentation/sundials_acts_05.pdf">http://www.llnl.gov/casc/sundials/documentation/sundials_acts_05.pdf</a>)<br>
<br>
<pre style="margin: 0em;"><br>--Radu</pre><br>
<br>dotana@techunix.technion.ac.il wrote:
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Dear Radu,</pre><br>
Thank you for the fast reply.<br>
Actually, my system doesn't arise from PDE discretization. 
Shortly, we developed an analog model for each vessel in the coronary system. It<br>
turns out that the first derivative of the pressure (y') in each vessel depends<br>
(in a non-linear manner) on the pressures of the vessel itself, and of its near<br>
neighbors (2 from each side).<br>
In the attached doc file I illustrated how the matrix A appears for a perfect<br>
tree-like structure (which is a simplification of the real situation). You can<br>
see there that A features non-zero &quot;rays&quot; in 22.5, 45 (diagonal) and 67.5<br>
degrees. I fear it is not a standard banding pattern.<br>
The vector b(t) actually depends on pressure (y) only in the extreme feeding and<br>
draining vessels.<br>
<br>
In regards to your reply: 
* How do you overcome the dimensions of the preconditioner (do you supply it in<br>
a dense representation?)<br>
* Is parallelization a must for such a large-scale problem? Can you estimate<br>
roughly how many unknowns can be solved using a PC?<br>
<br>
<pre style="margin: 0em;">Thanks again, Dotan</pre><br>
<pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;"><br>Quoting Radu Serban &lt;serban1@llnl.gov&gt;:</pre><br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Dotan Algranati wrote:</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">Dear Sir,
It is of great honor for me to contact you after reading some of your
</pre></blockquote><pre style="margin: 0em;"><br>papers.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">I&#x2019;m a graduate student, investigating the flow in the coronary system (the
</blockquote><br>blood vessels feeding the heart). <br>
<br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">Making it as general as possible, I have a large-scale, stiff, fully
</blockquote><pre style="margin: 0em;"><br>non-linear ODE system to solve, that can be described as y'=Ay+b, where A 
and
b should be updated each time step according to y. A is symmetric, positive
definite, and sparse (5 elements per row) but poorly banded. The Jacobian
itself is also sparse and poorly banded. I was able to solve a similar system
with N~1000 using MATLAB&#x2019;s ode15s, and now I need to solve a system in which
N is ~ 5*10^6.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em">I thought about trying to solve it with CVODE. In addition, I&#x2019;m not much of
</blockquote><pre style="margin: 0em;"><br>a programmer, driving me to think about using the MATLAB interface.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">1. From your experience, is CVODE the kind of tool I&#x2019;m looking for?
2. How large a problem can I solve with CVODE? I know that ode15s allocates
</pre></blockquote><pre style="margin: 0em;"><br>an n-by-n Jacobian matrix, restricting me to &#x201C;small&#x201D; systems.</pre><br>
<blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">3. What kind of hardware am I looking for?
4. Any other comment would be of great help.</pre><br>
<pre style="margin: 0em;">Thank you for your time,</pre><br>
<pre style="margin: 0em;">Dotan Algranati
B.Sc. in Biomedical Engineering</pre><br>
<br>
</blockquote><pre style="margin: 0em;"><br>Dear Dotan,</pre><br>
Yes, CVODE is the right tool for the type of problem you have. It has been<br>
routinely used to solve systems with millions of unknowns. That 
being said, the only linear solvers currently provided with SUNDIALS that can<br>
effectively deal with large-scale systems are the Krylov ones 
which are matrix-free (i.e. never form the Jacobian matrix but rather require<br>
only Jacobian-vector products) but, for acceptable efficiency, 
require preconditioning. We plan on including a sparse direct linear solver,<br>
but one is not currently available. There is, of course, the 
option of providing your own linear solver (all SUNDIALS solvers define a<br>
generic interface to the linear solver module), but that's 
probably more programming that you want.<br>
<br>
You say your system is of the form y' = A(y)*y + b(y). While from CVODE's<br>
point of view this is just y' = f(y) (i.e. for the integration we 
do not assume anything about the structure of the right-hand side), this<br>
particular form may be useful in building an appropriate 
preconditioner. I suspect your ODE arises from the semi-discretization of<br>
some PDE. Maybe you can give a few more details on the form of A 
and b? Also, when you say that A (and J) are 'poorly banded', do you mean<br>
that they are banded but with several sub- and superdiagonals that 
are zero (or could be brought to this form)? If that is the case, you may be<br>
able to use a modified version of the banded linear solver 
module in CVODE which would explicitly take care of the zero diagonals.<br>
<br>
You could certainly use the Matlab interface to CVODES to solve your problem,<br>
but you need to keep in mind that sundialsTB uses Matlab 
m-files for the main driver and all user-provided functions which will<br>
negatively impact performance. Moreover, if you want to parallelize 
your code, that will require additional Matlab tools (MPITB) as well as an<br>
MPI distribution that provides MPI-2 capabilities (LAM or MPICH2).<br>
<br>
Finally, SUNDIALS can be built on any platform that provides (at a minimum) a<br>
C compiler. The easiest installation is on a *NIX platform, 
using the configure script, but SUNDIALS has also been built under Windows<br>
using various IDEs (look at the FAQ and browse the sundials-users 
mailing list archive for discussions on this topic). For parallel support<br>
you'll also need an MPI distribution.<br>
<br>
<pre style="margin: 0em;">--Radu</pre><br>
P.S. I've cc-ed this message to the sundials-users mailing list to which I<br>
encourage you to post inquiries such as this (you can subscribe 
to the list from the Support page on the SUNDIALS website where you can also<br>
find an archive of previous messages).<br>
<br>
<pre style="margin: 0em;">--
   Radu Serban
   Center for Applied Scientific Computing   [email] radu@llnl.gov
   Lawrence Livermore National Laboratory    [phone] 925-424-4852
   P.O. Box 808, L-560                       [fax]   925-422-6287
   Livermore, CA 94551</pre><br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<br>
</blockquote><pre style="margin: 0em;"><br></pre><br>
<pre style="margin: 0em;">--
   Radu Serban
   Center for Applied Scientific Computing   [email] radu@llnl.gov
   Lawrence Livermore National Laboratory    [phone] 925-424-4852
   P.O. Box 808, L-560                       [fax]   925-422-6287
   Livermore, CA 94551</pre><br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<div class="container">
<table width="95%" frame="below"><tr><td></td></table>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00459" href="msg00459.html">[sundials-users] Re: Inquiry regarding CVODE</a></strong>
<ul><li><em>From:</em> Radu Serban &lt;serban1@llnl.gov&gt;</li></ul></li>
<li><strong><a name="00460" href="msg00460.html">[sundials-users] Re: Inquiry regarding CVODE</a></strong>
<ul><li><em>From:</em> dotana@techunix.technion.ac.il</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00462.html">Re: [sundials-users] Step sizes for Jacobian approximation</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00464.html">[sundials-users] Roundoff problem in CVODE One-Step-Mode for large t and small h</a></strong>
</li>

<li>Previous by thread:
<strong><a href="msg00460.html">[sundials-users] Re: Inquiry regarding CVODE</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00461.html">[sundials-users] Step sizes for Jacobian approximation</a></strong>
</li>

<li>Index(es):
<ul>
<li><a href="maillist.html#00463">
<strong>Main</strong></a></li>
<li><a href="threads.html#00463">
<strong>Thread</strong></a></li>
</ul>
</li>
</ul>
</div>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
<!-- End content for this page -->
  </div>
  </td>
  <td background="../../graphics/table_bck3.gif"></td>
  </tr>
  <tr valign="top">
  <td height="17" background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  <td width="116"><a HREF="http://www.llnl.gov/disclaimer.html" target="_top"><img SRC="../../graphics/line_bl.gif" height="17" width="116" border="0"></a></td>
  <td width="720"><img SRC="../../graphics/line_br.gif" height="17" width="720" border="0"></td>
  <td background="../../graphics/table_bck4.gif"><img src="../../graphics/table_bck4.gif" width="5" height="17"></td>
  </tr>
  </table>
</body>
</html>
