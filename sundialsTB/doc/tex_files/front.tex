\documentclass[titlepage,10pt]{article}

\input{m2tex}

\usepackage{calc, chngpage}
\usepackage[nottoc]{tocbibind}
\usepackage{rotating}
\usepackage{multirow}
\usepackage{tabls}

%----- Page formatting
\setlength{\oddsidemargin}{0.5in}
\setlength{\evensidemargin}{0.0in}
\setlength{\paperwidth}{8.5in}
\setlength{\hoffset}{0in}
\setlength{\textwidth}{\paperwidth-(1in+\hoffset)*2-\oddsidemargin-\evensidemargin}
\setlength{\textheight}{9.0in}

%---- Tables
\setlength{\extrarulesep}{2pt}

%----- UCRL number, date, versions
\newcommand{\STBucrl}{UCRL-SM-212121}
\newcommand{\STBdate}{May 2005}

%----- LLNL disclaimer
\newcommand{\disclaimer}{%
\changetext{.625in}{}{}{}{}
\thispagestyle{empty}% no number of this page
\vglue5\baselineskip
\begin{center}
{\bf DISCLAIMER}
\end{center}
\noindent
This document was prepared as an account of work sponsored by an agency of the
United States Government.  Neither the United States Government nor the University
of California nor any of their employees, makes any warranty, express or implied,
or assumes any legal liability or responsibility for the accuracy, completeness,
or usefulness of any information, apparatus, product, or process disclosed, or
represents that its use would not infringe privately owned rights. Reference
herein to any specific commercial product, process, or service by trade name,
trademark, manufacturer, or otherwise, does not necessarily constitute or imply
its endorsement, recommendation, or favoring by the United States Government
or the University of California.  The views and opinions of authors expressed
herein do not necessarily state or reflect those of the United States Government
or the University of California, and shall not be used for advertising or
product endorsement purposes.

\vskip2\baselineskip
This research was supported under the auspices of the U.S. Department of Energy by
the University of California, Lawrence Livermore National Laboratory under
contract No.  W-7405-Eng-48.
\vfill
\begin{center}
Approved for public release; further dissemination unlimited
\end{center}
\clearpage
\changetext{-.625in}{}{}{}{}
}

%----- Clear empty double page
\newcommand{\clearemptydoublepage}{\newpage{\pagestyle{empty}\cleardoublepage}}

%----- SUNDIALS MODULES
\newcommand{\sundialsTB}{{\normalfont\scshape sundialsTB}}
\newcommand{\sundials}{{\normalfont\scshape sundials}}
\newcommand{\nvector}{{\normalfont\scshape nvector}}
\newcommand{\putils}{{\normalfont\scshape putils}}
\newcommand{\cvode}{{\normalfont\scshape cvode}}
\newcommand{\cvodes}{{\normalfont\scshape cvodes}}
\newcommand{\ida}{{\normalfont\scshape ida}}
\newcommand{\idas}{{\normalfont\scshape idas}}
\newcommand{\kinsol}{{\normalfont\scshape kinsol}}

\newcommand{\matlab}{{\normalfont\scshape matlab}}
\newcommand{\mpiTB}{{\normalfont\scshape mpiTB}}

%----- title and author
\title{{\sundialsTB}, a {\matlab} Interface to {\sundials}}
\author{
  Radu Serban \\ 
  {\em Center for Applied Scientific Computing} \\ 
  {\em Lawrence Livermore National Laboratory}
}
\date{\STBdate \\ \vfill \STBucrl}

%------ BEGIN document

\begin{document}

\pagestyle{empty}
\maketitle
\disclaimer

\tableofcontents

\clearemptydoublepage

\pagestyle{plain}\pagenumbering{arabic}

\section{Introduction}

{\sundials}~\cite{HBGLSSW:04}, SUite of Nonlinear and DIfferential/ALgebraic equation Solvers,
is a family of software tools for integration of ODE and DAE initial value problems
and for the solution of nonlinear systems of equations.
It consists of {\cvode}, {\ida}, and {\kinsol}, and variants of these with 
sensitivity analysis capabilities.

{\sundialsTB} is a collection of {\matlab} functions which provide interfaces to
the {\sundials} solvers.

The core of each {\matlab} interface in {\sundialsTB} is a single {\sc mex} 
file which interfaces to the various user-callable functions for that solver.
However, this {\sc mex} file should not be called directly, but rather through the 
user-callable functions provided for each {\matlab} interface.

A major design principle for {\sundialsTB}
was to provide an interface that is, as much as possible, equally familiar to
both {\sundials} users and {\matlab} users. Moreover, we tried to keep the
number of user-callable functions to a minimum. For example, the {\cvodes} {\matlab} 
interface contains only 12 such functions, 2 of which relate to forward sensitivity analysis and
4 more interface solely to the adjoint sensitivity module in {\cvodes}. 
A user who is only interested in integration of ODEs and not in sensitivity analysis
therefore needs to call at most 6 functions.
In tune with the {\matlab} {\sc odeset} function, optional
solver inputs in {\sundialsTB} are specified through a single function; e.g.
{\tt CvodeSetOptions} for {\cvodes} (a similar function is used to specify optional
inputs for forward sensitivity analysis). However, unlike the ODE solvers in {\matlab}, we
have kept the more flexible {\sundials} model in which a separate ``solve'' function 
({\tt CVodeSolve} for {\cvodes}) must be called to return the solution at a desired 
output time. Solver statistics, as well as optional outputs (such as
solution and solution derivatives at additional times) can be obtained at any time
with calls to separate functions ({\tt CVodeGetStats} and {\tt CVodeGet} for {\cvodes}).

This document provides a complete documentation for the {\sundialsTB} functions.
For additional details on the methods and underlying {\sundials} software consult
also the coresponding {\sundials} user guides~\cite{cvodes_ug,kinsol_ug}.

\subsection{Notes}

The version numbers for the {\matlab} interfaces correspond to those of the 
corresponding {\sundials} solver with wich the interface is compatible.

\subsection{Requirements}

Each interface module in {\sundialsTB} requires the appropriate version of the 
corresponding {\sundials} solver. For parallel support, {\sundialsTB} depends on
{\mpiTB} with {\sc lam} v $> 7.1.1$ (for MPI-2 spawning feature).

\subsection{Installation/Setup} 

The following steps are required to install and setup {\sundialsTB}:

\subsubsection{Choose ubication}

\begin{enumerate}

\item 
  {\sundialsTB} for all MATLAB users (not usual)

  Assume MATLAB is installed under \$MATLAB=/usr/local/matlab7.
  Place sundialsTB where toolboxes are usually stored:
\begin{verbatim}
    $ cd /usr/local/matlab7/toolbox
\end{verbatim}

\item 
  {\sundialsTB} for just one user (usual configuration)

  Place sundialsTB in your "matlab" working subdir:
\begin{verbatim}
    $ cd ~/matlab
\end{verbatim}

\end{enumerate}

\subsubsection{Decompress and untar}

\begin{verbatim}
    $ tar zxvf <wherever>/sundialsTB.tar.gz
\end{verbatim}
or
\begin{verbatim}
    $ cp <wherever>/sundialsTB.tar.gz
    $ gunzip sundialsTB.tar.gz
    $ tar xvf sundialsTB.tar
    $ rm sundialsTB.tar
\end{verbatim}
Now there is a ~/matlab/sundialsTB (or \$MATLAB/toolbox/sundialsTB) subdirectory.

\subsubsection{Configuring MATLAB's startup}

{\sundialsTB} comes with a startup\_STB.m file in the top subdirectory

\begin{enumerate}

\item 
  {\sundialsTB} for all MATLAB users (not usual)

  Assume MATLAB is installed under \$MATLAB=/usr/local/matlab7.
  Add {\sundialsTB} startup to the system-wide startup file:
\begin{verbatim}
    $ cd \$MATLAB/toolbox/local
    $ ln -s ../sundialsTB/startup_STB.m
\end{verbatim}
  and add these lines to your original local startup.m
\begin{verbatim}
    % SUNDIALS Toolbox startup M-file, if it exists.
    if exist('startup_STB','file')
      startup_STB
    end
\end{verbatim}

\item 
  {\sundialsTB} for just one user (usual configuration)

  Assume you do not need to keep any previously existing startup.m
\begin{verbatim}
    $ cd ~/matlab
    $ ln -s sundialsTB/startup_STB.m startup.m
\end{verbatim}
  If you already had a startup.m, use the method described above,
  first linking startup\_STB.m to the destination subdir and then
  editing ~/matlab/startup.m to run startup\_STB.m
  
\item 
  Since symbolic links do not work well with Matlab under Windows,
  a different alternative of setting-up the startup is as follows:
  
  Copy startup\_STB next to MATLAB's startup.m and add these lines
  to startup.m
  
\begin{verbatim}
  % SUNDIALS Toolbox startup M-file
  startup('path_to_sundialsTB')
\end{verbatim}  

  using the optional argument of startup\_STB to explicitly spceify
  the location of sundialsTB.
\end{enumerate}


\subsubsection{Compile MEX files}

To facilitate the compilation of {\sundialsTB} on platforms that do not have
a make system, we rely on MATLAB's mex command. Compilation of sundialsTB
is done by running from under MATLAB the install\_STB.m script which is
present in the sundialsTB top directory.

\begin{enumerate}

\item
  If you have not already done so, download and unpack SUNDIALS.
  Assume SUNDIALS is now located in /path/to/sundials

\item
  Launch matlab in sundialsTB:
\begin{verbatim}
    $ cd $MATLAB/toolbox/sundialsTB
    $ matlab
\end{verbatim}
  or
\begin{verbatim}
    $ cd ~/matlab/sundialsTB    
    $ matlab
\end{verbatim}

\item
  Run the install\_STB matlab script.
  You will be asked for the location of the SUNDIALS source tree. 
  Input /path/to/sundials.

  Note that parallel support will be compiled into the MEX files only if
  ALL of the following conditions are met:
  \begin{itemize}
     \item \$LAMHOME is defined
     \item \$MPITB\_ROOT is defined
     \item /path/to/sundials/nvec\_par exists 
   \end{itemize}

\end{enumerate}

\subsubsection{Try one of the sundialsTB examples}

If everything went fine, you should now be able to try one of the CVODES
or KINSOL examples (in matlab, type 'help cvodes' or 'help kinsol' to see
a list of all examples available).

\begin{enumerate}
\item
  cd to the CVODES serial example directory
\begin{verbatim}
    $ cd $MATLAB/toolbox/sundialsTB/cvodes/examples_ser
\end{verbatim}
  or
\begin{verbatim}
    $ cd ~/matlab/sundialsTB/cvodes/examples_ser
\end{verbatim}
\item
  Launch matlab and execute cvdx
\end{enumerate}

\subsection{Links} 

The required software packages can be obtained from the following addresses.

\begin{tabular}{rl}
{\sundials} & {\tt http://www.llnl.gov/CASC/sundials} \\
{\mpiTB}    & {\tt http://atc.ugr.es/javier-bin/mpitb\_eng}\\
{\sc lam}   & {\tt http://www.lam-mpi.org/}
\end{tabular}
