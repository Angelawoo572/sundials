\section{Code Organization}\label{s:organization}

As mentioned before, the SUNDIALS family of solvers consists of 
CVODE (for ODE systems), KINSOL (for nonlinear algebraic
systems), and IDA (for DAE systems).  
In addition, variants of these which also do sensitivity analysis calculations are
available (CVODES) or in development (IDAS and KINSOLS).
%
The overall organization of the CVODES package,a s well as its relationship
to SUNDIALS, is shown in Fig.~\ref{f:cvsorg}.  
The basic elements of the structure are a module for
the basic integration algorithm (including forward sensitivity analysis),
a module for adjoint sensitivity analysis, and a set of modules for the solution
of linear systems that arise in the case of a stiff system.  
\begin{figure}
\centerline{\psfig{figure=cvsorg.eps,width=\textwidth}}
\caption {Overall structure diagram of the CVODES package.
  Modules specific to CVODES are distinguished by rounded boxes, while 
  generic solver and auxiliary modules are in square boxes.}
\label{f:cvsorg}
\end{figure}

The central integration module deals with the evaluation of integration coefficients,
the functional or Newton iteration process, estimation of local error,
selection of stepsize and order, and interpolation to user output
points, among other issues.  Although this module contains logic for
the basic Newton iteration algorithm, it has no knowledge of the
method being used to solve the linear systems that arise.  For any
given user problem, one of the linear system modules is specified, and
is then invoked as needed during the integration. 

In addition, if forward sensitivity analysis is turned on, the main module 
will integrate the forward sensitivity equations, simultaneously with the original IVP.
The sensitivities variables may or may not be included in the local error control
mechanism of the main integrator.
CVODES provides three different strategies of dealing with the correction
stage for the sensitivity variables, simultaneous corrector and
two variants of staggered corrector (see Section~\ref{ss:fwd_sensitivity}).
The CVODES package includes an algorithm for the approximation of the sensitivity 
equations right hand sides by difference quotients, but the user has the option of 
supplying these right hand sides directly.

The adjoint sensitivity module provides the infrastructure needed for the 
integration backwards in time of any system of ODEs which depends on the solution 
of the original IVP, in particular the adjoint system and any quadratures required
in evaluating the gradient of the objective functional.
This module deals with the set-up of the check points, interpolation of the forward 
solution during the backward integration, and backward integration of the adjoint
equations. 

At present, the package includes the following four CVODES linear system
modules:
(a) CVSDENSE (LU factorization and backsolving with dense matrices),
(b) CVSBAND (LU factorization and backsolving with banded matrices),
(c) CVSDIAG (an internally generated diagonal approximation to the 
Jacobian), and
(d) CVSSPGMR (scaled preconditioned GMRES method).
This set of linear solver modules is intended to be expanded in the
future as new algorithms are developed.

In the case of the direct CVSDENSE and CVSBAND methods, the package includes
an algorithm for the approximation of the Jacobian by difference
quotients, but the user also has the option of supplying the Jacobian
(or an approximation to it) directly. In the case of the iterative
CVSSPGMR method, the package includes and algorithm for the approximation
by difference quotients of the product between the Jacobian matrix and
a vector of appropriate length. Again, the user has the option of providing
a routine for this operation.
In the case of CVSPGMR, the preconditioning must be supplied by the user, 
in two phases: setup (preprocessing of Jacobian data) and solve.
While there is no default choice of preconditioner analogous to the 
difference quotient approximation in the direct case, the references
\cite{BrHi:89,Byr:92}, together with
the example and demonstration programs included with CVODES, offer
considerable assistance in building preconditioners.

Each CVODES linear solver module consists of five routines, devoted to (1)
memory allocation and initialization, (2) setup of the matrix data
involved, (3) solution of the system, (4) solution of the system in the
context of forward sensitivity analysis, and (5) freeing of memory.  The
setup and solution phases are separate because the evaluation of
Jacobians and preconditioners is done only periodically during the
integration, as required to achieve convergence. The call list within
the central CVODES module to each of the five associated functions is
fixed, thus allowing the central module to be completely independent
of the linear system method.

These modules are also decomposed in another way.
Each of the modules CVSDENSE, CVSBAND, and CVSSPGMR is a set of 
interface routines built on top of a generic solver module, 
named DENSE, BAND, and SPGMR, respectively.  
The interfaces deal with the use of these methods in the CVODES context, 
whereas the generic solver is independent of the context.
While the generic solvers here were generated with SUNDIALS in mind, our
intention is that they be usable in other applications as
general-purpose solvers.  This separation also allows for any generic
solver to be replaced by an improved version, with no necessity to
revise the CVODES package elsewhere.

CVODES also provides two preconditioner modules. The first one, 
CVSBANDPRE, is intended to be used on serial computers and provides
a banded difference quotient Jacobian based preconditioner and solver
routines for use with CVSPGMR. The second preconditioner module, 
CVBBDPRE, developed for parallel computers, generates a 
preconditioner that is a block-diagonal matrix with each block being 
a band matrix. A detailed description of these two modules, including
usage guidlines, is given in ~\cite{HBGLSSW:03}.

All state information used by CVODES to solve a given problem is saved
in a structure, and a pointer to that structure is returned to the
user.  There is no global data in the CVODES package, and so in this
respect it is reentrant. State information specific to the linear
solver is saved in a separate structure, a pointer to which resides in
the CVODES memory structure. The reentrancy of CVODES was motivated
by the anticipated multicomputer extension, but is also essential
during adjoint sensitivity analysis where the check-pointing algorithm
leads to interleaved forward and backward integration passes. 

Figure~\ref{f:cvsorg} does not show any of the user-supplied routines 
for CVODES. At a minimum, the user must provide a routine for the evaluation 
of the ODE right-hand side and, if performing adjoint sensitivity analysis,
a routine for the evaluation of the right-hand side of the adjoint system. 
Optional user-provided routines include, depending on the options chosen, 
functions for Jacobian evaluation (direct cases) or Jacobian-vector products 
(Krylov case), setup and solution of Krylov preconditioners, a function providing 
the integrand of any additional quadrature equations, and a routine for
providing the right-hand side of the sensitivity equations (for forward sensitivity
analysis). Depending on the options selected for the solution of the adjoint
system, the user may have to provide corresponding Jacobian and/or preconditioner
routines.

One of the most important characteristics of the design of CVODES 
(shared by all solvers across SUNDIALS) is the fact that it is implemented 
in a data-independent manner, in that the solver does not need any information
regarding the underlying structure of the data on which it operates.

The CVODES solver acts on vectors through a generic NVECTOR module,
which defines an NVECTOR structure specification, a data-independent NVECTOR type, 
a set of abstract vector operations, and a set of wrappers for accessing the actual vector
operations of the implementation under which an NVECTOR was created. Because
details of vector operations are thus encapsulated within each specific
NVECTOR implementation, CVODES is thus independent of a specific
implementation. This allows the solver to be precompiled as a binary
library and allows more than one NVECTOR implementation to be used within
a single program. This feature is essential for the efficient integration of
quadrature variables (see Section~\ref{ss:integration} as well as for
adjoint sensitivity analysis when, for some problems, the adjoint variables
are more conveniently organized in a structure different from that of
the variables in the forward problem.

A particular NVECTOR implementation, such as the serial and parallel 
implementations included with SUNDIALS or a user-provided implementation,
must provide the following:
(1) actual implementation of the routines for operations on N-vectors, 
such as creation, destruction, summation, and dot product;
(2) a routine to construct an NVECTOR specification structure
for this particular implementation which defines the data necessary
for constructing a new N-vector and attaches the vector operations
to the new structure; and
(3) a destructor for the NVECTOR specification structure.

