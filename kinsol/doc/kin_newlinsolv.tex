%===================================================================================
\chapter{Providing Alternate Linear Solver Modules}\label{s:new_linsolv}
%===================================================================================
The central {\kinsol} module interfaces with the linear solver module to be
used by way of calls to four routines.  These are denoted here by 
\id{linit}, \id{lsetup}, \id{lsolve}, and \id{lfree}.
Briefly, their purposes are as follows:
\begin{itemize}
\item \id{linit}: initialize and allocate memory specific to the
  linear solver;
\item \id{lsetup}: evaluate and preprocess the Jacobian or preconditioner;
\item \id{lsolve}: solve the linear system;
\item \id{lfree}: free the linear solver memory.
\end{itemize}
A linear solver module must also provide a user-callable specification routine
(like that described in \S\ref{ss:lin_solv_init} for {\kinspgmr}) which will atach 
the above four routines to the main {\kinsol} memory block. 
Note that of the four interface routines, only the \id{lsolve} routine is required. 
The \id{lfree} routine must be provided only if the solver specification routine
makes any memory allocation.

These four routines that interface between {\kinsol} and the linear solver module
necessarily have fixed call sequences.  Thus, a user wishing to implement another 
linear solver within the {\kinsol} package must adhere to this set of interfaces.
The following is a complete description of the call list for each of
these routines.  Note that the call list of each routine includes a
pointer to the main {\kinsol} memory block, by which the routine can access
various data related to the {\kinsol} solution.  The contents of this memory
block are given in the file \id{kinsol\_impl.h} (but not reproduced here, for
the sake of space).

%------------------------------------------------------------------------------

\paragraph{Initialization routine.}
The type definition of \ID{linit} is
\usfunction{linit}
{
  int (*linit)(KINMem kin\_mem);
}
{
  The purpose of \id{linit} is to complete initializations for      
  specific linear solver, such as counters and statistics.        
}
{
  \begin{args}[kin\_mem]
  \item[kin\_mem]
    is the {\kinsol} memory pointer of type \id{KINMem}.
  \end{args}
}
{
  An \id{linit} function should return $0$ if it 
  has successfully initialized the {\kinsol} linear solver and 
  $-1$ otherwise. 
}
{
  If an error does occur, an appropriate message should be sent 
  to \id{kin\_mem->kin\_errfp}.
}

%------------------------------------------------------------------------------

\paragraph{Setup routine.} 
The type definition of \id{lsetup} is
\usfunction{lsetup}
{
  int (*lsetup)(&KINMem kin\_mem);
}
{
  The job of \id{lsetup} is to prepare the linear solver for subsequent 
  calls to \id{lsolve}. It may re-compute Jacobian-related data is it 
  deems necessary. 
}
{
  \begin{args}[kin\_mem]
  \item[kin\_mem]
    is the {\kinsol} memory pointer of type \id{KINMem}.
  \end{args}
}
{
  The \id{lsetup} routine should return $0$ if successful,            
  a positive value for a recoverable error, and a negative value  
  for an unrecoverable error.  
}
{}

%------------------------------------------------------------------------------

\paragraph{Solve routine.}
The type definition of \id{lsolve} is
\usfunction{lsolve}
{
  int (*lsolve)(&KINMem kin\_mem, N\_Vector x, \\
                &N\_Vector b, realtype *res\_norm);
}
{
  The routine \id{lsolve} must solve the linear equation $J x = b$, where         
  $J = \partial F / \partial y(y_{cur})$ and the right-hand side vector $b$ is input. 
}
{
  \begin{args}[res\_norm]
  \item[kin\_mem]
    is the {\kinsol} memory pointer of type \id{KINMem}.
  \item[x]
    is a vector set to an initial guess prior to calling \id{lsolve}. 
    On return it should contain the solution to $J x = b$.
  \item[b]
    is the right-hand side vector $b$, set to $-F(y)$, evaluated at
    the current iterate.
  \item[res\_norm]
    holds the value of the $L_2$ norm of the residual vector upon return.
  \end{args}
}
{
  \id{lsolve} returns a positive value    
  for a recoverable error and a negative value for an             
  unrecoverable error. Success is indicated by a $0$ return value.
}
{}

%------------------------------------------------------------------------------

\paragraph{Memory deallocation routine.}
The type definition of \id{lfree} is
\usfunction{lfree}
{
  void (*lfree)(KINMem kin\_mem);
}
{
  The routine \id{lfree} should free up any memory allocated by the linear
  solver.
}
{
  \begin{args}[kin\_mem]
  \item[kin\_mem]
    is the {\kinsol} memory pointer of type \id{KINMem}.
  \end{args}
}
{
  This routine has no return value.
}
{
  This routine is called once a problem has been completed and the 
  linear solver is no longer needed.
}