#!/bin/sh
#
# File tarscript: Script to build SUNDIALS tar-files.
# Author: Radu Serban @ LLNL
# Version of 08 August 2003
#

#==============================================================================
#
# Prints usage if help was requested or if the script was incorectly called
#
#==============================================================================

function print_usage
{
    echo ""
    echo "Usage: tarscript [-fhs] [module]"
    echo "   -f       : full version"
    echo "   -h       : help"
    echo "   -s       : serial only version"
    echo "   module   : all, sundials, cvode, cvodes, ida, kinsol"
    echo ""
    echo "Note1: If neither 'f', or 's' is specified, both tar files"
    echo "       are created for this module."
    echo "Note2: If the module is not specified, tar files are created"
    echo "       for all of them."
    echo "Note3: This script must be executed from within its directory" 
    echo "       Default file will be created in $distrodir."
    echo ""
    exit 1
}

#==============================================================================
#
# Generates one tar file for the given $module, accordingly to the $par flag
#
#==============================================================================

function create_file
{
    what=$1
    par=$2

    cd ..

    if [ $par = "F" ];   then
        aclocal
        autoconf -f -o configure configure-rel-serial.ac
        autoheader
        tail="_ser.tar"
    else
        aclocal
        autoconf -f -o configure configure-rel-full.ac
        autoheader
        tail=".tar"
    fi

    tarfile=$distrodir$what$tail

    cd ..

    echo "Generate $distrobase distribution tar-file $tarfile"

    $distrobase/scripts/shared $tarfile $distrobase $par 
    
    if [ $what = "cvode" -o $what = "sundials" ];  then
        $distrobase/scripts/cvode $tarfile $distrobase $par 
    fi
    
    if [ $what = "cvodes" -o $what = "sundials" ]; then
        $distrobase/scripts/cvodes $tarfile $distrobase $par 
    fi

    if [ $what = "ida" -o $what = "sundials" ];    then
        $distrobase/scripts/ida $tarfile $distrobase $par 
    fi

    if [ $what = "kinsol" -o $what = "sundials" ]; then
        $distrobase/scripts/kinsol $tarfile $distrobase $par 
    fi

    gzip $tarfile
    
    cd $scriptdir
}

#==============================================================================
#
# This function decides how many files need to be created for the current
# module
#
#==============================================================================

function create_module
{
    module=$1

    if [ $both = "F" ]
    then
        create_file $module $par
    else
        create_file $module "F"
        create_file $module "T"
    fi
}

#==============================================================================
#
# MAIN SCRIPT
#
#==============================================================================

#---------------------------------------------------------
# Test if the script is executed from within its directory
#---------------------------------------------------------
scriptbase=`basename $0`
if [ ! -f "$scriptbase" ] ; then
    print_usage
fi

#-------------
# Define flags
#-------------
err=F   # Error flag
hlp=F   # Help flag
par=F   # Parallel flag
full=F
serial=F
both=T  # generate both tarballs

#----------------
# Process options
#----------------
while getopts ":fhs" name ; do
    case $name in
        f) both=F;full=T;par=T;;
        s) both=F;serial=T;par=F;;
        h) hlp=T;;
        ?) err=T;;
    esac
done

if [ $full = "T" -a $serial = "T" ]; then
 both=T
fi

#------------------------------
# Extract argument (module name)
#------------------------------
shift $(($OPTIND - 1))
module=$1

#------------
# Test module 
#------------
if [ -z $module ]; then
    module="all"
else
    if [ $module != "all" -a $module != "sundials" -a $module != "cvode" -a $module != "cvodes" -a $module != "ida" -a $module != "kinsol" ]; then
        err=T
    fi
fi

#------------------
# Define some names
#------------------
scriptdir=`pwd`
distrodir=`echo $PWD | sed -e 's/scripts//'`
distrobase=`basename $distrodir`

#------------
# Print usage
#------------
if [ $err = "T" -o $hlp = "T" ]; then
    print_usage
fi

#---------------------------
# Create requested tar files
#---------------------------
if [ $module != "all" ]; then
    create_module $module
else
    create_module "sundials"
    create_module "cvode"
    create_module "cvodes"
    create_module "ida"
    create_module "kinsol"
fi

# That's all folks...
